{% extends 'tottimeapp/base.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Weekly Menu{% endblock %}

{% block styles %}
<style>
/* Remove bold font weight from specific rows by targeting their IDs */
#grainRow th,
#meatRow th {
    font-weight: normal;
}
#weeklyMenuHeader {
    background-color: #272630;
    color: #ffffff;
    text-align: center;
}
      
.table input[type="text"] {
    border: 1px solid #ced4da; /* Add border */
    border-radius: .25rem; /* Add border-radius */
    padding: .375rem .75rem; /* Add padding */
    width: 100%; /* Ensure the input field takes up the entire width of the cell */
}

/* Style for editable cells */
.input-box {
    height: auto; /* Adjust height */
}

/* Style for the table */
.table {
    border-collapse: collapse; /* Collapse the borders of the table */
    width: 100%; /* Make the table take up the entire width */
    table-layout: auto;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 10px; /* Add this for rounded corners */
    overflow: hidden;
}


.button-container {
    margin-right: 10px; /* Adjust the margin as needed */
}


/* Custom button styles */
.btn-primary {
    background-color: rgb(228, 218, 79); /* Change primary button color */
    border-color: rgb(228, 218, 79);
    color:rgb(33, 31, 39);
    font-weight: 555;
    
}

.btn-success {
    background-color: rgb(57, 189, 180); /* Change success button color */
    border-color: rgb(57, 189, 180);
    color:rgb(33, 31, 39);
    font-weight: 555;
}

/* Additional hover styles (optional) */
.btn-primary:hover {
    background-color: #b4ad46;
    border-color: #b4ad46;
}

.btn-success:hover {
    background-color: #007b8a;
    border-color: #007b8a;
}


th, td {
    border: 1px solid #dee2e6; /* Add border */
    padding: .75rem; /* Add padding */
    word-wrap: break-word;
    
}

/* Style for table header and body */
.table thead th,
.table tbody td {
    text-align: left; /* Align text to the left */
    font-weight: normal;
    
}
.table thead th,
.table tbody tr:nth-child(-n+3) {
    font-weight: bold;
    
    
}

/* Style for the table title */
.table-title {
    border: 1px solid #dee2e6; /* Add border */
    padding: .75rem; /* Add padding */
    text-align: center; /* Align text to the center */
}

.vertical-header {
    writing-mode: vertical-rl; /* Set text to vertical writing mode */
    transform: rotate(180deg); /* Rotate the text 180 degrees */
    white-space: nowrap; /* Prevent text from wrapping */
   
}


    @media print {
    h1,
    .sb-topnav,
    .sb-sidenav-footer,
    .button-container,
    #generateMenuBtn,
    #saveMenuBtn {
        display: none;
    }
    .vertical-header {
        writing-mode: horizontal-tb; /* Set text to horizontal writing mode when printing */
        transform: none; /* Remove rotation for horizontal text */
    }
    .table thead th,
    .table tbody td {
            word-wrap: break-word !important;
            white-space: normal !important;
            border: 1px solid #dee2e6; /* Add border */
            padding: .5rem; /* Adjust padding for printing */
            font-size: 0.8rem; /* Adjust font size for printing */
        }
    .table {
        table-layout: fixed;
        width: 200%;
    }
    .table tbody td:first-child {
        width: 20px; /* Replace 100px with the width of your first column */
    }
    @page {
        margin-top: -90px;
    }
    body {
        margin: 0;
        width: fit-content;
    }
}
.btn-rec {
background-color: rgb(153, 158, 158); /* Change success button color */
border-color: rgb(153, 158, 158);
color: rgb(33, 31, 39);
font-size: 17px;
font-weight: 550;
padding: 4px 6px !important; /* Add padding for more space */

}

/* Additional hover styles (optional) */
.btn-rec:hover {
color: rgb(255, 255, 255);
background-color: rgb(54, 56, 56);
border-color: rgb(54, 56, 56);
}
.btn-primaryoff {
            background-color: rgb(57, 189, 180); /* Change success button color */
            border-color: rgb(57, 189, 180);
            color: rgb(33, 31, 39);
            font-weight: bold;
            margin-left: 20px;
            margin-right:15px!important;
        }
    
.btn-primaryoff:hover {
            background-color: #007b8a;
            border-color: #007b8a;
            color: #fff;
        }
        .btn-secondary {
    background-color: rgb(228, 218, 79); /* Change primary button color */
    border-color: rgb(228, 218, 79);
    color:rgb(33, 31, 39);
    font-weight: 555;
    
}

.btn-secondary:hover {
    background-color: #b4ad46;
    border-color: #b4ad46;
}
.btn-outline-primary.link-switch {
    background-color: transparent !important;
    color: rgb(57, 189, 180) !important;
    border-color: rgb(57, 189, 180) !important;
}
.btn-outline-primary.link-switch:hover {
    background-color: rgb(57, 189, 180) !important;
    color: #fff !important;
    border-color: rgb(57, 189, 180) !important;
}
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4">Weekly Menu</h1>
        <div class="container mt-5" id="printableTable">
            <form onsubmit="event.preventDefault(); checkMenuExistsAndSave();" id="menuForm"> <!-- Start of the form -->
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <button id="generateMenuBtn" class="btn btn-primaryoff mr-2" type="button">Generate Menu</button>
                            <button id="saveMenuBtn" type="submit" class="btn btn-secondary">Save Menu</button> <!-- Button type set to submit -->
                            <a href="{% url 'past_menus' %}" class="btn btn-rec" style="margin-left: 15px;">
                                Saved Menus
                            </a> 
                            <button type="button" class="btn btn-outline-primary link-switch" style="margin-left: 10px;" onclick="openInventoryWindow()">
                                Inventory
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col">
                        <table id="weeklyMenuTable" class="table">
                            <thead>
                        <tr>
                            <th id="weeklyMenuHeader" scope="col" colspan="7" style="text-align: center;">Weekly Menu: Date - Date</th>
                        </tr>
                    <tr>
                        <th scope="col" colspan="2">Facility: {{ facility_name }}</th>
                        <th scope="col" style="text-align: center;">Monday</th>
                        <th scope="col" style="text-align: center;">Tuesday</th>
                        <th scope="col" style="text-align: center;">Wednesday</th>
                        <th scope="col" style="text-align: center;">Thursday</th>
                        <th scope="col" style="text-align: center;">Friday</th>
                    </tr>
                    <tr>
                        <th scope="col" colspan="2">Sponsor: {{ sponsor_name }}</th>
                        <th scope="col" style="text-align: center;"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;"><span class="weekday-date"></span></th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">Breakfast</td>
                            <td>Fluid Milk</td>
                            <td id="mondayMilk"style="text-align: center;"></td>
                            <td id="tuesdayMilk"style="text-align: center;"></td>
                            <td id="wednesdayMilk"style="text-align: center;"></td>
                            <td id="thursdayMilk"style="text-align: center;"></td>
                            <td id="fridayMilk"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit"style="text-align: center;"></td>
                            <td id="tuesdayfruit"style="text-align: center;"></td>
                            <td id="wednesdayfruit"style="text-align: center;"></td>
                            <td id="thursdayfruit"style="text-align: center;"></td>
                            <td id="fridayfruit"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread"style="text-align: center;"></td>
                            <td id="tuesdaybread"style="text-align: center;"></td>
                            <td id="wednesdaybread"style="text-align: center;"></td>
                            <td id="thursdaybread"style="text-align: center;"></td>
                            <td id="fridaybread"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd1"style="text-align: center;"></td>
                            <td id="tuesdayadd1"style="text-align: center;"></td>
                            <td id="wednesdayadd1"style="text-align: center;"></td>
                            <td id="thursdayadd1"style="text-align: center;"></td>
                            <td id="fridayadd1"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">AM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose1"style="text-align: center;"></td>
                            <td id="tuesdaychoose1"style="text-align: center;"></td>
                            <td id="wednesdaychoose1"style="text-align: center;"></td>
                            <td id="thursdaychoose1"style="text-align: center;"></td>
                            <td id="fridaychoose1"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit2"style="text-align: center;"></td>
                            <td id="tuesdayfruit2"style="text-align: center;"></td>
                            <td id="wednesdayfruit2"style="text-align: center;"></td>
                            <td id="thursdayfruit2"style="text-align: center;"></td>
                            <td id="fridayfruit2"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread2"style="text-align: center;"></td>
                            <td id="tuesdaybread2"style="text-align: center;"></td>
                            <td id="wednesdaybread2"style="text-align: center;"></td>
                            <td id="thursdaybread2"style="text-align: center;"></td>
                            <td id="fridaybread2"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat1"style="text-align: center;"></td>
                            <td id="tuesdaymeat1"style="text-align: center;"></td>
                            <td id="wednesdaymeat1"style="text-align: center;"></td>
                            <td id="thursdaymeat1"style="text-align: center;"></td>
                            <td id="fridaymeat1"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="7" style="font-weight: bold; text-align: center;">Lunch</td>
                            <td>Main Dish</td>
                            <td id="mondayMeals"style="text-align: center;"></td>
                            <td id="tuesdayMeals"style="text-align: center;"></td>
                            <td id="wednesdayMeals"style="text-align: center;"></td>
                            <td id="thursdayMeals"style="text-align: center;"></td>
                            <td id="fridayMeals"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Fluid Milk</td>
                            <td id="mondayLunchMilk"style="text-align: center;"></td>
                            <td id="tuesdayLunchMilk"style="text-align: center;"></td>
                            <td id="wednesdayLunchMilk"style="text-align: center;"></td>
                            <td id="thursdayLunchMilk"style="text-align: center;"></td>
                            <td id="fridayLunchMilk"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Vegetable</td>
                            <td id="mondayvege"style="text-align: center;"></td>
                            <td id="tuesdayvege"style="text-align: center;"></td>
                            <td id="wednesdayvege"style="text-align: center;"></td>
                            <td id="thursdayvege"style="text-align: center;"></td>
                            <td id="fridayvege"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Fruit</td>
                            <td id="mondayfruit3"style="text-align: center;"></td>
                            <td id="tuesdayfruit3"style="text-align: center;"></td>
                            <td id="wednesdayfruit3"style="text-align: center;"></td>
                            <td id="thursdayfruit3"style="text-align: center;"></td>
                            <td id="fridayfruit3"style="text-align: center;"></td>
                        </tr>
                        <tr id="grainRow">
                            <th scope="col">Grain</th>
                            <th id="mondayGrain"style="text-align: center;"></th>
                            <th id="tuesdayGrain"style="text-align: center;"></th>
                            <th id="wednesdayGrain"style="text-align: center;"></th>
                            <th id="thursdayGrain"style="text-align: center;"></th>
                            <th id="fridayGrain"style="text-align: center;"></th>
                        </tr>
                        <tr id="meatRow">
                            <th scope="col">Meat or Meat Alternate</th>
                            <th id="mondayMeatAlternate"style="text-align: center;"></th>
                            <th id="tuesdayMeatAlternate"style="text-align: center;"></th>
                            <th id="wednesdayMeatAlternate"style="text-align: center;"></th>
                            <th id="thursdayMeatAlternate"style="text-align: center;"></th>
                            <th id="fridayMeatAlternate"style="text-align: center;"></th>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd2"style="text-align: center;"></td>
                            <td id="tuesdayadd2"style="text-align: center;"></td>
                            <td id="wednesdayadd2"style="text-align: center;"></td>
                            <td id="thursdayadd2"style="text-align: center;"></td>
                            <td id="fridayadd2"style="text-align: center;"></td>
                        </tr>
                        <tr> 
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">PM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose2"style="text-align: center;"></td>
                            <td id="tuesdaychoose2"style="text-align: center;"></td>
                            <td id="wednesdaychoose2"style="text-align: center;"></td>
                            <td id="thursdaychoose2"style="text-align: center;"></td>
                            <td id="fridaychoose2"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit4"style="text-align: center;"></td>
                            <td id="tuesdayfruit4"style="text-align: center;"></td>
                            <td id="wednesdayfruit4"style="text-align: center;"></td>
                            <td id="thursdayfruit4"style="text-align: center;"></td>
                            <td id="fridayfruit4"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread3"style="text-align: center;"></td>
                            <td id="tuesdaybread3"style="text-align: center;"></td>
                            <td id="wednesdaybread3"style="text-align: center;"></td>
                            <td id="thursdaybread3"style="text-align: center;"></td>
                            <td id="fridaybread3"style="text-align: center;"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat3"style="text-align: center;"></td>
                            <td id="tuesdaymeat3"style="text-align: center;"></td>
                            <td id="wednesdaymeat3"style="text-align: center;"></td>
                            <td id="thursdaymeat3"style="text-align: center;"></td>
                            <td id="fridaymeat3"style="text-align: center;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endblock %}
    {% block scripts %}
<script>
/* Persist-in-progress weekly menu, robust generate handlers, and full mapping to all table cells */

/* Local storage key */
const MENU_PROGRESS_KEY = "weeklyMenuProgress_v1";

/* Save/restore helpers */
function saveMenuProgressToLocalStorage() {
    try {
        const menu = {};
        const ids = [
            'mondayMilk','tuesdayMilk','wednesdayMilk','thursdayMilk','fridayMilk',
            'mondayfruit','tuesdayfruit','wednesdayfruit','thursdayfruit','fridayfruit',
            'mondaybread','tuesdaybread','wednesdaybread','thursdaybread','fridaybread',
            'mondayadd1','tuesdayadd1','wednesdayadd1','thursdayadd1','fridayadd1',
            'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
            'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
            'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
            'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1',
            'mondayMeals','tuesdayMeals','wednesdayMeals','thursdayMeals','fridayMeals',
            'mondayLunchMilk','tuesdayLunchMilk','wednesdayLunchMilk','thursdayLunchMilk','fridayLunchMilk',
            'mondayvege','tuesdayvege','wednesdayvege','thursdayvege','fridayvege',
            'mondayfruit3','tuesdayfruit3','wednesdayfruit3','thursdayfruit3','fridayfruit3',
            'mondayGrain','tuesdayGrain','wednesdayGrain','thursdayGrain','fridayGrain',
            'mondayMeatAlternate','tuesdayMeatAlternate','wednesdayMeatAlternate','thursdayMeatAlternate','fridayMeatAlternate',
            'mondayadd2','tuesdayadd2','wednesdayadd2','thursdayadd2','fridayadd2',
            'mondaychoose2','tuesdaychoose2','wednesdaychoose2','thursdaychoose2','fridaychoose2',
            'mondayfruit4','tuesdayfruit4','wednesdayfruit4','thursdayfruit4','fridayfruit4',
            'mondaybread3','tuesdaybread3','wednesdaybread3','thursdaybread3','fridaybread3',
            'mondaymeat3','tuesdaymeat3','wednesdaymeat3','thursdaymeat3','fridaymeat3'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) menu[id] = el.innerText;
        });
        const header = document.getElementById('weeklyMenuHeader');
        if (header) menu.weeklyMenuHeader = header.innerText;
        const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText);
        menu.weekdayDates = dates;
        localStorage.setItem(MENU_PROGRESS_KEY, JSON.stringify(menu));
    } catch (err) {
        console.warn('saveMenuProgress failed', err);
    }
}

function restoreMenuProgressFromLocalStorage() {
    try {
        const raw = localStorage.getItem(MENU_PROGRESS_KEY);
        if (!raw) return;
        const menu = JSON.parse(raw);
        if (!menu) return;
        Object.entries(menu).forEach(([k, v]) => {
            if (k === 'weeklyMenuHeader') {
                const h = document.getElementById('weeklyMenuHeader');
                if (h) h.innerText = v;
            } else if (k === 'weekdayDates' && Array.isArray(v)) {
                document.querySelectorAll('.weekday-date').forEach((el, i) => { if (v[i]) el.innerText = v[i]; });
            } else {
                const el = document.getElementById(k);
                if (el) el.innerText = v;
            }
        });
    } catch (err) {
        console.warn('restoreMenuProgress failed', err);
    }
}

function clearMenuProgressFromLocalStorage() {
    localStorage.removeItem(MENU_PROGRESS_KEY);
}

/* Generic safe setter */
function safeSetText(id, text) {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerText = text == null ? '' : String(text);
}

/* Minimal mapping for common server keys */
const KEY_ID_MAP = {
    'meal_name': '{day}Meals', 'main_dish': '{day}Meals', 'lunch_main_dish': '{day}Meals',
    'grain': '{day}Grain',
    'meat_alternate': '{day}MeatAlternate', 'meat': '{day}MeatAlternate',
    'lunch_milk': '{day}LunchMilk', 'fluid_milk': '{day}Milk',
    'bread': '{day}bread', 'add1': '{day}add1',
    'choose1': '{day}choose1', 'fruit2': '{day}fruit2', 'bread2':'{day}bread2', 'meat1':'{day}meat1',
    'choose2': '{day}choose2', 'fruit4': '{day}fruit4', 'bread3':'{day}bread3', 'meat3':'{day}meat3',
    'fruit': '{day}fruit', 'fruit3':'{day}fruit3',
    'vegetable': '{day}vege', 'add2':'{day}add2'
};

function dayPrefix(day) { return day.toLowerCase(); }

function applyResponseToDay(day, payload) {
    if (!payload || typeof payload !== 'object') return;
    const prefix = dayPrefix(day);
    Object.entries(payload).forEach(([k, v]) => {
        if (v == null) v = '';
        let template = KEY_ID_MAP[k] || KEY_ID_MAP[k.toLowerCase()];
        if (template) {
            const id = template.replace('{day}', prefix);
            safeSetText(id, v);
            return;
        }
        if (typeof v === 'object') {
            Object.entries(v).forEach(([subk, subv]) => {
                let t = KEY_ID_MAP[subk] || KEY_ID_MAP[subk.toLowerCase()];
                if (t) safeSetText(t.replace('{day}', prefix), subv);
            });
            return;
        }
        const fallbackId = prefix + k.charAt(0).toUpperCase() + k.slice(1);
        if (document.getElementById(fallbackId)) safeSetText(fallbackId, v);
        else {
            const fallback2 = prefix + k.toLowerCase();
            if (document.getElementById(fallback2)) safeSetText(fallback2, v);
            else console.debug('No mapping for', k, '-> tried', fallbackId, fallback2);
        }
    });
}

function populateFromResponse(response) {
    if (!response) return;
    ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(day => {
        if (response[day]) applyResponseToDay(day, response[day]);
    });
}

/* The table updaters used by AJAX success handlers.
   Ensure milk cells and dates get populated even if server doesn't return milk keys. */
function updateTable(response){
    populateFromResponse(response);
    // ensure breakfast and lunch milk defaults set
    ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
        safeSetText(day + 'LunchMilk', '1% w.milk (unflavored)');
    });
    // make editable for changed cells
    enableEditablesForAllCells();
}
function updateAMTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }
function updatePMTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }
function updateBreakfastTable(response){
    populateFromResponse(response);
    // breakfast always shows fluid milk as in backup
    ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
    });
    enableEditablesForAllCells();
}
function updateFruitTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }
function updateVegetableTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }

/* CSRF helper */
function getCookie(name) {
    try {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    } catch (e) { console.warn('getCookie error', e); }
    return '';
}

/* Editable support */
function makeEditable(el) {
    if (!el || el.dataset.editable === 'true') return;
    el.dataset.editable = 'true';
    el.addEventListener('click', function () {
        const current = el.innerText.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-box form-control';
        input.value = current;
        el.innerText = '';
        el.appendChild(input);
        input.focus();
        input.addEventListener('blur', function () {
            el.innerText = input.value.trim();
            saveMenuProgressToLocalStorage();
        });
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') { input.blur(); }
        });
    });
}

function enableEditablesForAllCells() {
    const els = Array.from(document.querySelectorAll('#weeklyMenuTable td, #weeklyMenuTable th'));
    els.forEach(el => {
        if (el.id && el.id !== 'weeklyMenuHeader') makeEditable(el);
    });
}

/* Date helper copied from backup behavior */
function updateDates() {
    var today = new Date();
    var currentDayIndex = today.getDay();
    var daysUntilNext Monday = (currentDayIndex === 0) ? 1 : (8 - currentDayIndex);
    var nextMonday = new Date(today);
    nextMonday.setDate(today.getDate() + daysUntilNext Monday);
    var nextFriday = new Date(nextMonday);
    nextFriday.setDate(nextMonday.getDate() + 4);
    var startDateString = ('0' + (nextMonday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextMonday.getDate()).slice(-2);
    var endDateString = ('0' + (nextFriday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextFriday.getDate()).slice(-2);
    $('#weeklyMenuHeader').text('Weekly Menu: ' + startDateString + ' - ' + endDateString);
    $('.weekday-date').each(function(index) {
        var date = new Date(nextMonday);
        date.setDate(nextMonday.getDate() + index);
        var formattedDate = ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
        $(this).text(formattedDate);
    });
    window.nextMondayDate = nextMonday;
}

/* Document ready: restore, attach handlers */
$(document).ready(function() {
    restoreMenuProgressFromLocalStorage();
    enableEditablesForAllCells();

    $('#generateMenuBtn').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ e.preventDefault(); return false; }});
    $('#menuForm').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ if (!$(e.target).is('#saveMenuBtn') && !$(e.target).hasClass('input-box')){ e.preventDefault(); return false; } }});
    $(document).on('blur', '.input-box', function(){ setTimeout(saveMenuProgressToLocalStorage, 80); });

    function ajaxPost(url) {
        return $.ajax({ url: url, type: 'POST', data: {}, beforeSend: function(xhr) { xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken')); } });
    }

    $('#generateMenuBtn').off('click.simple').on('click.simple', function(e) {
        e.preventDefault();
        const $btn = $(this);
        $btn.prop('disabled', true).addClass('disabled');

        const calls = [
            ajaxPost('/generate_menu/').done(resp => updateTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_am_menu/').done(resp => updateAMTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_fruit_menu/').done(resp => updateFruitTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_vegetable_menu/').done(resp => updateVegetableTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_pm_menu/').done(resp => updatePMTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_breakfast_menu/').done(resp => { updateBreakfastTable(resp); }).always(saveMenuProgressToLocalStorage)
        ];

        $.when.apply($, calls).always(function() {
            // ensure dates and milk defaults show like backup
            updateDates();
            ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
                safeSetText(day + 'Milk', document.getElementById(day + 'Milk')?.innerText || '1% w.milk (unflavored)');
                safeSetText(day + 'LunchMilk', document.getElementById(day + 'LunchMilk')?.innerText || '1% w.milk (unflavored)');
            });
            saveMenuProgressToLocalStorage();
            enableEditablesForAllCells();
            setTimeout(function(){ $btn.prop('disabled', false).removeClass('disabled'); }, 250);
        });
    });

    $(document).on('click', '#generateMenuBtn', function (e) { console.log('delegated generate handler (fallback)'); });

    $('#saveMenuBtn').off('click').on('click', function (e) {
        e.preventDefault();
        if (typeof checkMenuExistsAndSave === 'function') checkMenuExistsAndSave();
        else console.warn('checkMenuExistsAndSave not defined');
    });
});

window.updateTable = updateTable;
window.updateAMTable = updateAMTable;
window.updatePMTable = updatePMTable;
window.updateBreakfastTable = updateBreakfastTable;
window.updateFruitTable = updateFruitTable;
window.updateVegetableTable = updateVegetableTable;
window.saveMenuProgressToLocalStorage = saveMenuProgressToLocalStorage;
window.restoreMenuProgressFromLocalStorage = restoreMenuProgressFromLocalStorage;
</script>
<script>
function openInventoryWindow() {
    window.open(
        "{% url 'inventory_list' %}?popup=1",
        "InventoryWindow",
        "width=1100,height=700,scrollbars=yes,resizable=yes"
    );
}
</script>
{% endblock %}
{% extends 'tottimeapp/base_dynamic.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Weekly Menu{% endblock %}

{% block styles %}
<style>
/* =========================
   Weekly Menu Styles (clean + organized)
   - Mobile: <=1000px (single day view with dropdown)
   - Desktop: >=1001px (full week view)
   ========================= */

/* --- Base / shared styles --- */
#weeklyMenuHeader {
  background-color: #272630;
  color: #fff;
  text-align: center;
}

.table {
  border-collapse: collapse;
  width: 100%;
  table-layout: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-radius: 10px;
  overflow: hidden;
}

.table-title { border: 1px solid #dee2e6; padding: .75rem; text-align: center; }

th, td {
  border: 1px solid #dee2e6;
  padding: .75rem;
  word-wrap: break-word;
}

.table thead th, .table tbody td { text-align: left; font-weight: normal; }
.table thead th, .table tbody tr:nth-child(-n+3) { font-weight: bold; }

.vertical-header {
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  white-space: nowrap;
}

/* Inputs in table */
.table input[type="text"] {
  border: 1px solid #ced4da;
  border-radius: .25rem;
  padding: .375rem .75rem;
  width: 100%;
}

/* Button color tokens (shared) */
.btn-primaryoff { background: rgb(57,189,180); border-color: rgb(57,189,180); color: #21201f; font-weight: 700; }
.btn-primaryoff:hover { background: #007b8a; border-color: #007b8a; color: #fff; }

.btn-secondary { background: rgb(228,218,79); border-color: rgb(228,218,79); color: #21201f; }
.btn-secondary:hover { background: #b4ad46; border-color: #b4ad46; }

.btn-rec { background: rgb(153,158,158); border-color: rgb(153,158,158); color: #21201f; padding: 4px 6px !important; font-weight: 550; }
.btn-rec:hover { background: rgb(54,56,56); color: #fff; border-color: rgb(54,56,56); }

.btn-outline-primary.link-switch {
  background: transparent !important;
  color: rgb(57,189,180) !important;
  border-color: rgb(57,189,180) !important;
}
.btn-outline-primary.link-switch:hover { background: rgb(57,189,180) !important; color: #fff !important; }

/* keep specific rows non-bold */
#grainRow th, #meatRow th { font-weight: normal; }

/* accessibility helper */
.sr-only {
  position: absolute !important;
  width: 1px; height: 1px;
  padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,0,0);
  white-space: nowrap; border: 0;
}

/* Mobile day selector dropdown */
#mobileDaySelector {
  display: none;
  margin: 0;
  padding: 0;
  width: 100%;
}

#mobileDaySelector .mobile-day-dropdown {
  width: 100%;
  padding: 10px 14px;
  font-size: 1.05rem;
  line-height: 1.25 !important;
  border-radius: 6px;
  background-color: rgba(34, 37, 41, 1) !important;
  color: #fff !important;
  border: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-weight: 600;
  text-align: center;
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23ffffff' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 12px;
  padding-right: 35px;
}

#mobileDaySelector .mobile-day-dropdown:focus,
#mobileDaySelector .mobile-day-dropdown:hover {
  outline: none;
  background-color: rgba(34, 37, 41, 1) !important;
}

#mobileDaySelector .mobile-day-dropdown option {
  background-color: #272630;
  color: #fff;
  padding: 10px;
}

/* --- Print rules --- */
@media print {
  h1, .sb-topnav, .sb-sidenav-footer, .button-container, #generateMenuBtn, #saveMenuBtn, #mobileDaySelector { display: none; }
  .vertical-header { writing-mode: horizontal-tb; transform: none; }
  .table thead th, .table tbody td { word-wrap: break-word !important; white-space: normal !important; padding: .5rem; font-size: .8rem; }
  .table { table-layout: fixed; width: 200%; }
  .table tbody td:first-child { width: 20px; }
  @page { margin-top: -90px; }
  body { margin: 0; width: fit-content; }
  
  /* Show all columns when printing */
  .table thead tr th:not(:first-child):not(:nth-child(2)),
  .table tbody tr td:not(:first-child):not(:nth-child(2)) {
    display: table-cell !important;
  }
}

/* =========================
   MOBILE (<=1000px)
   - hide H1 and top buttons
   - show day selector dropdown
   - show only selected day column
   ========================= */
@media (max-width: 1000px) {
  /* hide header + top button area */
  h1.mt-4,
  .top-button-row,
  #printableTable > form .mb-3 {
    display: none !important;
  }

  /* Prevent horizontal scrolling and hide scrollbars */
  html, body {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }

  /* Hide vertical scrollbar but allow scrolling */
  body {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
  }

  body::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }

  /* Hide entire table header (thead) on mobile */
  .table thead {
    display: none !important;
  }

  /* Remove container margins on mobile */
  .container {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    max-width: 100% !important;
  }
#printableTable {
    margin: 0 !important;
    margin-left: -25px !important;
    padding: 0 !important;
    width: 100% !important;
  }
table tbody {
    background-color: #e8e8e8bd !important;
}
  /* Show mobile day selector - full width, no margins */
#mobileDaySelector {
  display: block !important;
  position: sticky;
  top: 56px; /* Adjust based on your mobile nav height */
  z-index: 1100;
  margin: 0 !important;
  margin-left: 25px !important; /* Offset parent's negative margin */
  padding: 0 !important;
  width: 100vw !important;
  left: 0;
  right: 0;
}
/* Remove row margins */
.row {
  margin-left: 0 !important;
  margin-right: 0 !important;
}

/* Remove top margin from table row on mobile */
.row.mt-3 {
  margin-top: 0 !important;
}
  #mobileDaySelector .mobile-day-dropdown {
    border-radius: 0 !important; /* Remove rounded corners for full-width look */
    margin: 0 !important;
    width: 100% !important;
  }

  /* Remove row margins */
  .row {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  /* Remove col padding */
  .col {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  /* compact table for mobile */
  .table { 
    box-shadow: none; 
    border-radius: 6px;
    margin-top: 0 !important;
  }
  
  th, td { padding: .5rem; font-size: .95rem; }

  .vertical-header { font-size: .9rem; }

  /* Hide ALL day columns by default in mobile - use !important to override */
  .table thead tr th[data-day],
  .table tbody tr td[data-day],
  .table tbody tr th[data-day] {
    display: none !important;
  }

  /* Show ONLY selected day - must override the above rule */
  .table thead tr th.mobile-show-day,
  .table tbody tr td.mobile-show-day,
  .table tbody tr th.mobile-show-day {
    display: table-cell !important;
  }

  /* Adjust header colspan for mobile */
  #weeklyMenuHeader {
    display: table-cell !important;
  }

  /* make space for fixed mobile nav from base_minimal (center circular button may overflow) */
  body { padding-bottom: 100px !important; }

  /* ensure mobile bottom nav isn't accidentally hidden by local rules */
  #mobileBottomNav { z-index: 1200; }

  /* minor button tweaks for mobile nav (base_minimal supplies main look) */
  #mobileBottomNav .btn { background: transparent; border: none; padding: 6px 8px; color: #fff; }
}

/* =========================
   DESKTOP (>=1001px)
   - show H1 and top buttons
   - show all columns
   - hide day selector
   ========================= */
@media (min-width: 1001px) {
  h1.mt-4,
  .top-button-row,
  #printableTable > form .mb-3 {
    display: block !important;
  }

  #mobileDaySelector {
    display: none !important;
  }

  body { padding-bottom: 0; }
  .table thead th, .table tbody td { font-size: 1rem; }
  
  /* Ensure all columns are visible on desktop */
  .table thead tr th,
  .table tbody tr td,
  .table tbody tr th {
    display: table-cell !important;
  }
}
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4">Weekly Menu</h1>
        <div class="container mt-5" id="printableTable">
            <form onsubmit="event.preventDefault(); checkMenuExistsAndSave();" id="menuForm"> <!-- Start of the form -->
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <button id="generateMenuBtn" class="btn btn-primaryoff mr-2" type="button">Generate Menu</button>
                            <button id="saveMenuBtn" type="submit" class="btn btn-secondary">Save</button> <!-- Button type set to submit -->
                            <a href="{% url 'past_menus' %}" class="btn btn-rec" style="margin-left: 15px;">
                                Saved Menus
                            </a>    
                            <button type="button" class="btn btn-outline-primary link-switch" style="margin-left: 10px;" onclick="openInventoryWindow()">
                            Inventory
                        </button>
                        </div>
                        
                    </div>
                </div>

                <!-- Mobile Day Selector -->
                    <div id="mobileDaySelector">
                        <select id="daySelect" aria-label="Select day of week" class="mobile-day-dropdown">
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                        </select>
                    </div>

                <div class="row mt-3">
                    <div class="col">
                        <table id="weeklyMenuTable" class="table">
                            <thead>
                        <tr>
                            <th id="weeklyMenuHeader" scope="col" colspan="7" style="text-align: center;">Weekly Menu: Date - Date</th>
                        </tr>
                    <tr>
                        <th scope="col" colspan="2">Facility: {{ facility_name }}</th>
                        <th scope="col" style="text-align: center;" data-day="monday">Monday</th>
                        <th scope="col" style="text-align: center;" data-day="tuesday">Tuesday</th>
                        <th scope="col" style="text-align: center;" data-day="wednesday">Wednesday</th>
                        <th scope="col" style="text-align: center;" data-day="thursday">Thursday</th>
                        <th scope="col" style="text-align: center;" data-day="friday">Friday</th>
                    </tr>
                    <tr>
                        <th scope="col" colspan="2">Sponsor: {{ sponsor_name }}</th>
                        <th scope="col" style="text-align: center;" data-day="monday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="tuesday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="wednesday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="thursday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="friday"><span class="weekday-date"></span></th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">Breakfast</td>
                            <td>Fluid Milk</td>
                            <td id="mondayMilk" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayMilk" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayMilk" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayMilk" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayMilk" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayadd1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayadd1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayadd1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayadd1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">AM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaychoose1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaychoose1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaychoose1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaychoose1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaymeat1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaymeat1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaymeat1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaymeat1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="7" style="font-weight: bold; text-align: center;">Lunch</td>
                            <td>Main Dish</td>
                            <td id="mondayMeals" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayMeals" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayMeals" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayMeals" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayMeals" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fluid Milk</td>
                            <td id="mondayLunchMilk" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayLunchMilk" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayLunchMilk" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayLunchMilk" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayLunchMilk" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Vegetable</td>
                            <td id="mondayvege" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayvege" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayvege" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayvege" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayvege" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit</td>
                            <td id="mondayfruit3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr id="grainRow">
                            <th scope="col">Grain</th>
                            <th id="mondayGrain" style="text-align: center;" data-day="monday"></th>
                            <th id="tuesdayGrain" style="text-align: center;" data-day="tuesday"></th>
                            <th id="wednesdayGrain" style="text-align: center;" data-day="wednesday"></th>
                            <th id="thursdayGrain" style="text-align: center;" data-day="thursday"></th>
                            <th id="fridayGrain" style="text-align: center;" data-day="friday"></th>
                        </tr>
                        <tr id="meatRow">
                            <th scope="col">Meat or Meat Alternate</th>
                            <th id="mondayMeatAlternate" style="text-align: center;" data-day="monday"></th>
                            <th id="tuesdayMeatAlternate" style="text-align: center;" data-day="tuesday"></th>
                            <th id="wednesdayMeatAlternate" style="text-align: center;" data-day="wednesday"></th>
                            <th id="thursdayMeatAlternate" style="text-align: center;" data-day="thursday"></th>
                            <th id="fridayMeatAlternate" style="text-align: center;" data-day="friday"></th>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayadd2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayadd2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayadd2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayadd2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr> 
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">PM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaychoose2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaychoose2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaychoose2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaychoose2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit4" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit4" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit4" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit4" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit4" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaymeat3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaymeat3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaymeat3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaymeat3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                    </tbody>
                </table>
                <!-- MOBILE: fixed bottom navigation (visible only on small screens via CSS) -->
                <div id="mobileBottomNav" role="navigation" aria-label="Mobile actions">
                    <button type="button" class="btn btn-primaryoff" onclick="document.getElementById('generateMenuBtn').click();" title="Generate Menu">
                        <i class="fas fa-magic" aria-hidden="true"></i>
                        <span class="sr-only">Generate Menu</span>
                    </button>

                    <!-- Center circular update/save button (uses base_minimal .update-btn styles) -->
                    <button type="button" class="btn update-btn" onclick="document.getElementById('saveMenuBtn').click();" title="Save Menu">
                        <i class="fas fa-save" aria-hidden="true"></i>
                        <span class="sr-only">Save Menu</span>
                    </button>

                    <a href="{% url 'past_menus' %}" class="btn btn-rec" title="Saved Menus" role="button">
                        <i class="fas fa-folder-open" aria-hidden="true"></i>
                        <span class="sr-only">Saved Menus</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
    {% block scripts %}
<script>
/* Persist-in-progress weekly menu, robust generate handlers, and full mapping to all table cells */

/* Local storage key */
const MENU_PROGRESS_KEY = "weeklyMenuProgress_v1";
const SELECTED_DAY_KEY = "selectedDay_v1";

/* Save/restore helpers */
function saveMenuProgressToLocalStorage() {
    try {
        const menu = {};
        const ids = [
            'mondayMilk','tuesdayMilk','wednesdayMilk','thursdayMilk','fridayMilk',
            'mondayfruit','tuesdayfruit','wednesdayfruit','thursdayfruit','fridayfruit',
            'mondaybread','tuesdaybread','wednesdaybread','thursdaybread','fridaybread',
            'mondayadd1','tuesdayadd1','wednesdayadd1','thursdayadd1','fridayadd1',
            'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
            'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
            'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
            'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1',
            'mondayMeals','tuesdayMeals','wednesdayMeals','thursdayMeals','fridayMeals',
            'mondayLunchMilk','tuesdayLunchMilk','wednesdayLunchMilk','thursdayLunchMilk','fridayLunchMilk',
            'mondayvege','tuesdayvege','wednesdayvege','thursdayvege','fridayvege',
            'mondayfruit3','tuesdayfruit3','wednesdayfruit3','thursdayfruit3','fridayfruit3',
            'mondayGrain','tuesdayGrain','wednesdayGrain','thursdayGrain','fridayGrain',
            'mondayMeatAlternate','tuesdayMeatAlternate','wednesdayMeatAlternate','thursdayMeatAlternate','fridayMeatAlternate',
            'mondayadd2','tuesdayadd2','wednesdayadd2','thursdayadd2','fridayadd2',
            'mondaychoose2','tuesdaychoose2','wednesdaychoose2','thursdaychoose2','fridaychoose2',
            'mondayfruit4','tuesdayfruit4','wednesdayfruit4','thursdayfruit4','fridayfruit4',
            'mondaybread3','tuesdaybread3','wednesdaybread3','thursdaybread3','fridaybread3',
            'mondaymeat3','tuesdaymeat3','wednesdaymeat3','thursdaymeat3','fridaymeat3'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) menu[id] = el.innerText;
        });
        const header = document.getElementById('weeklyMenuHeader');
        if (header) menu.weeklyMenuHeader = header.innerText;
        const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText);
        menu.weekdayDates = dates;
        localStorage.setItem(MENU_PROGRESS_KEY, JSON.stringify(menu));
    } catch (err) {
        console.warn('saveMenuProgress failed', err);
    }
}

function restoreMenuProgressFromLocalStorage() {
    try {
        const raw = localStorage.getItem(MENU_PROGRESS_KEY);
        if (!raw) return;
        const menu = JSON.parse(raw);
        if (!menu) return;
        Object.entries(menu).forEach(([k, v]) => {
            if (k === 'weeklyMenuHeader') {
                const h = document.getElementById('weeklyMenuHeader');
                if (h) h.innerText = v;
            } else if (k === 'weekdayDates' && Array.isArray(v)) {
                document.querySelectorAll('.weekday-date').forEach((el, i) => { if (v[i]) el.innerText = v[i]; });
            } else {
                const el = document.getElementById(k);
                if (el) el.innerText = v;
            }
        });
    } catch (err) {
        console.warn('restoreMenuProgress failed', err);
    }
}

function clearMenuProgressFromLocalStorage() {
    localStorage.removeItem(MENU_PROGRESS_KEY);
}

/* Mobile day selector functionality */
function showSelectedDay(selectedDay) {
    // Remove mobile-show-day class from all cells
    document.querySelectorAll('[data-day]').forEach(el => {
        el.classList.remove('mobile-show-day');
    });
    
    // Add mobile-show-day class to selected day's cells
    document.querySelectorAll(`[data-day="${selectedDay}"]`).forEach(el => {
        el.classList.add('mobile-show-day');
    });
    
    // Save selection to localStorage
    try {
        localStorage.setItem(SELECTED_DAY_KEY, selectedDay);
    } catch (err) {
        console.warn('Failed to save selected day', err);
    }
}

function initializeDaySelector() {
    const daySelect = document.getElementById('daySelect');
    if (!daySelect) return;
    
    // Restore previously selected day or default to monday
    let savedDay = 'monday';
    try {
        savedDay = localStorage.getItem(SELECTED_DAY_KEY) || 'monday';
    } catch (err) {
        console.warn('Failed to restore selected day', err);
    }
    
    daySelect.value = savedDay;
    showSelectedDay(savedDay);
    
    // Add change event listener
    daySelect.addEventListener('change', function() {
        showSelectedDay(this.value);
    });
}

/* Generic safe setter */
function safeSetText(id, text) {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerText = text == null ? '' : String(text);
}

/* Minimal mapping for common server keys */
const KEY_ID_MAP = {
    'meal_name': '{day}Meals', 'main_dish': '{day}Meals', 'lunch_main_dish': '{day}Meals',
    'grain': '{day}Grain',
    'meat_alternate': '{day}MeatAlternate', 'meat': '{day}MeatAlternate',
    'lunch_milk': '{day}LunchMilk', 'fluid_milk': '{day}Milk',
    'bread': '{day}bread', 'add1': '{day}add1',
    'choose1': '{day}choose1', 'fruit2': '{day}fruit2', 'bread2':'{day}bread2', 'meat1':'{day}meat1',
    'choose2': '{day}choose2', 'fruit4': '{day}fruit4', 'bread3':'{day}bread3', 'meat3':'{day}meat3',
    'fruit': '{day}fruit', 'fruit3':'{day}fruit3',
    'vegetable': '{day}vege', 'add2':'{day}add2'
};

function dayPrefix(day) { return day.toLowerCase(); }

function applyResponseToDay(day, payload) {
    if (!payload || typeof payload !== 'object') return;
    const prefix = dayPrefix(day);
    Object.entries(payload).forEach(([k, v]) => {
        if (v == null) v = '';
        let template = KEY_ID_MAP[k] || KEY_ID_MAP[k.toLowerCase()];
        if (template) {
            const id = template.replace('{day}', prefix);
            safeSetText(id, v);
            return;
        }
        if (typeof v === 'object') {
            Object.entries(v).forEach(([subk, subv]) => {
                let t = KEY_ID_MAP[subk] || KEY_ID_MAP[subk.toLowerCase()];
                if (t) safeSetText(t.replace('{day}', prefix), subv);
            });
            return;
        }
        const fallbackId = prefix + k.charAt(0).toUpperCase() + k.slice(1);
        if (document.getElementById(fallbackId)) safeSetText(fallbackId, v);
        else {
            const fallback2 = prefix + k.toLowerCase();
            if (document.getElementById(fallback2)) safeSetText(fallback2, v);
            else console.debug('No mapping for', k, '-> tried', fallbackId, fallback2);
        }
    });
}

function populateFromResponse(response) {
    if (!response) return;
    ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(day => {
        if (response[day]) applyResponseToDay(day, response[day]);
    });
}

/* The table updaters used by AJAX success handlers.
   Ensure milk cells and dates get populated even if server doesn't return milk keys. */
function updateTable(response){
    populateFromResponse(response);
    // ensure breakfast and lunch milk defaults set
    ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
        safeSetText(day + 'LunchMilk', '1% w.milk (unflavored)');
    });
    // make editable for changed cells
    enableEditablesForAllCells();
}
function updateAMTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }
function updatePMTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }
function updateBreakfastTable(response){
    populateFromResponse(response);
    // breakfast always shows fluid milk as in backup
    ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
    });
    enableEditablesForAllCells();
}
function updateFruitTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }
function updateVegetableTable(response){ populateFromResponse(response); enableEditablesForAllCells(); }

/* CSRF helper */
function getCookie(name) {
    try {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    } catch (e) { console.warn('getCookie error', e); }
    return '';
}

/* Editable support */
function makeEditable(el) {
    if (!el || el.dataset.editable === 'true') return;
    el.dataset.editable = 'true';
    el.addEventListener('click', function () {
        const current = el.innerText.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-box form-control';
        input.value = current;
        el.innerText = '';
        el.appendChild(input);
        input.focus();
        input.addEventListener('blur', function () {
            el.innerText = input.value.trim();
            saveMenuProgressToLocalStorage();
        });
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') { input.blur(); }
        });
    });
}

function enableEditablesForAllCells() {
    const els = Array.from(document.querySelectorAll('#weeklyMenuTable td, #weeklyMenuTable th'));
    els.forEach(el => {
        if (el.id && el.id !== 'weeklyMenuHeader') makeEditable(el);
    });
}

/* Date helper copied from backup behavior */
function updateDates() {
    var today = new Date();
    var currentDayIndex = today.getDay();
    var daysUntilNextMonday = (currentDayIndex === 0) ? 1 : (8 - currentDayIndex);
    var nextMonday = new Date(today);
    nextMonday.setDate(today.getDate() + daysUntilNextMonday);
    var nextFriday = new Date(nextMonday);
    nextFriday.setDate(nextMonday.getDate() + 4);
    var startDateString = ('0' + (nextMonday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextMonday.getDate()).slice(-2);
    var endDateString = ('0' + (nextFriday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextFriday.getDate()).slice(-2);
    $('#weeklyMenuHeader').text('Weekly Menu: ' + startDateString + ' - ' + endDateString);
    $('.weekday-date').each(function(index) {
        var date = new Date(nextMonday);
        date.setDate(nextMonday.getDate() + index);
        var formattedDate = ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
        $(this).text(formattedDate);
    });
    window.nextMondayDate = nextMonday;
    
    // Update dropdown with dates after they're calculated
    updateDropdownWithDates();
}

/* Update dropdown options with dates */
function updateDropdownWithDates() {
    const daySelect = document.getElementById('daySelect');
    if (!daySelect) return;
    
    const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText.trim());
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    
    // Update each option with the corresponding date
    days.forEach((day, index) => {
        const option = daySelect.querySelector(`option[value="${day}"]`);
        if (option && dates[index]) {
            option.textContent = `${dayNames[index]} (${dates[index]})`;
        }
    });
}

/* Document ready: restore, attach handlers */
$(document).ready(function() {
    restoreMenuProgressFromLocalStorage();
    enableEditablesForAllCells();
    initializeDaySelector(); // Initialize mobile day selector
    updateDropdownWithDates(); // Update dropdown with dates on load

    $('#generateMenuBtn').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ e.preventDefault(); return false; }});
    $('#menuForm').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ if (!$(e.target).is('#saveMenuBtn') && !$(e.target).hasClass('input-box')){ e.preventDefault(); return false; } }});
    $(document).on('blur', '.input-box', function(){ setTimeout(saveMenuProgressToLocalStorage, 80); });

    function ajaxPost(url) {
        return $.ajax({ url: url, type: 'POST', data: {}, beforeSend: function(xhr) { xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken')); } });
    }

    $('#generateMenuBtn').off('click.simple').on('click.simple', function(e) {
        e.preventDefault();
        const $btn = $(this);
        $btn.prop('disabled', true).addClass('disabled');

        const calls = [
            ajaxPost('/generate_menu/').done(resp => updateTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_am_menu/').done(resp => updateAMTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_fruit_menu/').done(resp => updateFruitTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_vegetable_menu/').done(resp => updateVegetableTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_pm_menu/').done(resp => updatePMTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_breakfast_menu/').done(resp => { updateBreakfastTable(resp); }).always(saveMenuProgressToLocalStorage)
        ];

        $.when.apply($, calls).always(function() {
            // ensure dates and milk defaults show like backup
            updateDates();
            ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
                safeSetText(day + 'Milk', document.getElementById(day + 'Milk')?.innerText || '1% w.milk (unflavored)');
                safeSetText(day + 'LunchMilk', document.getElementById(day + 'LunchMilk')?.innerText || '1% w.milk (unflavored)');
            });
            saveMenuProgressToLocalStorage();
            enableEditablesForAllCells();
            setTimeout(function(){ $btn.prop('disabled', false).removeClass('disabled'); }, 250);
        });
    });

    $(document).on('click', '#generateMenuBtn', function (e) { console.log('delegated generate handler (fallback)'); });

    $('#saveMenuBtn').off('click').on('click', function (e) {
        e.preventDefault();
        if (typeof checkMenuExistsAndSave === 'function') checkMenuExistsAndSave();
        else console.warn('checkMenuExistsAndSave not defined');
    });
});

window.updateTable = updateTable;
window.updateAMTable = updateAMTable;
window.updatePMTable = updatePMTable;
window.updateBreakfastTable = updateBreakfastTable;
window.updateFruitTable = updateFruitTable;
window.updateVegetableTable = updateVegetableTable;
window.saveMenuProgressToLocalStorage = saveMenuProgressToLocalStorage;
window.restoreMenuProgressFromLocalStorage = restoreMenuProgressFromLocalStorage;
</script>
<script>
function openInventoryWindow() {
    window.open(
        "{% url 'inventory_list' %}?popup=1",
        "InventoryWindow",
        "width=1100,height=700,scrollbars=yes,resizable=yes"
    );
}
</script>
{% endblock %}
{% extends 'tottimeapp/base_dynamic.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Weekly Menu{% endblock %}

{% block styles %}
<style>
/* =========================
   Weekly Menu Styles (clean + organized)
   - Mobile: <=1000px (single day view with dropdown)
   - Desktop: >=1001px (full week view)
   ========================= */

/* --- Base / shared styles --- */
#weeklyMenuHeader {
  background-color: #272630;
  color: #fff;
  text-align: center;
}

.table {
  border-collapse: collapse;
  width: 100%;
  table-layout: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-radius: 10px;
  overflow: hidden;
}

.table-title { border: 1px solid #dee2e6; padding: .75rem; text-align: center; }

th, td {
  border: 1px solid #dee2e6;
  padding: .75rem;
  word-wrap: break-word;
}

.table thead th, .table tbody td { text-align: left; font-weight: normal; }
.table thead th, .table tbody tr:nth-child(-n+3) { font-weight: bold; }

.vertical-header {
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  white-space: nowrap;
}

/* Inputs in table */
.table input[type="text"] {
  border: 1px solid #ced4da;
  border-radius: .25rem;
  padding: .375rem .75rem;
  width: 100%;
}

/* Button color tokens (shared) */
.btn-primaryoff { background: rgb(57,189,180); border-color: rgb(57,189,180); color: #21201f; font-weight: 700; }
.btn-primaryoff:hover { background: #007b8a; border-color: #007b8a; color: #fff; }

.btn-secondary { background: rgb(228,218,79); border-color: rgb(228,218,79); color: #21201f; }
.btn-secondary:hover { background: #b4ad46; border-color: #b4ad46; }

.btn-rec { background: rgb(153,158,158); border-color: rgb(153,158,158); color: #21201f; padding: 4px 6px !important; font-weight: 550; }
.btn-rec:hover { background: rgb(54,56,56); color: #fff; border-color: rgb(54,56,56); }

.btn-outline-primary.link-switch {
  background: transparent !important;
  color: rgb(57,189,180) !important;
  border-color: rgb(57,189,180) !important;
}
.btn-outline-primary.link-switch:hover { background: rgb(57,189,180) !important; color: #fff !important; }

/* keep specific rows non-bold */
#grainRow th, #meatRow th { font-weight: normal; }

/* accessibility helper */
.sr-only {
  position: absolute !important;
  width: 1px; height: 1px;
  padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,0,0);
  white-space: nowrap; border: 0;
}

/* Mobile day selector dropdown */
#mobileDaySelector {
  display: none;
  margin: 0;
  padding: 0;
  width: 100%;
}

#mobileDaySelector .mobile-day-dropdown {
  width: 50%;
  padding: 10px 14px;
  font-size: 1.05rem;
  line-height: 1.25 !important;
  border-radius: 6px;
  background-color: rgba(34, 37, 41, 1) !important;
  color: #fff !important;
  border: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-weight: 600;
  text-align: left;
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23ffffff' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 18px;
  padding-right: 35px;
  padding-left: 10px;
}

#mobileDaySelector .mobile-day-dropdown:focus,
#mobileDaySelector .mobile-day-dropdown:hover {
  outline: none;
  background-color: rgba(34, 37, 41, 1) !important;
}

#mobileDaySelector .mobile-day-dropdown option {
  background-color: #272630;
  color: #fff;
  padding: 10px;
}

/* 3-dot menu button styling */
.mobile-menu-btn {
  background-color: rgba(34, 37, 41, 1) !important;
  color: #fff !important;
  border: none;
  border-radius: 6px;
  padding: 10px 15px;
  font-size: 1.2rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.mobile-menu-btn:hover {
  background-color: rgba(44, 47, 51, 1) !important;
}

/* Dropdown menu styling */
.mobile-menu-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 5px;
  background-color: rgba(34, 37, 41, 1);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  min-width: 180px;
  z-index: 1150;
  display: none;
  overflow: hidden;
}

.mobile-menu-dropdown.show {
  display: block;
}

.mobile-menu-dropdown button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  background: transparent;
  border: none;
  color: #fff;
  text-align: left;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.mobile-menu-dropdown button:hover {
  background-color: rgba(57, 189, 180, 0.2);
}

.mobile-menu-dropdown button i {
  margin-right: 10px;
  width: 20px;
  text-align: center;
}

/* --- Print rules (replace entire block with this) --- */
@media print {
  /* Hide non-print UI */
  h1,
  .sb-topnav,
  .sb-sidenav-footer,
  .button-container,
  #generateMenuBtn,
  #saveMenuBtn,
  #mobileDaySelector,
  #mobileBottomNav {
    display: none !important;
  }

  /* Page setup */
  @page {
    size: landscape;
    margin: 0.3in 0.25in;
  }

  body {
    margin: 0 !important;
    padding: 0 !important;
    width: auto !important;
    /* avoid clipping from fit-content */
  }

  /* Container must not clip */
  .container,
  #printableTable {
    overflow: visible !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 auto !important;
  }

  /* Table sizing and borders */
  #weeklyMenuTable,
  .table {
    table-layout: fixed !important;
    width: 100% !important;
    /* was 200%, caused right edge cut */
    border-collapse: collapse !important;
  }

  /* Draw a definite left/right edge */
  #weeklyMenuTable {
    border-left: 1px solid #dee2e6 !important;
    border-right: 1px solid #dee2e6 !important;
  }

  #weeklyMenuTable th,
  #weeklyMenuTable td {
    border: 1px solid #dee2e6 !important;
    padding: 0.35rem 0.35rem !important;
    font-size: 0.8rem !important;
    line-height: 1.1 !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
  }

  /* Ensure the last column prints its right border */
  #weeklyMenuTable th:last-child,
  #weeklyMenuTable td:last-child {
    border-right: 1px solid #dee2e6 !important;
  }

  /* Keep all day columns visible even on mobile */
  #weeklyMenuTable [data-day] {
    display: table-cell !important;
  }

  /* Vertical header column: keep thin and vertical */
  #weeklyMenuTable col.vert-col {
    width: 24px !important;
  }

  #weeklyMenuTable td.vertical-header,
  #weeklyMenuTable th.vertical-header {
    writing-mode: vertical-rl !important;
    transform: rotate(180deg) !important;
    white-space: nowrap !important;
    box-sizing: border-box !important;
    width: 24px !important;
    min-width: 24px !important;
    max-width: 24px !important;
    padding: 2px 1px !important;
    text-align: center !important;
    font-weight: bold;
  }
}

/* =========================
   MOBILE (<=1000px)
   - hide H1 and top buttons
   - show day selector dropdown
   - show only selected day column
   ========================= */
@media (max-width: 1000px) {
  /* hide header + top button area */
  h1.mt-4,
  .top-button-row,
  #printableTable > form .mb-3 {
    display: none !important;
  }

  /* Prevent horizontal scrolling and hide scrollbars */
  html, body {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }

  /* Hide vertical scrollbar but allow scrolling */
  body {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  body::-webkit-scrollbar {
    display: none;
  }

  /* Hide entire table header (thead) on mobile */
  .table thead {
    display: none !important;
  }

  /* Remove container margins on mobile */
  .container {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    max-width: 100% !important;
  }

  #printableTable {
    margin: 0 !important;
    margin-left: -25px !important;
    padding: 0 !important;
    width: 100% !important;
  }

  table tbody {
    background-color: #e8e8e8bd !important;
  }

  /* Show mobile day selector - full width, no margins */
  #mobileDaySelector {
    display: block !important;
    position: sticky;
    top: 56px;
    z-index: 1100;
    margin: 0 !important;
    margin-left: 25px !important;
    padding: 0 !important;
    width: 100vw !important;
    left: 0;
    right: 0;
  }

  /* Remove row margins */
  .row {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  /* COMPLETELY REMOVE the vertical section header cells from layout */
  .table tbody tr td.vertical-header {
    display: none !important;
  }

  /* Force table to use 2-column layout on mobile by targeting the rows */
  .table tbody tr {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    width: 100% !important;
    margin-left: -4px !important;
  }

  /* Make sure all visible cells take up their grid space */
  .table tbody tr td:not(.vertical-header) {
    display: block !important;
  }

  /* Create horizontal section headers using ::before */
  .table tbody tr:nth-child(1)::before {
    content: 'Breakfast';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(1) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* AM Snack section */
  .table tbody tr:nth-child(5)::before {
    content: 'AM Snack';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(5) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* Lunch section */
  .table tbody tr:nth-child(9)::before {
    content: 'Lunch';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(9) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* PM Snack section */
  .table tbody tr:nth-child(16)::before {
    content: 'PM Snack';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(16) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* Remove top margin from table row on mobile */
  .row.mt-3 {
    margin-top: 0 !important;
  }

  #mobileDaySelector .mobile-day-dropdown {
    border-radius: 0 !important;
    margin: 0 !important;
    width: 50% !important;
  }

  /* Remove col padding */
  .col {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  /* compact table for mobile */
  .table { 
    box-shadow: none; 
    border-radius: 6px;
    margin-top: 0 !important;
  }
  
  th, td { 
    padding: .5rem; 
    font-size: .95rem;
  }

  /* Hide ALL day columns by default in mobile */
  .table thead tr th[data-day],
  .table tbody tr td[data-day],
  .table tbody tr th[data-day] {
    display: none !important;
  }

  /* Show ONLY selected day */
  .table thead tr th.mobile-show-day,
  .table tbody tr td.mobile-show-day,
  .table tbody tr th.mobile-show-day {
    display: block !important;
  }

  /* Adjust header colspan for mobile */
  #weeklyMenuHeader {
    display: table-cell !important;
  }

  /* make space for fixed mobile nav */
  body { padding-bottom: 100px !important; }

  /* ensure mobile bottom nav isn't accidentally hidden */
  #mobileBottomNav { z-index: 1200; }

  /* minor button tweaks for mobile nav */
  #mobileBottomNav .btn { background: transparent; border: none; padding: 6px 8px; color: #fff; }
}
/* =========================
   DESKTOP (>=1001px)
   - show H1 and top buttons
   - show all columns
   - hide day selector
   ========================= */
@media (min-width: 1001px) {
  h1.mt-4,
  .top-button-row,
  #printableTable > form .mb-3 {
    display: block !important;
  }

  #mobileDaySelector {
    display: none !important;
  }

  /* Hide mobile bottom navigation on desktop */
  #mobileBottomNav {
    display: none !important;
  }

  body { padding-bottom: 0; }
  .table thead th, .table tbody td { font-size: 1rem; }
  
  /* Ensure all columns are visible on desktop */
  .table thead tr th,
  .table tbody tr td,
  .table tbody tr th {
    display: table-cell !important;
  }
}
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4">Weekly Menu</h1>
        <div class="container mt-5" id="printableTable">
            <form onsubmit="event.preventDefault(); checkMenuExistsAndSave();" id="menuForm"> <!-- Start of the form -->
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <button id="generateMenuBtn" class="btn btn-primaryoff mr-2" type="button">Generate Menu</button>
                            <button id="saveMenuBtn" type="submit" class="btn btn-secondary">Save</button> <!-- Button type set to submit -->
                            <a href="{% url 'past_menus' %}" class="btn btn-rec" style="margin-left: 15px;">
                                Saved Menus
                            </a>    
                            <button type="button" class="btn btn-outline-primary link-switch" style="margin-left: 10px;" onclick="openInventoryWindow()">
                            Inventory
                        </button>
                        </div>
                        
                    </div>
                </div>

               <!-- Mobile Day Selector -->
<div id="mobileDaySelector">
    <div style="display: flex; justify-content: space-between; align-items: center; background-color: rgba(34, 37, 41, 1); padding: 10px;">
        <select id="daySelect" aria-label="Select day of week" class="mobile-day-dropdown">
            <option value="monday">Monday</option>
            <option value="tuesday">Tuesday</option>
            <option value="wednesday">Wednesday</option>
            <option value="thursday">Thursday</option>
            <option value="friday">Friday</option>
        </select>
        <div style="position: relative;">
            <button type="button" id="mobileMenuBtn" class="mobile-menu-btn" title="Menu" aria-label="Menu Options">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <div id="mobileMenuDropdown" class="mobile-menu-dropdown">
                <button type="button" id="generatePDFBtn">
                    <i class="fas fa-file-pdf"></i>Generate PDF
                </button>
                <button type="button" id="exportWeeklyMenuCSV">
                <i class="fas fa-file-csv"></i>Export Menu
                </button>
            </div>
        </div>
    </div>
</div>

                <div class="row mt-3">
                    <div class="col">
                        <table id="weeklyMenuTable" class="table">
  <colgroup>
    <col class="vert-col" style="width:24px">
    <col />
    <col />
    <col />
    <col />
    <col />
    <col />
  </colgroup>
  <thead>
                        <tr>
                            <th id="weeklyMenuHeader" scope="col" colspan="7" style="text-align: center;">Weekly Menu: Date - Date</th>
                        </tr>
                    <tr>
                        <th scope="col" colspan="2">Facility: {{ facility_name }}</th>
                        <th scope="col" style="text-align: center;" data-day="monday">Monday</th>
                        <th scope="col" style="text-align: center;" data-day="tuesday">Tuesday</th>
                        <th scope="col" style="text-align: center;" data-day="wednesday">Wednesday</th>
                        <th scope="col" style="text-align: center;" data-day="thursday">Thursday</th>
                        <th scope="col" style="text-align: center;" data-day="friday">Friday</th>
                    </tr>
                    <tr>
                        <th scope="col" colspan="2">Sponsor: {{ sponsor_name }}</th>
                        <th scope="col" style="text-align: center;" data-day="monday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="tuesday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="wednesday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="thursday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="friday"><span class="weekday-date"></span></th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">Breakfast</td>
                            <td>Fluid Milk</td>
                            <td id="mondayMilk" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayMilk" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayMilk" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayMilk" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayMilk" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayadd1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayadd1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayadd1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayadd1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">AM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaychoose1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaychoose1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaychoose1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaychoose1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaymeat1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaymeat1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaymeat1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaymeat1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="7" style="font-weight: bold; text-align: center;">Lunch</td>
                            <td>Main Dish</td>
                            <td id="mondayMeals" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayMeals" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayMeals" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayMeals" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayMeals" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fluid Milk</td>
                            <td id="mondayLunchMilk" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayLunchMilk" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayLunchMilk" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayLunchMilk" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayLunchMilk" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Vegetable</td>
                            <td id="mondayvege" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayvege" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayvege" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayvege" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayvege" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit</td>
                            <td id="mondayfruit3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr id="grainRow">
                            <th scope="col">Grain</th>
                            <th id="mondayGrain" style="text-align: center;" data-day="monday"></th>
                            <th id="tuesdayGrain" style="text-align: center;" data-day="tuesday"></th>
                            <th id="wednesdayGrain" style="text-align: center;" data-day="wednesday"></th>
                            <th id="thursdayGrain" style="text-align: center;" data-day="thursday"></th>
                            <th id="fridayGrain" style="text-align: center;" data-day="friday"></th>
                        </tr>
                        <tr id="meatRow">
                            <th scope="col">Meat or Meat Alternate</th>
                            <th id="mondayMeatAlternate" style="text-align: center;" data-day="monday"></th>
                            <th id="tuesdayMeatAlternate" style="text-align: center;" data-day="tuesday"></th>
                            <th id="wednesdayMeatAlternate" style="text-align: center;" data-day="wednesday"></th>
                            <th id="thursdayMeatAlternate" style="text-align: center;" data-day="thursday"></th>
                            <th id="fridayMeatAlternate" style="text-align: center;" data-day="friday"></th>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayadd2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayadd2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayadd2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayadd2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr> 
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">PM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaychoose2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaychoose2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaychoose2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaychoose2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit4" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit4" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit4" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit4" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit4" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaymeat3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaymeat3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaymeat3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaymeat3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                    </tbody>
                </table>
                <!-- MOBILE: fixed bottom navigation (visible only on small screens via CSS) -->
                <div id="mobileBottomNav" role="navigation" aria-label="Mobile actions">
                    <button type="button" class="btn btn-primaryoff" onclick="document.getElementById('generateMenuBtn').click();" title="Generate Menu">
                        <i class="fas fa-magic" aria-hidden="true"></i>
                        <span class="sr-only">Generate Menu</span>
                    </button>

                    <!-- Center circular update/save button (uses base_minimal .update-btn styles) -->
                    <button type="button" class="btn update-btn" onclick="document.getElementById('saveMenuBtn').click();" title="Save Menu">
                        <i class="fas fa-save" aria-hidden="true"></i>
                        <span class="sr-only">Save Menu</span>
                    </button>

                    <a href="{% url 'past_menus' %}" class="btn btn-rec" title="Saved Menus" role="button">
                        <i class="fas fa-folder-open" aria-hidden="true"></i>
                        <span class="sr-only">Saved Menus</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
{% block scripts %}
<script>
/* Persist-in-progress weekly menu, robust generate handlers, and full mapping to all table cells */

/* Local storage key */
const MENU_PROGRESS_KEY = "weeklyMenuProgress_v1";
const SELECTED_DAY_KEY = "selectedDay_v1";

/* Save/restore helpers */
function saveMenuProgressToLocalStorage() {
    try {
        const menu = {};
        const ids = [
            'mondayMilk','tuesdayMilk','wednesdayMilk','thursdayMilk','fridayMilk',
            'mondayfruit','tuesdayfruit','wednesdayfruit','thursdayfruit','fridayfruit',
            'mondaybread','tuesdaybread','wednesdaybread','thursdaybread','fridaybread',
            'mondayadd1','tuesdayadd1','wednesdayadd1','thursdayadd1','fridayadd1',
            'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
            'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
            'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
            'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1',
            'mondayMeals','tuesdayMeals','wednesdayMeals','thursdayMeals','fridayMeals',
            'mondayLunchMilk','tuesdayLunchMilk','wednesdayLunchMilk','thursdayLunchMilk','fridayLunchMilk',
            'mondayvege','tuesdayvege','wednesdayvege','thursdayvege','fridayvege',
            'mondayfruit3','tuesdayfruit3','wednesdayfruit3','thursdayfruit3','fridayfruit3',
            'mondayGrain','tuesdayGrain','wednesdayGrain','thursdayGrain','fridayGrain',
            'mondayMeatAlternate','tuesdayMeatAlternate','wednesdayMeatAlternate','thursdayMeatAlternate','fridayMeatAlternate',
            'mondayadd2','tuesdayadd2','wednesdayadd2','thursdayadd2','fridayadd2',
            'mondaychoose2','tuesdaychoose2','wednesdaychoose2','thursdaychoose2','fridaychoose2',
            'mondayfruit4','tuesdayfruit4','wednesdayfruit4','thursdayfruit4','fridayfruit4',
            'mondaybread3','tuesdaybread3','wednesdaybread3','thursdaybread3','fridaybread3',
            'mondaymeat3','tuesdaymeat3','wednesdaymeat3','thursdaymeat3','fridaymeat3'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) menu[id] = el.innerText;
        });
        const header = document.getElementById('weeklyMenuHeader');
        if (header) menu.weeklyMenuHeader = header.innerText;
        const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText);
        menu.weekdayDates = dates;
        localStorage.setItem(MENU_PROGRESS_KEY, JSON.stringify(menu));
    } catch (err) {
        console.warn('saveMenuProgress failed', err);
    }
}

function restoreMenuProgressFromLocalStorage() {
    try {
        const raw = localStorage.getItem(MENU_PROGRESS_KEY);
        if (!raw) return;
        const menu = JSON.parse(raw);
        if (!menu) return;
        Object.entries(menu).forEach(([k, v]) => {
            if (k === 'weeklyMenuHeader') {
                const h = document.getElementById('weeklyMenuHeader');
                if (h) h.innerText = v;
                
                // Extract and restore nextMondayDate from header text
                // Format: "Weekly Menu: MM/DD - MM/DD"
                const match = v.match(/Weekly Menu: (\d{2})\/(\d{2})/);
                if (match) {
                    const month = parseInt(match[1]) - 1; // JS months are 0-indexed
                    const day = parseInt(match[2]);
                    const year = new Date().getFullYear();
                    
                    // Create date and ensure it's a Monday in the future
                    const restoredDate = new Date(year, month, day);
                    
                    // If the date is in the past, add a year
                    if (restoredDate < new Date()) {
                        restoredDate.setFullYear(year + 1);
                    }
                    
                    window.nextMondayDate = restoredDate;
                    console.log('Restored nextMondayDate:', window.nextMondayDate);
                }
            } else if (k === 'weekdayDates' && Array.isArray(v)) {
                document.querySelectorAll('.weekday-date').forEach((el, i) => { if (v[i]) el.innerText = v[i]; });
            } else {
                const el = document.getElementById(k);
                if (el) el.innerText = v;
            }
        });
    } catch (err) {
        console.warn('restoreMenuProgress failed', err);
    }
}

function clearMenuProgressFromLocalStorage() {
    localStorage.removeItem(MENU_PROGRESS_KEY);
}

/* Mobile day selector functionality */
function showSelectedDay(selectedDay) {
    document.querySelectorAll('[data-day]').forEach(el => {
        el.classList.remove('mobile-show-day');
    });
    
    document.querySelectorAll(`[data-day="${selectedDay}"]`).forEach(el => {
        el.classList.add('mobile-show-day');
    });
    
    try {
        localStorage.setItem(SELECTED_DAY_KEY, selectedDay);
    } catch (err) {
        console.warn('Failed to save selected day', err);
    }
}

function initializeDaySelector() {
    const daySelect = document.getElementById('daySelect');
    if (!daySelect) return;
    
    let savedDay = 'monday';
    try {
        savedDay = localStorage.getItem(SELECTED_DAY_KEY) || 'monday';
    } catch (err) {
        console.warn('Failed to restore selected day', err);
    }
    
    daySelect.value = savedDay;
    showSelectedDay(savedDay);
    
    daySelect.addEventListener('change', function() {
        showSelectedDay(this.value);
    });
}

/* Generic safe setter */
function safeSetText(id, text) {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerText = text == null ? '' : String(text);
}

/* Minimal mapping for common server keys */
const KEY_ID_MAP = {
    'meal_name': '{day}Meals', 'main_dish': '{day}Meals', 'lunch_main_dish': '{day}Meals',
    'grain': '{day}Grain',
    'meat_alternate': '{day}MeatAlternate', 'meat': '{day}MeatAlternate',
    'lunch_milk': '{day}LunchMilk', 'fluid_milk': '{day}Milk',
    'bread': '{day}bread', 'add1': '{day}add1',
    'choose1': '{day}choose1', 'fruit2': '{day}fruit2', 'bread2':'{day}bread2', 'meat1':'{day}meat1',
    'choose2': '{day}choose2', 'fruit4': '{day}fruit4', 'bread3':'{day}bread3', 'meat3':'{day}meat3',
    'fruit': '{day}fruit', 'fruit3':'{day}fruit3',
    'vegetable': '{day}vege', 'add2':'{day}add2'
};

function dayPrefix(day) { return day.toLowerCase(); }

function applyResponseToDay(day, payload) {
    if (!payload || typeof payload !== 'object') return;
    const prefix = dayPrefix(day);
    Object.entries(payload).forEach(([k, v]) => {
        if (v == null) v = '';
        let template = KEY_ID_MAP[k] || KEY_ID_MAP[k.toLowerCase()];
        if (template) {
            const id = template.replace('{day}', prefix);
            safeSetText(id, v);
            return;
        }
        if (typeof v === 'object') {
            Object.entries(v).forEach(([subk, subv]) => {
                let t = KEY_ID_MAP[subk] || KEY_ID_MAP[subk.toLowerCase()];
                if (t) safeSetText(t.replace('{day}', prefix), subv);
            });
            return;
        }
        const fallbackId = prefix + k.charAt(0).toUpperCase() + k.slice(1);
        if (document.getElementById(fallbackId)) safeSetText(fallbackId, v);
        else {
            const fallback2 = prefix + k.toLowerCase();
            if (document.getElementById(fallback2)) safeSetText(fallback2, v);
            else console.debug('No mapping for', k, '-> tried', fallbackId, fallback2);
        }
    });
}

function populateFromResponse(response) {
    if (!response) return;
    ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(day => {
        if (response[day]) applyResponseToDay(day, response[day]);
    });
}

/* The table updaters used by AJAX success handlers */
function updateTable(response){
    populateFromResponse(response);
    ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
        safeSetText(day + 'LunchMilk', '1% w.milk (unflavored)');
    });
    enableEditablesForAllCells();
}

function updateAMTable(response){ 
    populateFromResponse(response); 
    enableEditablesForAllCells(); 
}

function updatePMTable(response){ 
    populateFromResponse(response); 
    enableEditablesForAllCells(); 
}

function updateBreakfastTable(response){
    populateFromResponse(response);
    ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
    });
    enableEditablesForAllCells();
}

function updateFruitTable(response){ 
    populateFromResponse(response); 
    enableEditablesForAllCells(); 
}

function updateVegetableTable(response){ 
    populateFromResponse(response); 
    enableEditablesForAllCells(); 
}

/* CSRF helper */
function getCookie(name) {
    try {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    } catch (e) { console.warn('getCookie error', e); }
    return '';
}

/* Editable support */
function makeEditable(el) {
    if (!el || el.dataset.editable === 'true') return;
    el.dataset.editable = 'true';
    el.addEventListener('click', function () {
        const current = el.innerText.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-box form-control';
        input.value = current;
        el.innerText = '';
        el.appendChild(input);
        input.focus();
        input.addEventListener('blur', function () {
            el.innerText = input.value.trim();
            saveMenuProgressToLocalStorage();
        });
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') { input.blur(); }
        });
    });
}

function enableEditablesForAllCells() {
    const els = Array.from(document.querySelectorAll('#weeklyMenuTable td, #weeklyMenuTable th'));
    els.forEach(el => {
        if (el.id && el.id !== 'weeklyMenuHeader') makeEditable(el);
    });
}

/* Date helper */
function updateDates() {
    var today = new Date();
    var currentDayIndex = today.getDay();
    var daysUntilNextMonday = (currentDayIndex === 0) ? 1 : (8 - currentDayIndex);
    var nextMonday = new Date(today);
    nextMonday.setDate(today.getDate() + daysUntilNextMonday);
    var nextFriday = new Date(nextMonday);
    nextFriday.setDate(nextMonday.getDate() + 4);
    var startDateString = ('0' + (nextMonday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextMonday.getDate()).slice(-2);
    var endDateString = ('0' + (nextFriday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextFriday.getDate()).slice(-2);
    $('#weeklyMenuHeader').text('Weekly Menu: ' + startDateString + ' - ' + endDateString);
    $('.weekday-date').each(function(index) {
        var date = new Date(nextMonday);
        date.setDate(nextMonday.getDate() + index);
        var formattedDate = ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
        $(this).text(formattedDate);
    });
    window.nextMondayDate = nextMonday;
    updateDropdownWithDates();
}

/* Update dropdown options with dates */
function updateDropdownWithDates() {
    const daySelect = document.getElementById('daySelect');
    if (!daySelect) return;
    
    const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText.trim());
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    
    days.forEach((day, index) => {
        const option = daySelect.querySelector(`option[value="${day}"]`);
        if (option && dates[index]) {
            option.textContent = `${dayNames[index]} (${dates[index]})`;
        }
    });
}

/* Check if menu exists before saving */
async function checkMenuExistsAndSave() {
    const datesToCheck = [];
    const nextMonday = window.nextMondayDate;

    if (!nextMonday) {
        toastr.error('Please generate menu first to set dates');
        return;
    }

    for (let i = 0; i < 5; i++) {
        const date = new Date(nextMonday);
        date.setDate(nextMonday.getDate() + i);
        const formattedDate = date.toISOString().split('T')[0];
        datesToCheck.push(formattedDate);
    }

    try {
        const response = await fetch('/api/check_menu/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ dates: datesToCheck })
        });

        const result = await response.json();

        if (result.exists) {
            // Add timestamp to make each message unique and bypass preventDuplicates
            const uniqueId = Date.now();
            
            const warningToast = toastr.warning(
                `<div style="margin-bottom: 15px;">There is already a menu saved for these dates. Saving will override previous entries.</div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button type="button" class="btn btn-info warning-proceed-btn" style="padding: 8px 20px;">Proceed</button>
            <button type="button" class="btn btn-secondary warning-cancel-btn" style="padding: 8px 20px;">Cancel</button>
        </div>
        <span style="display:none;" data-unique="${uniqueId}"></span>`,
                'Warning',
                {
                    closeButton: false,
                    timeOut: 0,
                    extendedTimeOut: 0,
                    tapToDismiss: false,
                    positionClass: 'toast-top-center',
                    toastClass: 'toastr-warning-custom',
                    escapeHtml: false,
                    preventDuplicates: false,
                    onShown: function() {
                        // Keep the styling simple - width is already set in toast container
                        $('.warning-proceed-btn').off('click').on('click', function() {
                            $('.toastr-warning-custom').fadeOut(200, function() {
                                $(this).remove();
                                saveMenu();
                            });
                        });
                        
                        $('.warning-cancel-btn').off('click').on('click', function() {
                            $('.toastr-warning-custom').fadeOut(200, function() {
                                $(this).remove();
                            });
                        });
                    }
                }
            );
        } else {
            saveMenu();
        }
    } catch (error) {
        console.error('Error in checkMenuExistsAndSave:', error);
        toastr.error('Error checking existing menu. Please try again.');
    }
}

/* Save menu to database */
function saveMenu() {
    toastr.info('Saving menu...', '', {
        timeOut: 0,
        extendedTimeOut: 0,
        closeButton: false,
        tapToDismiss: false
    });

    const facilityName = document.querySelector('th[colspan="2"]')?.textContent.replace('Facility: ', '').trim() || '{{ facility_name }}';
    const sponsorName = document.querySelectorAll('th[colspan="2"]')[1]?.textContent.replace('Sponsor: ', '').trim() || '{{ sponsor_name }}';
    
    let menuData = {
        facility_name: facilityName,
        sponsor_name: sponsorName,
        monday: {
            am_fluid_milk: document.getElementById('mondayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('mondayfruit')?.innerText || '',
            am_bread: document.getElementById('mondaybread')?.innerText || '',
            am_additional: document.getElementById('mondayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('mondaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('mondayfruit2')?.innerText || '',
            ams_bread: document.getElementById('mondaybread2')?.innerText || '',
            ams_meat: document.getElementById('mondaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('mondayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('mondayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('mondayvege')?.innerText || '',
            lunch_fruit: document.getElementById('mondayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('mondayGrain')?.innerText || '',
            lunch_meat: document.getElementById('mondayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('mondayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('mondaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('mondayfruit4')?.innerText || '',
            pm_bread: document.getElementById('mondaybread3')?.innerText || '',
            pm_meat: document.getElementById('mondaymeat3')?.innerText || ''
        },
        tuesday: {
            am_fluid_milk: document.getElementById('tuesdayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('tuesdayfruit')?.innerText || '',
            am_bread: document.getElementById('tuesdaybread')?.innerText || '',
            am_additional: document.getElementById('tuesdayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('tuesdaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('tuesdayfruit2')?.innerText || '',
            ams_bread: document.getElementById('tuesdaybread2')?.innerText || '',
            ams_meat: document.getElementById('tuesdaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('tuesdayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('tuesdayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('tuesdayvege')?.innerText || '',
            lunch_fruit: document.getElementById('tuesdayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('tuesdayGrain')?.innerText || '',
            lunch_meat: document.getElementById('tuesdayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('tuesdayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('tuesdaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('tuesdayfruit4')?.innerText || '',
            pm_bread: document.getElementById('tuesdaybread3')?.innerText || '',
            pm_meat: document.getElementById('tuesdaymeat3')?.innerText || ''
        },
        wednesday: {
            am_fluid_milk: document.getElementById('wednesdayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('wednesdayfruit')?.innerText || '',
            am_bread: document.getElementById('wednesdaybread')?.innerText || '',
            am_additional: document.getElementById('wednesdayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('wednesdaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('wednesdayfruit2')?.innerText || '',
            ams_bread: document.getElementById('wednesdaybread2')?.innerText || '',
            ams_meat: document.getElementById('wednesdaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('wednesdayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('wednesdayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('wednesdayvege')?.innerText || '',
            lunch_fruit: document.getElementById('wednesdayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('wednesdayGrain')?.innerText || '',
            lunch_meat: document.getElementById('wednesdayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('wednesdayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('wednesdaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('wednesdayfruit4')?.innerText || '',
            pm_bread: document.getElementById('wednesdaybread3')?.innerText || '',
            pm_meat: document.getElementById('wednesdaymeat3')?.innerText || ''
        },
        thursday: {
            am_fluid_milk: document.getElementById('thursdayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('thursdayfruit')?.innerText || '',
            am_bread: document.getElementById('thursdaybread')?.innerText || '',
            am_additional: document.getElementById('thursdayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('thursdaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('thursdayfruit2')?.innerText || '',
            ams_bread: document.getElementById('thursdaybread2')?.innerText || '',
            ams_meat: document.getElementById('thursdaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('thursdayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('thursdayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('thursdayvege')?.innerText || '',
            lunch_fruit: document.getElementById('thursdayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('thursdayGrain')?.innerText || '',
            lunch_meat: document.getElementById('thursdayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('thursdayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('thursdaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('thursdayfruit4')?.innerText || '',
            pm_bread: document.getElementById('thursdaybread3')?.innerText || '',
            pm_meat: document.getElementById('thursdaymeat3')?.innerText || ''
        },
        friday: {
            am_fluid_milk: document.getElementById('fridayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('fridayfruit')?.innerText || '',
            am_bread: document.getElementById('fridaybread')?.innerText || '',
            am_additional: document.getElementById('fridayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('fridaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('fridayfruit2')?.innerText || '',
            ams_bread: document.getElementById('fridaybread2')?.innerText || '',
            ams_meat: document.getElementById('fridaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('fridayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('fridayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('fridayvege')?.innerText || '',
            lunch_fruit: document.getElementById('fridayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('fridayGrain')?.innerText || '',
            lunch_meat: document.getElementById('fridayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('fridayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('fridaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('fridayfruit4')?.innerText || '',
            pm_bread: document.getElementById('fridaybread3')?.innerText || '',
            pm_meat: document.getElementById('fridaymeat3')?.innerText || ''
        }
    };

    console.log('Sending menu data:', menuData);

    $.ajax({
        url: '/api/save_menu/',
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(menuData),
        success: function (response) {
            console.log('Save response:', response);
            toastr.clear();
            toastr.success('Menu saved successfully!');
            clearMenuProgressFromLocalStorage();
        },
        error: function (xhr, status, error) {
            console.error('Save error:', xhr.responseText);
            toastr.clear();
            toastr.error('Error saving menu: ' + (xhr.responseJSON?.error || error));
        }
    });
}

/* Document ready: restore, attach handlers */
$(document).ready(function() {
    restoreMenuProgressFromLocalStorage();
    enableEditablesForAllCells();
    initializeDaySelector();
    updateDropdownWithDates();

    $('#generateMenuBtn').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ e.preventDefault(); return false; }});
    $('#menuForm').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ if (!$(e.target).is('#saveMenuBtn') && !$(e.target).hasClass('input-box')){ e.preventDefault(); return false; } }});
    $(document).on('blur', '.input-box', function(){ setTimeout(saveMenuProgressToLocalStorage, 80); });

    function ajaxPost(url) {
        return $.ajax({ url: url, type: 'POST', data: {}, beforeSend: function(xhr) { xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken')); } });
    }

    $('#generateMenuBtn').off('click.simple').on('click.simple', function(e) {
        e.preventDefault();
        const $btn = $(this);
        $btn.prop('disabled', true).addClass('disabled');

        const calls = [
            ajaxPost('/generate_menu/').done(resp => updateTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_am_menu/').done(resp => updateAMTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_fruit_menu/').done(resp => updateFruitTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_vegetable_menu/').done(resp => updateVegetableTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_pm_menu/').done(resp => updatePMTable(resp)).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_breakfast_menu/').done(resp => { updateBreakfastTable(resp); }).always(saveMenuProgressToLocalStorage)
        ];

        $.when.apply($, calls).always(function() {
            updateDates();
            ['monday','tuesday','wednesday','thursday','friday'].forEach(day => {
                safeSetText(day + 'Milk', document.getElementById(day + 'Milk')?.innerText || '1% w.milk (unflavored)');
                safeSetText(day + 'LunchMilk', document.getElementById(day + 'LunchMilk')?.innerText || '1% w.milk (unflavored)');
            });
            saveMenuProgressToLocalStorage();
            enableEditablesForAllCells();
            setTimeout(function(){ $btn.prop('disabled', false).removeClass('disabled'); }, 250);
        });
    });

    $(document).on('click', '#generateMenuBtn', function (e) { console.log('delegated generate handler (fallback)'); });

    $('#saveMenuBtn').off('click').on('click', function (e) {
        e.preventDefault();
        if (typeof checkMenuExistsAndSave === 'function') checkMenuExistsAndSave();
        else console.warn('checkMenuExistsAndSave not defined');
    });
});

window.updateTable = updateTable;
window.updateAMTable = updateAMTable;
window.updatePMTable = updatePMTable;
window.updateBreakfastTable = updateBreakfastTable;
window.updateFruitTable = updateFruitTable;
window.updateVegetableTable = updateVegetableTable;
window.saveMenuProgressToLocalStorage = saveMenuProgressToLocalStorage;
window.restoreMenuProgressFromLocalStorage = restoreMenuProgressFromLocalStorage;
window.checkMenuExistsAndSave = checkMenuExistsAndSave;
window.saveMenu = saveMenu;
</script>
<script>
function openInventoryWindow() {
    window.open(
        "{% url 'inventory_list' %}?popup=1",
        "InventoryWindow",
        "width=1100,height=700,scrollbars=yes,resizable=yes"
    );
}

// Mobile menu dropdown toggle
$('#mobileMenuBtn').on('click', function(e) {
    e.stopPropagation();
    $('#mobileMenuDropdown').toggleClass('show');
});

// Close dropdown when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('#mobileMenuBtn, #mobileMenuDropdown').length) {
        $('#mobileMenuDropdown').removeClass('show');
    }
});

// Generate PDF button - prints full weekly table regardless of screen size
$('#generatePDFBtn').on('click', function(e) {
    e.preventDefault();
    $('#mobileMenuDropdown').removeClass('show');
    
    // Store current state
    const isMobile = window.innerWidth <= 1000;
    const mobileShowElements = document.querySelectorAll('.mobile-show-day');
    const allDayElements = document.querySelectorAll('[data-day]');
    const verticalHeaders = document.querySelectorAll('.vertical-header');
    const tbody = document.querySelector('.table tbody');
    const thead = document.querySelector('.table thead');
    const allRows = document.querySelectorAll('.table tbody tr');
    
    // Store original styles
    const originalStyles = {
        body: tbody ? tbody.style.cssText : '',
        head: thead ? thead.style.cssText : '',
    };
    
    // Add comprehensive print style
    const printStyle = document.createElement('style');
    printStyle.id = 'temp-print-style';
    printStyle.innerHTML = `
        /* Force desktop table layout for printing */
        body.printing-pdf {
            overflow-x: visible !important;
            max-width: none !important;
        }
        
        body.printing-pdf .table {
            table-layout: fixed !important;
            width: 100% !important;
        }
        
        body.printing-pdf .table thead {
            display: table-header-group !important;
        }
        
        body.printing-pdf .table tbody {
            display: table-row-group !important;
            background-color: #fff !important;
        }
        
        body.printing-pdf .table tbody tr {
            display: table-row !important;
            grid-template-columns: none !important;
            margin-top: 0 !important;
            margin-left: 0 !important;
            width: auto !important;
            position: static !important;
        }
        
        body.printing-pdf .table tbody tr::before {
            content: none !important;
            display: none !important;
        }
        
        body.printing-pdf .table tbody tr td,
        body.printing-pdf .table tbody tr th,
        body.printing-pdf .table thead tr th {
            display: table-cell !important;
            padding: 0.2rem !important;
            font-size: 0.65rem !important;
            line-height: 1.1 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }
        
        body.printing-pdf .table tbody tr td.vertical-header {
            display: table-cell !important;
            writing-mode: vertical-rl !important;
            transform: rotate(180deg) !important;
            white-space: nowrap !important;
            box-sizing: border-box;
            width: 24px;
            min-width: 24px;
            max-width: 24px;
            padding: 2px 1px;
            text-align: center !important;
            font-size: 0.7rem !important;
        }
        
        body.printing-pdf .table thead tr th[data-day],
        body.printing-pdf .table tbody tr td[data-day],
        body.printing-pdf .table tbody tr th[data-day] {
            display: table-cell !important;
        }
        
        body.printing-pdf #mobileDaySelector,
        body.printing-pdf #mobileBottomNav {
            display: none !important;
        }
        
        body.printing-pdf .container {
            padding-left: 10px !important;
            padding-right: 10px !important;
            margin-left: auto !important;
            margin-right: auto !important;
            max-width: 100% !important;
        }
        
        body.printing-pdf #printableTable {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        
        @media print {
            h1, .sb-topnav, .sb-sidenav-footer, .button-container, #generateMenuBtn, #saveMenuBtn, #mobileDaySelector, #mobileBottomNav {
                display: none !important;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                width: 100%;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .table {
                table-layout: fixed !important;
                width: 100% !important;
                border-collapse: collapse !important;
            }
            
            .table thead {
                display: table-header-group !important;
            }
            
            .table tbody {
                display: table-row-group !important;
            }
            
            .table tbody tr {
                display: table-row !important;
                grid-template-columns: none !important;
                position: static !important;
                margin: 0 !important;
                page-break-inside: avoid !important;
            }
            
            .table tbody tr::before {
                content: none !important;
                display: none !important;
            }
            
            .table tbody tr td.vertical-header {
                display: table-cell !important;
                writing-mode: vertical-rl !important;
                transform: rotate(180deg) !important;
                white-space: nowrap !important;
                width: 24px !important;
                min-width: 24px !important;
                max-width: 24px !important;
                padding: 2px 1px !important;
                font-size: 0.7rem !important;
            }
            
            .table thead tr th,
            .table tbody tr td,
            .table tbody tr th {
                display: table-cell !important;
                padding: 0.2rem 0.15rem !important;
                font-size: 0.6rem !important;
                line-height: 1.1 !important;
                word-wrap: break-word !important;
                white-space: normal !important;
                overflow-wrap: break-word !important;
            }
            
            /* First column (labels) slightly wider */
            .table tbody tr td:nth-child(2) {
                width: 18% !important;
                font-size: 0.58rem !important;
            }
            
            /* Day columns equal width */
            .table tbody tr td[data-day],
           
            .table thead tr th[data-day] {
                width: 13.5% !important;
            }
            
            /* Header rows */
            .table thead tr th {
                font-size: 0.65rem !important;
                padding: 0.25rem !important;
            }

            #weeklyMenuHeader {
                font-size: 0.75rem !important;
                padding: 0.3rem !important;
            }

            .vertical-header {
                writing-mode: vertical-rl !important;
                transform: rotate(180deg) !important;
                white-space: nowrap !important;
            }

            @page {
                size: landscape;
                margin: 0.3in 0.25in;
            }
        }
    `;
    document.head.appendChild(printStyle);

    // Add printing class to body
    document.body.classList.add('printing-pdf');

    setTimeout(() => {
        window.print();

        setTimeout(() => {
            const tempStyle = document.getElementById('temp-print-style');
            if (tempStyle) tempStyle.remove();
            document.body.classList.remove('printing-pdf');

            allDayElements.forEach(el => { el.style.display = ''; });
            verticalHeaders.forEach(el => { el.style.padding = ''; });
            allRows.forEach(row => { row.style.marginTop = ''; });
            if (tbody) tbody.style.cssText = originalStyles.body;
            if (thead) thead.style.cssText = originalStyles.head;

            if (isMobile) {
                // reapply mobile-only view if needed
                const daySelect = document.getElementById('daySelect');
                const selectedDay = daySelect ? daySelect.value : 'monday';
                document.querySelectorAll('[data-day]').forEach(el => el.classList.remove('mobile-show-day'));
                document.querySelectorAll(`[data-day="${selectedDay}"]`).forEach(el => el.classList.add('mobile-show-day'));
            }
        }, 500);
    }, 100);
}); // <-- close PDF click handler here

function exportWeeklyMenuCSV() {
    const table = document.getElementById('weeklyMenuTable');
    if (!table) return;

    const getText = (el) => (el ? el.textContent.replace(/\s+/g, ' ').trim() : '');
    const rows = [];

    // Title
    const headerTitle = document.getElementById('weeklyMenuHeader');
    if (headerTitle) rows.push([getText(headerTitle)]);

    // THEAD
    const thead = table.querySelector('thead');
    if (thead) {
        thead.querySelectorAll('tr').forEach(tr => {
            rows.push(Array.from(tr.children).map(getText));
        });
    }

    // TBODY with standalone section header row
    const tbody = table.querySelector('tbody');
    if (tbody) {
        const trList = Array.from(tbody.querySelectorAll('tr'));
        trList.forEach(tr => {
            const cells = Array.from(tr.children);
            if (cells[0] && cells[0].classList.contains('vertical-header')) {
                rows.push([getText(cells[0])]); // Breakfast, AM Snack, Lunch, PM Snack
                return;
            }
            rows.push(cells.map(getText)); // item rows
        });
    }

    const toCSVLine = (arr) => arr.map(v => {
        const s = v == null ? '' : String(v);
        const escaped = s.replace(/"/g, '""');
        return /[",\n]/.test(s) ? `"${escaped}"` : escaped;
    }).join(',');

    const csv = rows.map(toCSVLine).join('\n');

    // Filename from dates if present
    let fileName = 'weekly-menu.csv';
    const titleText = getText(headerTitle);
    const match = titleText.match(/Weekly Menu:\s*([0-9/]+)\s*-\s*([0-9/]+)/i);
    if (match) fileName = `weekly-menu-${match[1].replace(/\//g, '-')}-to-${match[2].replace(/\//g, '-')}.csv`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    $('#mobileMenuDropdown').removeClass('show');
}

$(document).on('click', '#exportWeeklyMenuCSV', function(e) {
    e.preventDefault();
    exportWeeklyMenuCSV();
});
</script>
{% endblock %}
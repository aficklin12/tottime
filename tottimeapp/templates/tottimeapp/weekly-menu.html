{% extends 'tottimeapp/base_dynamic.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Weekly Menu{% endblock %}

{% block styles %}
<style>
/* =========================
   Weekly Menu Styles (clean + organized)
   - Mobile: <=1000px (single day view with dropdown)
   - Desktop: >=1001px (full week view)
   ========================= */

/* --- Base / shared styles --- */
#weeklyMenuHeader {
  background-color: #272630;
  color: #fff;
  text-align: center;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

/* AM Snack toggle button - hidden by default, shown only on mobile */
.am-snack-toggle-btn {
    display: none;
}

.table {
  border-collapse: collapse;
  width: 100%;
  table-layout: auto;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-radius: 10px;
  overflow: hidden;
}

/* Allow header dropdown to overflow the table bounds */
#weeklyMenuTable {
    overflow: visible;
}

.table-title { border: 1px solid #dee2e6; padding: .75rem; text-align: center; }

th, td {
    border: 1px solid #dee2e6;
    padding: .75rem;
    word-wrap: break-word;
}

thead tr:first-child th {
    border-top: none !important;
}
thead tr:first-child th:first-child {
    border-top-left-radius: 10px;
}
thead tr:first-child th:last-child {
    border-top-right-radius: 10px;
}

.table thead th, .table tbody td { text-align: left; font-weight: normal; }
.table thead th, .table tbody tr:nth-child(-n+3) { font-weight: bold; }

.vertical-header {
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  white-space: nowrap;
}

/* Inputs in table */
.table input[type="text"] {
  border: 1px solid #ced4da;
  border-radius: .25rem;
  padding: .375rem .75rem;
  width: 100%;
}

/* Button color tokens (shared) */
.btn-primaryoff { background: rgb(57,189,180); border-color: rgb(57,189,180); color: #21201f; font-weight: 700; }
.btn-primaryoff:hover { background: #007b8a; border-color: #007b8a; color: #fff; }

.btn-secondary { background: rgb(228,218,79); border-color: rgb(228,218,79); color: #21201f; }
.btn-secondary:hover { background: #b4ad46; border-color: #b4ad46; }

.btn-rec { background: rgb(153,158,158); border-color: rgb(153,158,158); color: #21201f; padding: 4px 6px !important; font-weight: 550; }
.btn-rec:hover { background: rgb(54,56,56); color: #fff; border-color: rgb(54,56,56); }

.btn-outline-primary.link-switch {
  background: transparent !important;
  color: rgb(57,189,180) !important;
  border-color: rgb(57,189,180) !important;
}
.btn-outline-primary.link-switch:hover { background: rgb(57,189,180) !important; color: #fff !important; }

/* keep specific rows non-bold */
#grainRow th, #meatRow th { font-weight: normal; }

/* accessibility helper */
.sr-only {
  position: absolute !important;
  width: 1px; height: 1px;
  padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,0,0);
  white-space: nowrap; border: 0;
}

/* Mobile day selector dropdown */
#mobileDaySelector {
  display: none;
  margin: 0;
  padding: 0;
  width: 100%;
}

#mobileDaySelector .mobile-day-dropdown {
  width: 50%;
  padding: 10px 14px;
  font-size: 1.05rem;
  line-height: 1.25 !important;
  border-radius: 6px;
  background-color: rgba(34, 37, 41, 1) !important;
  color: #fff !important;
  border: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-weight: 600;
  text-align: left;
  cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23ffffff' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 18px;
  padding-right: 35px;
  padding-left: 10px;
}

#mobileDaySelector .mobile-day-dropdown:focus,
#mobileDaySelector .mobile-day-dropdown:hover {
  outline: none;
  background-color: rgba(34, 37, 41, 1) !important;
}

#mobileDaySelector .mobile-day-dropdown option {
  background-color: #272630;
  color: #fff;
  padding: 10px;
}

/* 3-dot menu button styling */
.mobile-menu-btn {
  background-color: rgba(34, 37, 41, 1) !important;
  color: #fff !important;
  border: none;
  border-radius: 6px;
  padding: 10px 15px;
  font-size: 1.2rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.mobile-menu-btn:hover {
  background-color: rgba(44, 47, 51, 1) !important;
}

/* Dropdown menu styling */
.mobile-menu-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 5px;
  background-color: rgba(34, 37, 41, 1);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  min-width: 180px;
  z-index: 1150;
  display: none;
  overflow: hidden;
}

.mobile-menu-dropdown.show {
  display: block;
}

.mobile-menu-dropdown button {
  display: block;
  width: 100%;
  padding: 12px 16px;
  background: transparent;
  border: none;
  color: #fff;
  text-align: left;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.mobile-menu-dropdown button:hover {
  background-color: rgba(57, 189, 180, 0.2);
}

.mobile-menu-dropdown button i {
  margin-right: 10px;
  width: 20px;
  text-align: center;
}

/* Desktop header actions (ellipsis dropdown) */
.weekly-header-container {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    gap: 10px;
    width: 100%;
    padding-right: 52px; /* reserve space for menu button */
}

.desktop-menu-wrapper {
    display: none;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1250;
}

/* Left-aligned header icon group (generate + save) */
.desktop-header-left {
    display: none;
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1250;
    gap: 8px;
    align-items: center;
}
.desktop-header-left .icon-btn {
    background: transparent;
    border: none;
    font-size: 18px;
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.desktop-header-left .icon-generate { color: rgb(57,189,180); }
.desktop-header-left .icon-save { color: rgb(228,218,79); }

.desktop-menu-btn {
    background: transparent;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.15s ease, color 0.15s ease;
}

.desktop-menu-btn:hover,
.desktop-menu-btn:focus {
    background-color: rgba(255, 255, 255, 0.12);
    outline: none;
}

.desktop-menu-dropdown {
    position: absolute;
    top: 110%;
    right: 0;
    background-color: rgba(34, 37, 41, 1);
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    min-width: 190px;
    z-index: 1260;
    display: none;
    overflow: hidden;
}

.desktop-menu-dropdown.show {
    display: block;
}

.desktop-menu-dropdown button {
    display: block;
    width: 100%;
    padding: 12px 16px;
    background: transparent;
    border: none;
    color: #fff;
    text-align: left;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.desktop-menu-dropdown button:hover,
.desktop-menu-dropdown button:focus {
    background-color: rgba(57, 189, 180, 0.2);
    outline: none;
}

.desktop-menu-dropdown button i {
    margin-right: 10px;
    width: 20px;
    text-align: center;
}

/* --- Print rules (replace entire block with this) --- */
@media print {
  /* Hide non-print UI */
  h1,
  .sb-topnav,
  .sb-sidenav-footer,
  .button-container,
  #generateMenuBtn,
  #saveMenuBtn,
  #mobileDaySelector,
    #mobileBottomNav,
    .desktop-menu-wrapper {
    display: none !important;
  }

  /* Page setup */
  @page {
    size: landscape;
    margin: 0.3in 0.25in;
  }

  body {
    margin: 0 !important;
    padding: 0 !important;
    width: auto !important;
    /* avoid clipping from fit-content */
  }

  /* Container must not clip */
  .container,
  #printableTable {
    overflow: visible !important;
    max-width: 100% !important;
    padding: 0 !important;
    margin: 0 auto !important;
  }

  /* Table sizing and borders */
  #weeklyMenuTable,
  .table {
    table-layout: fixed !important;
    width: 100% !important;
    /* was 200%, caused right edge cut */
    border-collapse: collapse !important;
  }

  /* Draw a definite left/right edge */
  #weeklyMenuTable {
    border-left: 1px solid #dee2e6 !important;
    border-right: 1px solid #dee2e6 !important;
  }

  #weeklyMenuTable th,
  #weeklyMenuTable td {
    border: 1px solid #dee2e6 !important;
    padding: 0.35rem 0.35rem !important;
    font-size: 0.8rem !important;
    line-height: 1.1 !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
  }

  /* Ensure the last column prints its right border */
  #weeklyMenuTable th:last-child,
  #weeklyMenuTable td:last-child {
    border-right: 1px solid #dee2e6 !important;
  }

  /* Keep all day columns visible even on mobile */
  #weeklyMenuTable [data-day] {
    display: table-cell !important;
  }

  /* Vertical header column: keep thin and vertical */
  #weeklyMenuTable col.vert-col {
    width: 24px !important;
  }

  #weeklyMenuTable td.vertical-header,
  #weeklyMenuTable th.vertical-header {
    writing-mode: vertical-rl !important;
    transform: rotate(180deg) !important;
    white-space: nowrap !important;
    box-sizing: border-box !important;
    width: 24px !important;
    min-width: 24px !important;
    max-width: 24px !important;
    padding: 2px 1px !important;
    text-align: center !important;
    font-weight: bold;
  }
}

/* =========================
   MOBILE (<=1000px)
   - hide H1 and top buttons
   - show day selector dropdown
   - show only selected day column
   ========================= */
@media (max-width: 1000px) {
    .desktop-menu-wrapper { display: none !important; }
  /* hide header + top button area */
  h1.mt-4,
  .top-button-row,
  #printableTable > form .mb-3 {
    display: none !important;
  }

  /* Prevent horizontal scrolling and hide scrollbars */
  html, body {
    overflow-x: hidden !important;
    max-width: 100vw !important;
  }

  /* Hide vertical scrollbar but allow scrolling */
  body {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  body::-webkit-scrollbar {
    display: none;
  }

  /* Hide entire table header (thead) on mobile */
  .table thead {
    display: none !important;
  }

  /* Remove container margins on mobile */
  .container {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    max-width: 100% !important;
  }

  #printableTable {
    margin: 0 !important;
    margin-left: -25px !important;
    padding: 0 !important;
    width: 100% !important;
  }

  table tbody {
    background-color: #e8e8e8bd !important;
  }

  /* Show mobile day selector - full width, no margins */
  #mobileDaySelector {
    display: block !important;
    position: sticky;
    top: 56px;
    z-index: 1100;
    margin: 0 !important;
    margin-left: 25px !important;
    padding: 0 !important;
    width: 100vw !important;
    left: 0;
    right: 0;
  }

  /* Remove row margins */
  .row {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }

  /* COMPLETELY REMOVE the vertical section header cells from layout */
  .table tbody tr td.vertical-header {
    display: none !important;
  }

  /* EXCEPT AM Snack header - keep visible for toggle button */
  .table tbody tr td.vertical-header.am-snack-header {
    display: block !important;
    position: absolute;
    right: 8px;
    top: -1.25rem;
    width: auto;
    height: auto;
    padding: 0;
    border: none;
    background: transparent;
    z-index: 10;
  }

  .table tbody tr td.vertical-header.am-snack-header .am-snack-text {
    display: none;
  }

  /* Force table to use 2-column layout on mobile by targeting the rows */
  .table tbody tr {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    width: 100% !important;
    margin-left: -4px !important;
  }

  /* Make sure all visible cells take up their grid space */
  .table tbody tr td:not(.vertical-header) {
    display: block !important;
  }

  /* Create horizontal section headers using ::before */
  .table tbody tr:nth-child(1)::before {
    content: 'Breakfast';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(1) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* AM Snack section */
  .table tbody tr:nth-child(5)::before {
    content: 'AM Snack';
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }
    /* When AM Snack is hidden, add a small gap under the header and remove cell borders */
    .table tbody tr.am-snack-row.am-hidden::after {
        content: '';
        display: block;
        height: 8px; /* gap below header bar only when hidden */
    }
    .table tbody tr.am-snack-row.am-hidden td,
    .table tbody tr.am-snack-row.am-hidden th {
        border: none !important; /* avoid stray gridline under header when hidden */
    }

  .table tbody tr:nth-child(5) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* Lunch section */
  .table tbody tr:nth-child(9)::before {
    content: 'Lunch';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(9) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* PM Snack section */
  .table tbody tr:nth-child(16)::before {
    content: 'PM Snack';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -1.5rem;
    background-color: rgba(34, 37, 41, 1);
    color: #fff;
    font-weight: bold;
    text-align: center;
    padding: 0.25rem;
    border: 1px solid #dee2e6;
    z-index: 1;
    grid-column: 1 / -1;
  }

  .table tbody tr:nth-child(16) {
    position: relative;
    margin-top: 1.5rem;
  }

  /* Remove top margin from table row on mobile */
  .row.mt-3 {
    margin-top: 0 !important;
  }

  #mobileDaySelector .mobile-day-dropdown {
    border-radius: 0 !important;
    margin: 0 !important;
    width: 50% !important;
  }

  /* Remove col padding */
  .col {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  /* compact table for mobile */
  .table { 
    box-shadow: none; 
    border-radius: 6px;
    margin-top: 0 !important;
  }
  
  th, td { 
    padding: .5rem; 
    font-size: .95rem;
  }

  /* Hide ALL day columns by default in mobile */
  .table thead tr th[data-day],
  .table tbody tr td[data-day],
  .table tbody tr th[data-day] {
    display: none !important;
  }

  /* Show ONLY selected day */
  .table thead tr th.mobile-show-day,
  .table tbody tr td.mobile-show-day,
  .table tbody tr th.mobile-show-day {
    display: block !important;
  }

  /* Adjust header colspan for mobile */
  #weeklyMenuHeader {
    display: table-cell !important;
  }

  /* make space for fixed mobile nav */
  body { padding-bottom: 100px !important; }

  /* ensure mobile bottom nav isn't accidentally hidden */
  #mobileBottomNav { z-index: 1200; }

  /* minor button tweaks for mobile nav */
  #mobileBottomNav .btn { background: transparent; border: none; padding: 6px 8px; color: #fff; }

  /* AM Snack toggle button - only visible on mobile */
  .am-snack-toggle-btn {
    display: flex !important;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    padding: 0;
    margin: 0;
    background: rgba(34, 37, 41, 1);
    border: none;
    border-radius: 3px;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .am-snack-toggle-btn:hover {
    background: rgba(44, 47, 51, 1);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .am-snack-toggle-btn:active {
    background: rgba(24, 27, 31, 1);
  }

  .am-snack-toggle-btn i {
    transition: transform 0.2s ease;
  }
}
/* =========================
   DESKTOP (>=1001px)
   - show H1 and top buttons
   - show all columns
   - hide day selector
   ========================= */
@media (min-width: 1001px) {

  .top-button-row,
    #printableTable > form .mb-3 {
        display: none !important; /* hide top row on desktop; header icons used instead */
    }

  #mobileDaySelector {
    display: none !important;
  }

  /* Hide mobile bottom navigation on desktop */
  #mobileBottomNav {
    display: none !important;
  }

    .desktop-menu-wrapper {
        display: flex !important;
        align-items: center;
    }

  body { padding-bottom: 0; }
  .table thead th, .table tbody td { font-size: 1rem; }
  
  /* Ensure all columns are visible on desktop */
  .table thead tr th,
  .table tbody tr td,
  .table tbody tr th {
    display: table-cell !important;
  }

    /* Show legend only on desktop */
    .rules-legend { display: flex !important; }

    /* show left header icons on desktop */
    .desktop-header-left { display: flex !important; }

#weeklyMenuHeader + h1,
h1.mt-4 {
    margin-top: 1.55rem !important;
    margin-bottom: 0 !important;
}

/* keep a small gap between the h1 and the printable container/table */
#printableTable {
    margin-top: 0.75rem !important;
    padding-top: 0 !important;
}

/* pull the table left to match the saved-legend placement (compensate base table margin-left) */
#weeklyMenuTable {
    margin-left: 0px !important;
    margin-right: 12px !important;
}

.rules-legend,
#rulesLegend {
    margin-top: 0.5rem !important;
    margin-bottom: 0.25rem !important;
}

.container#printableTable .row.mt-3 {
    margin-top: 0 !important;
}
}



/* =========================
     Loading Overlay
     - Full-screen dark cover with spinner
     - Prevents interaction and hides in-progress changes
     ========================= */
#loadingOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(4px) saturate(0.9);
    z-index: 1400;
    display: none; /* toggled to flex when visible */
    align-items: center;
    justify-content: center;
}
/* =========================
   Rules Legend Styles
   - Hidden by default; shown on desktop (>1000px)
   ========================= */
.rules-legend {
    display: none; /* default hidden, shown via media query */
    flex-wrap: wrap;
    gap: 10px 14px;
    align-items: center;
    margin: 12px 0 8px 0;
}
.legend-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(0,0,0,0.04);
}
.legend-swatch {
    width: 28px;
    height: 14px;
    border-radius: 6px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
}
.legend-label {
    font-size: 0.95rem;
    font-weight: 600;
}

@media print {
    .rules-legend { display: none !important; }
}

.loading-dialog {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 28px;
    border-radius: 10px;
    background: rgba(34, 37, 41, 0.9);
    color: #fff;
    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
}

.loading-spinner {
    width: 48px; height: 48px;
    border: 4px solid rgba(255,255,255,0.25);
    border-top-color: #39bdb4; /* accent */
    border-radius: 50%;
    animation: spin 0.9s linear infinite;
    margin-bottom: 12px;
}

.loading-text {
    font-weight: 600;
    letter-spacing: 0.2px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Dim and slightly blur the background content while loading */
.loading-active #printableTable,
.loading-active .container {
    filter: blur(2px) brightness(0.6) saturate(0.9);
    transition: filter 160ms ease;
}

</style>
{% endblock %}

{% block content %}
<h1 class="mt-4">Weekly Menu</h1>
        <!-- Loading Overlay -->
        <div id="loadingOverlay" aria-hidden="true">
            <div class="loading-dialog" role="alert" aria-live="assertive">
                <div class="loading-spinner" aria-hidden="true"></div>
                <div class="loading-text" id="loadingOverlayText">Generating menu…</div>
            </div>
        </div>
        <div class="container mt-5" id="printableTable">
            <form onsubmit="event.preventDefault(); checkMenuExistsAndSave();" id="menuForm"> <!-- Start of the form -->
                <div class="row">
                    <div class="col">
                        <div class="mb-3">
                            <button id="generateMenuBtn" class="btn btn-primaryoff mr-2" type="button">Generate Menu</button>
                            <button id="saveMenuBtn" type="submit" class="btn btn-secondary">Save</button> <!-- Button type set to submit -->
                            <button type="button" class="btn btn-outline-primary link-switch" style="margin-left: 10px;" onclick="openInventoryWindow()">
                            Inventory
                        </button>
                        </div>
                        
                    </div>
                </div>

                <!-- Desktop-only Rule Legend (color gradients → rule labels) -->
                <div id="rulesLegend" class="rules-legend" aria-label="Rule legend" role="list">
                    <a href="{% url 'past_menus' %}" class="saved-menus-icon" title="Saved Menus" aria-label="Saved Menus" style="font-size:18px; color: rgb(57,189,180); text-decoration:none; display:inline-flex; align-items:center; margin-left:6px; margin-right:12px;">
                        <i class="fas fa-folder-open" aria-hidden="true"></i>
                    </a>
                </div>

               <!-- Mobile Day Selector -->
<div id="mobileDaySelector">
    <div style="display: flex; justify-content: space-between; align-items: center; background-color: rgba(34, 37, 41, 1); padding: 10px;">
        <select id="daySelect" aria-label="Select day of week" class="mobile-day-dropdown">
            <option value="monday">Monday</option>
            <option value="tuesday">Tuesday</option>
            <option value="wednesday">Wednesday</option>
            <option value="thursday">Thursday</option>
            <option value="friday">Friday</option>
        </select>
        <div style="position: relative;">
            <button type="button" id="mobileMenuBtn" class="mobile-menu-btn" title="Menu" aria-label="Menu Options">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <div id="mobileMenuDropdown" class="mobile-menu-dropdown">
                <button type="button" id="generatePDFBtnMobile">
                    <i class="fas fa-file-pdf"></i>Generate PDF
                </button>
                <button type="button" id="editDatesBtnMobile" title="Edit week dates">
                    <i class="fas fa-calendar-alt"></i>Edit Dates
                </button>
                <button type="button" id="exportWeeklyMenuCSVMobile">
                <i class="fas fa-file-csv"></i>Export Menu
                </button>
            </div>
        </div>
    </div>
</div>

                <div class="row mt-3">
                    <div class="col">
                        <table id="weeklyMenuTable" class="table">
  <colgroup>
    <col class="vert-col" style="width:24px">
    <col />
    <col />
    <col />
    <col />
    <col />
    <col />
  </colgroup>
  <thead>
                        <tr>
                            <th id="weeklyMenuHeader" scope="col" colspan="7" style="text-align: center;">
                                <div class="weekly-header-container">
                                    <div class="desktop-header-left" aria-hidden="false">
                                        <button type="button" id="headerGenerateBtn" class="icon-btn icon-generate" title="Generate Menu" aria-label="Generate Menu" onclick="document.getElementById('generateMenuBtn').click();">
                                            <i class="fas fa-sync-alt" aria-hidden="true"></i>
                                        </button>
                                        <button type="button" id="headerSaveBtn" class="icon-btn icon-save" title="Save Menu" aria-label="Save Menu" onclick="document.getElementById('saveMenuBtn').click();">
                                            <i class="fas fa-save" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                    <span class="weekly-header-title">Weekly Menu: Date - Date</span>
                                    <div class="desktop-menu-wrapper" aria-label="Menu" role="group">
                                        <button type="button" id="desktopMenuBtn" class="desktop-menu-btn" title="Menu" aria-label="Menu Options">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div id="desktopMenuDropdown" class="desktop-menu-dropdown" aria-hidden="true">
                                            <button type="button" id="generatePDFBtn">
                                                <i class="fas fa-file-pdf"></i>Generate PDF
                                            </button>
                                            <button type="button" id="exportWeeklyMenuCSV">
                                                <i class="fas fa-file-csv"></i>Export Menu
                                            </button>
                                            <button type="button" id="editDatesBtn" title="Edit week dates">
                                                <i class="fas fa-calendar-alt"></i>Edit Dates
                                            </button>
                                            <button type="button" id="openInventoryBtn" onclick="openInventoryWindow()" title="Inventory">
                                                <i class="fas fa-box"></i>Inventory
                                            </button>
                                            <button type="button" id="toggleAMSnackDesktopBtn">
                                                <i class="fas fa-utensils"></i>Toggle AM Snack
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    <tr>
                        <th scope="col" colspan="2">Facility: {{ facility_name }}</th>
                        <th scope="col" style="text-align: center;" data-day="monday">Monday</th>
                        <th scope="col" style="text-align: center;" data-day="tuesday">Tuesday</th>
                        <th scope="col" style="text-align: center;" data-day="wednesday">Wednesday</th>
                        <th scope="col" style="text-align: center;" data-day="thursday">Thursday</th>
                        <th scope="col" style="text-align: center;" data-day="friday">Friday</th>
                    </tr>
                    <tr>
                        <th scope="col" colspan="2">Sponsor: {{ sponsor_name }}</th>
                        <th scope="col" style="text-align: center;" data-day="monday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="tuesday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="wednesday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="thursday"><span class="weekday-date"></span></th>
                        <th scope="col" style="text-align: center;" data-day="friday"><span class="weekday-date"></span></th>
                    </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">Breakfast</td>
                            <td>Fluid Milk</td>
                            <td id="mondayMilk" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayMilk" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayMilk" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayMilk" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayMilk" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayadd1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayadd1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayadd1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayadd1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr class="am-snack-row">
                            <td class="vertical-header am-snack-header" rowspan="4" style="font-weight: bold; text-align: center;">
                                <span class="am-snack-text">AM Snack</span>
                                <button type="button" id="amSnackToggleBtn" class="am-snack-toggle-btn" onclick="toggleAMSnackMobile()" aria-label="Toggle AM Snack section">
                                    <i class="fas fa-plus" id="amSnackToggleIcon"></i>
                                </button>
                            </td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaychoose1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaychoose1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaychoose1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaychoose1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr class="am-snack-row">
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr class="am-snack-row">
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr class="am-snack-row">
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat1" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaymeat1" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaymeat1" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaymeat1" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaymeat1" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td class="vertical-header" rowspan="7" style="font-weight: bold; text-align: center;">Lunch</td>
                            <td>Main Dish</td>
                            <td id="mondayMeals" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayMeals" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayMeals" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayMeals" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayMeals" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fluid Milk</td>
                            <td id="mondayLunchMilk" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayLunchMilk" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayLunchMilk" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayLunchMilk" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayLunchMilk" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Vegetable</td>
                            <td id="mondayvege" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayvege" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayvege" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayvege" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayvege" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit</td>
                            <td id="mondayfruit3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr id="grainRow">
                            <th scope="col">Grain</th>
                            <th id="mondayGrain" style="text-align: center;" data-day="monday"></th>
                            <th id="tuesdayGrain" style="text-align: center;" data-day="tuesday"></th>
                            <th id="wednesdayGrain" style="text-align: center;" data-day="wednesday"></th>
                            <th id="thursdayGrain" style="text-align: center;" data-day="thursday"></th>
                            <th id="fridayGrain" style="text-align: center;" data-day="friday"></th>
                        </tr>
                        <tr id="meatRow">
                            <th scope="col">Meat or Meat Alternate</th>
                            <th id="mondayMeatAlternate" style="text-align: center;" data-day="monday"></th>
                            <th id="tuesdayMeatAlternate" style="text-align: center;" data-day="tuesday"></th>
                            <th id="wednesdayMeatAlternate" style="text-align: center;" data-day="wednesday"></th>
                            <th id="thursdayMeatAlternate" style="text-align: center;" data-day="thursday"></th>
                            <th id="fridayMeatAlternate" style="text-align: center;" data-day="friday"></th>
                        </tr>
                        <tr>
                            <td>Additional Food (Optional)</td>
                            <td id="mondayadd2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayadd2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayadd2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayadd2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayadd2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr> 
                            <td class="vertical-header" rowspan="4" style="font-weight: bold; text-align: center;">PM Snack</td>
                            <td>Choose 2 of these 5: Fluid Milk</td>
                            <td id="mondaychoose2" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaychoose2" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaychoose2" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaychoose2" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaychoose2" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Fruit, Vegetable, or Full Strength Juice</td>
                            <td id="mondayfruit4" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdayfruit4" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdayfruit4" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdayfruit4" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridayfruit4" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Bread or Bread Alternate(s)</td>
                            <td id="mondaybread3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaybread3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaybread3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaybread3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaybread3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                        <tr>
                            <td>Meat or Meat Alternate</td>
                            <td id="mondaymeat3" style="text-align: center;" data-day="monday"></td>
                            <td id="tuesdaymeat3" style="text-align: center;" data-day="tuesday"></td>
                            <td id="wednesdaymeat3" style="text-align: center;" data-day="wednesday"></td>
                            <td id="thursdaymeat3" style="text-align: center;" data-day="thursday"></td>
                            <td id="fridaymeat3" style="text-align: center;" data-day="friday"></td>
                        </tr>
                    </tbody>
                </table>
                <!-- MOBILE: fixed bottom navigation (visible only on small screens via CSS) -->
                <div id="mobileBottomNav" role="navigation" aria-label="Mobile actions">
                    
                    <a href="{% url 'past_menus' %}" class="btn btn-rec" title="Saved Menus" role="button">
                        <i class="fas fa-folder-open" aria-hidden="true"></i>
                        <span class="sr-only">Saved Menus</span>
                    </a>
                    <!-- Center circular update/save button (uses base_minimal .update-btn styles) -->
                    <button type="button" class="btn update-btn" onclick="document.getElementById('saveMenuBtn').click();" title="Save Menu">
                        <i class="fas fa-save" aria-hidden="true"></i>
                        <span class="sr-only">Save Menu</span>
                    </button>
                    <button type="button" class="btn btn-primaryoff" onclick="document.getElementById('generateMenuBtn').click();" title="Generate Menu">
                        <i class="fas fa-sync-alt" aria-hidden="true"></i>
                        <span class="sr-only">Generate Menu</span>
                    </button>
                   
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
{% block scripts %}
<script>
// On mobile, auto-hide AM Snack if no data in any AM Snack cell
document.addEventListener('DOMContentLoaded', function() {
    if (window.matchMedia('(max-width: 1000px)').matches) {
        // Only run on mobile
        if (!amSnackHasAnyData()) {
            // Only toggle off if not already hidden
            const firstRow = document.querySelector('#weeklyMenuTable tbody tr.am-snack-row');
            if (firstRow && !firstRow.classList.contains('am-hidden')) {
                toggleAMSnackMobile(false);
            }
        }
    }
});
/* Persist-in-progress weekly menu, robust generate handlers, WG filler (idempotent + dedupe), and full mapping to all table cells */

/* Local storage key */
const MENU_PROGRESS_KEY = "weeklyMenuProgress_v1";
const SELECTED_DAY_KEY = "selectedDay_v1";

/* Global cache for inventory rules (name → {gradient_start, gradient_end, text_color, rule_label?}) */
let inventoryRulesCache = null;

/* Default WG style if no server style is found */
const WG_DEFAULT_STYLE = {
    gradient_start: "rgba(153,158,158,0.25)",
    gradient_end: "rgba(57,189,180,0.18)",
    text_color: "#21201f",
    rule_label: "Whole Grain"
};

/* IDs of cells to color */
function getColorableCellIds() {
    return [
        'mondayMilk','tuesdayMilk','wednesdayMilk','thursdayMilk','fridayMilk',
        'mondayfruit','tuesdayfruit','wednesdayfruit','thursdayfruit','fridayfruit',
        'mondaybread','tuesdaybread','wednesdaybread','thursdaybread','fridaybread',
        'mondayadd1','tuesdayadd1','wednesdayadd1','thursdayadd1','fridayadd1',
        'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
        'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
        'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
        'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1',
        'mondayMeals','tuesdayMeals','wednesdayMeals','thursdayMeals','fridayMeals',
        'mondayLunchMilk','tuesdayLunchMilk','wednesdayLunchMilk','thursdayLunchMilk','fridayLunchMilk',
        'mondayvege','tuesdayvege','wednesdayvege','thursdayvege','fridayvege',
        'mondayfruit3','tuesdayfruit3','wednesdayfruit3','thursdayfruit3','fridayfruit3',
        'mondayGrain','tuesdayGrain','wednesdayGrain','thursdayGrain','fridayGrain',
        'mondayMeatAlternate','tuesdayMeatAlternate','wednesdayMeatAlternate','thursdayMeatAlternate','fridayMeatAlternate',
        'mondayadd2','tuesdayadd2','wednesdayadd2','thursdayadd2','fridayadd2',
        'mondaychoose2','tuesdaychoose2','wednesdaychoose2','thursdaychoose2','fridaychoose2',
        'mondayfruit4','tuesdayfruit4','wednesdayfruit4','thursdayfruit4','fridayfruit4',
        'mondaybread3','tuesdaybread3','wednesdaybread3','thursdaybread3','fridaybread3',
        'mondaymeat3','tuesdaymeat3','wednesdaymeat3','thursdaymeat3','fridaymeat3'
    ];
}

/* Clear all previous coloring and WG markers */
function clearAllMenuCellStyles() {
    const ids = getColorableCellIds();
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.background = '';
        el.style.color = '';
        el.dataset.ruleApplied = 'false';
        el.dataset.ruleLabel = '';
    });
}

/* AM Snack visibility helpers */
function getAMSnackCellIds() {
    return [
        'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
        'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
        'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
        'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1'
    ];
}
function amSnackHasAnyData() {
    const ids = getAMSnackCellIds();
    for (let i = 0; i < ids.length; i++) {
        const el = document.getElementById(ids[i]);
        if (el && el.innerText.trim().length > 0) return true;
    }
    return false;
}
// Only auto-hide AM Snack if toggled off, not if empty
function toggleAMSnackVisibility() {
    const rows = Array.from(document.querySelectorAll('#weeklyMenuTable tbody tr.am-snack-row'));
    if (rows.length === 0) return;

    const firstRow = rows[0];
    const otherRows = rows.slice(1);
    const isDesktop = window.matchMedia('(min-width: 1001px)').matches;

    // Always show if visible, regardless of data
    if (!firstRow.classList.contains('am-hidden')) {
        rows.forEach(r => r.style.removeProperty('display'));
        firstRow.querySelectorAll('td, th').forEach(cell => {
            try { cell.style.removeProperty('display'); } catch(e) {}
        });
        firstRow.classList.remove('am-hidden');
        updateAMSnackToggleIcon();
        return;
    }

    // If hidden, keep hidden
    if (isDesktop) {
        rows.forEach(row => {
            try { row.style.setProperty('display', 'none', 'important'); }
            catch(e) { row.style.display = 'none'; }
        });
        firstRow.classList.add('am-hidden');
    } else {
        try { firstRow.style.removeProperty('display'); } catch(e) {}
        firstRow.querySelectorAll('td:not(.vertical-header), th:not(.vertical-header)').forEach(cell => {
            try { cell.style.setProperty('display', 'none', 'important'); }
            catch(e) { cell.style.display = 'none'; }
        });
        firstRow.classList.add('am-hidden');
        otherRows.forEach(row => {
            try { row.style.setProperty('display', 'none', 'important'); }
            catch(e) { row.style.display = 'none'; }
        });
    }
    updateAMSnackToggleIcon();
}

// Mobile and desktop toggle for AM Snack section
function toggleAMSnackMobile(forceShow) {
    const rows = Array.from(document.querySelectorAll('#weeklyMenuTable tbody tr.am-snack-row'));
    if (rows.length === 0) return;

    const firstRow = rows[0];
    const otherRows = rows.slice(1);
    const isDesktop = window.matchMedia('(min-width: 1001px)').matches;
    let isCurrentlyHidden;
    if (isDesktop) {
        // On desktop, treat hidden if any row is hidden
        isCurrentlyHidden = rows.every(row => row.style.display === 'none' || row.style.display === 'none!important');
    } else {
        isCurrentlyHidden = firstRow.classList.contains('am-hidden');
    }

    const shouldShow = typeof forceShow === 'boolean' ? forceShow : isCurrentlyHidden;

    if (shouldShow) {
        // Show AM Snack content (all rows and vertical header)
        rows.forEach(r => r.style.removeProperty('display'));
        firstRow.querySelectorAll('td, th').forEach(cell => {
            try { cell.style.removeProperty('display'); } catch(e) {}
        });
        firstRow.classList.remove('am-hidden');
    } else {
        if (isDesktop) {
            // Hide entire AM Snack section including vertical header
            rows.forEach(row => {
                try { row.style.setProperty('display', 'none', 'important'); }
                catch(e) { row.style.display = 'none'; }
            });
        } else {
            // Hide AM Snack content (keep header visible)
            try { firstRow.style.removeProperty('display'); } catch(e) {}
            firstRow.querySelectorAll('td:not(.vertical-header), th:not(.vertical-header)').forEach(cell => {
                try { cell.style.setProperty('display', 'none', 'important'); }
                catch(e) { cell.style.display = 'none'; }
            });
            firstRow.classList.add('am-hidden');
            otherRows.forEach(row => {
                try { row.style.setProperty('display', 'none', 'important'); }
                catch(e) { row.style.display = 'none'; }
            });
        }
    }
    // Update toggle button icon
    updateAMSnackToggleIcon();
}

/* Update toggle button icon based on visibility state */
function updateAMSnackToggleIcon() {
    const toggleIcon = document.getElementById('amSnackToggleIcon');
    if (!toggleIcon) return;

    const firstRow = document.querySelector('#weeklyMenuTable tbody tr.am-snack-row');
    if (!firstRow) return;

    const isHidden = firstRow.classList.contains('am-hidden');
    toggleIcon.className = isHidden ? 'fas fa-plus' : 'fas fa-minus';
}

/* Helpers */
const DAYS = ["monday","tuesday","wednesday","thursday","friday"];
const DAY_FULL = ["Monday","Tuesday","Wednesday","Thursday","Friday"];
const WG_NAME_RX = /\b(wg|ww|whole\s*grain|whole\s*wheat)\b/i;
const norm = s => (s || "").toLowerCase().replace(/\s+/g, " ").trim();

/* Fetch inventory rules from server */
async function fetchInventoryRules() {
    if (inventoryRulesCache) return inventoryRulesCache;
    try {
        const response = await fetch('/api/fetch_inventory_rules/', {
            method: 'GET',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        const data = await response.json();
        inventoryRulesCache = data.item_rules || {};
        return inventoryRulesCache;
    } catch (error) {
        console.error('Error fetching inventory rules:', error);
        return {};
    }
}

/* Fetch WG candidates [(name, flags, style)] */
async function fetchWGCandidates() {
    try {
        const res = await fetch('/api/get_wg_candidates/', {
            method: 'GET',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        const data = await res.json();
        const weekly_qty = data.weekly_qty || 0;
        const candidates = Array.isArray(data.candidates) ? data.candidates : [];
        return { weekly_qty, candidates };
    } catch (e) {
        console.warn('get_wg_candidates failed', e);
        return { weekly_qty: 0, candidates: [] };
    }
}

/* Does text look like Whole Grain (by name) */
function isWGText(text) { return WG_NAME_RX.test(text || ""); }

/* Apply gradient styling to cells based on inventory rules (and mark WG by rule_label or name) */
async function applyGradientsToCells() {
    const itemRules = await fetchInventoryRules();
    // Try to fetch rules list (for assigned rule ids)
    let ruleList = null;
    try {
        const rr = await fetch('/api/list_rules/', { method: 'GET', headers: { 'X-CSRFToken': getCookie('csrftoken') }});
        const rdata = await rr.json();
        ruleList = Array.isArray(rdata) ? rdata : (rdata.rules || []);
    } catch (e) { ruleList = null; }

    // Always start from a clean slate
    clearAllMenuCellStyles();

    const cellIds = getColorableCellIds();
    let matchCount = 0;

    cellIds.forEach(cellId => {
        const cell = document.getElementById(cellId);
        if (!cell) return;
        const text = cell.innerText.trim();
        // If a rule id is assigned to this cell, prefer that rule's styles
        if (cell.dataset && cell.dataset.ruleId) {
            if (ruleList) {
                const assignedRule = ruleList.find(r => String(r.id) === String(cell.dataset.ruleId));
                if (assignedRule) {
                    const gs = assignedRule.gradient_start || WG_DEFAULT_STYLE.gradient_start;
                    const ge = assignedRule.gradient_end || WG_DEFAULT_STYLE.gradient_end;
                    const tc = assignedRule.text_color || WG_DEFAULT_STYLE.text_color;
                    cell.style.background = `linear-gradient(135deg, ${gs}, ${ge})`;
                    cell.style.color = tc;
                    cell.dataset.ruleApplied = 'true';
                    cell.dataset.ruleLabel = assignedRule.rule || assignedRule.rule_label || '';
                    matchCount++;
                    return;
                }
            }
        }
        if (!text) return;

        const rule = itemRules[text];
        if (rule) {
            cell.style.background = `linear-gradient(135deg, ${rule.gradient_start}, ${rule.gradient_end})`;
            cell.style.color = rule.text_color;
            cell.dataset.ruleApplied = 'true';
            if (rule.rule_label) cell.dataset.ruleLabel = rule.rule_label;
            matchCount++;
        } else if (/\b(wg|ww|whole\s*grain|whole\s*wheat)\b/i.test(text)) {
            const s = WG_DEFAULT_STYLE;
            cell.style.background = `linear-gradient(135deg, ${s.gradient_start}, ${s.gradient_end})`;
            cell.style.color = s.text_color;
            cell.dataset.ruleApplied = 'true';
            cell.dataset.ruleLabel = 'Whole Grain';
        }
    });

    // Build/rebuild legend after rules are available
    try { await buildRulesLegendFromCache(); } catch(e) { console.warn('legend build failed', e); }
}

/* Clear inventory rules cache (useful when rules are updated) */
function clearInventoryRulesCache() { inventoryRulesCache = null; }

/* Save/restore helpers */
function saveMenuProgressToLocalStorage() {
    try {
        const menu = {};
        const ids = [
            'mondayMilk','tuesdayMilk','wednesdayMilk','thursdayMilk','fridayMilk',
            'mondayfruit','tuesdayfruit','wednesdayfruit','thursdayfruit','fridayfruit',
            'mondaybread','tuesdaybread','wednesdaybread','thursdaybread','fridaybread',
            'mondayadd1','tuesdayadd1','wednesdayadd1','thursdayadd1','fridayadd1',
            'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
            'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
            'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
            'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1',
            'mondayMeals','tuesdayMeals','wednesdayMeals','thursdayMeals','fridayMeals',
            'mondayLunchMilk','tuesdayLunchMilk','wednesdayLunchMilk','thursdayLunchMilk','fridayLunchMilk',
            'mondayvege','tuesdayvege','wednesdayvege','thursdayvege','fridayvege',
            'mondayfruit3','tuesdayfruit3','wednesdayfruit3','thursdayfruit3','fridayfruit3',
            'mondayGrain','tuesdayGrain','wednesdayGrain','thursdayGrain','fridayGrain',
            'mondayMeatAlternate','tuesdayMeatAlternate','wednesdayMeatAlternate','thursdayMeatAlternate','fridayMeatAlternate',
            'mondayadd2','tuesdayadd2','wednesdayadd2','thursdayadd2','fridayadd2',
            'mondaychoose2','tuesdaychoose2','wednesdaychoose2','thursdaychoose2','fridaychoose2',
            'mondayfruit4','tuesdayfruit4','wednesdayfruit4','thursdayfruit4','fridayfruit4',
            'mondaybread3','tuesdaybread3','wednesdaybread3','thursdaybread3','fridaybread3',
            'mondaymeat3','tuesdaymeat3','wednesdaymeat3','thursdaymeat3','fridaymeat3'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) menu[id] = el.innerText;
        });
        // persist assigned rule ids (cellId -> ruleId)
        try {
            const assigned = {};
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.dataset && el.dataset.ruleId) assigned[id] = el.dataset.ruleId;
            });
            if (Object.keys(assigned).length) menu.assigned_rules = assigned;
        } catch(e) { /* ignore */ }
        const headerTitleEl = document.querySelector('.weekly-header-title');
        if (headerTitleEl) menu.weeklyMenuHeader = headerTitleEl.innerText;
        const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText);
        menu.weekdayDates = dates;
        localStorage.setItem(MENU_PROGRESS_KEY, JSON.stringify(menu));
    } catch (err) { console.warn('saveMenuProgress failed', err); }
}

function restoreMenuProgressFromLocalStorage() {
    try {
        const raw = localStorage.getItem(MENU_PROGRESS_KEY);
        if (!raw) return;
        const menu = JSON.parse(raw);
        if (!menu) return;
        Object.entries(menu).forEach(([k, v]) => {
            if (k === 'weeklyMenuHeader') {
                const hTitle = document.querySelector('.weekly-header-title');
                if (hTitle) hTitle.innerText = v;
                const match = v.match(/Weekly Menu: (\d{2})\/(\d{2})/);
                if (match) {
                    const month = parseInt(match[1]) - 1;
                    const day = parseInt(match[2]);
                    const year = new Date().getFullYear();
                    const restoredDate = new Date(year, month, day);
                    if (restoredDate < new Date()) restoredDate.setFullYear(year + 1);
                    window.nextMondayDate = restoredDate;
                }
            } else if (k === 'weekdayDates' && Array.isArray(v)) {
                document.querySelectorAll('.weekday-date').forEach((el, i) => { if (v[i]) el.innerText = v[i]; });
            } else {
                const el = document.getElementById(k);
                if (el) el.innerText = v;
            }
        });
        // If assigned_rules were saved, restore them and apply styles from rules endpoint
        if (menu.assigned_rules && typeof menu.assigned_rules === 'object') {
            fetch('/api/list_rules/', { method: 'GET', headers: { 'X-CSRFToken': getCookie('csrftoken') }})
                .then(r => r.json())
                .then(data => {
                    const rules = Array.isArray(data) ? data : (data.rules || []);
                    Object.entries(menu.assigned_rules).forEach(([cellId, ruleId]) => {
                        const el = document.getElementById(cellId);
                        if (!el) return;
                        el.dataset.ruleId = ruleId;
                        const r = rules.find(rr => String(rr.id) === String(ruleId));
                        if (r) {
                            el.dataset.ruleLabel = r.rule || r.rule_label || '';
                            const gs = r.gradient_start || WG_DEFAULT_STYLE.gradient_start;
                            const ge = r.gradient_end || WG_DEFAULT_STYLE.gradient_end;
                            const tc = r.text_color || WG_DEFAULT_STYLE.text_color;
                            el.style.background = `linear-gradient(135deg, ${gs}, ${ge})`;
                            el.style.color = tc;
                            el.dataset.ruleApplied = 'true';
                        }
                    });
                })
                .catch(e => { console.warn('restoreMenu: failed to fetch rules', e); })
                .finally(() => {
                    setTimeout(() => applyGradientsToCells(), 200);
                    setTimeout(() => ensureDailyWG(), 400);
                    setTimeout(() => toggleAMSnackVisibility(), 500);
                });
        } else {
            setTimeout(() => applyGradientsToCells(), 200);
            setTimeout(() => ensureDailyWG(), 400);
            setTimeout(() => toggleAMSnackVisibility(), 500);
        }
    } catch (err) { console.warn('restoreMenuProgress failed', err); }
}

function clearMenuProgressFromLocalStorage() { localStorage.removeItem(MENU_PROGRESS_KEY); }

/* Mobile day selector functionality */
function showSelectedDay(selectedDay) {
    document.querySelectorAll('[data-day]').forEach(el => el.classList.remove('mobile-show-day'));
    document.querySelectorAll(`[data-day="${selectedDay}"]`).forEach(el => el.classList.add('mobile-show-day'));
    try { localStorage.setItem(SELECTED_DAY_KEY, selectedDay); } catch (err) {}
}
function initializeDaySelector() {
    const daySelect = document.getElementById('daySelect');
    if (!daySelect) return;
    let savedDay = 'monday';
    try { savedDay = localStorage.getItem(SELECTED_DAY_KEY) || 'monday'; } catch {}
    daySelect.value = savedDay;
    showSelectedDay(savedDay);
    daySelect.addEventListener('change', function(){ showSelectedDay(this.value); });
}

/* Generic safe setter */
function safeSetText(id, text) { const el = document.getElementById(id); if (!el) return; el.innerText = text == null ? '' : String(text); }

/* Minimal mapping for common server keys */
const KEY_ID_MAP = {
    'meal_name': '{day}Meals', 'main_dish': '{day}Meals', 'lunch_main_dish': '{day}Meals',
    'grain': '{day}Grain',
    'meat_alternate': '{day}MeatAlternate', 'meat': '{day}MeatAlternate',
    'lunch_milk': '{day}LunchMilk', 'fluid_milk': '{day}Milk',
    'bread': '{day}bread', 'add1': '{day}add1',
    'choose1': '{day}choose1', 'fruit2': '{day}fruit2', 'bread2':'{day}bread2', 'meat1':'{day}meat1',
    'choose2': '{day}choose2', 'fruit4': '{day}fruit4', 'bread3':'{day}bread3', 'meat3':'{day}meat3',
    'fruit': '{day}fruit', 'fruit3':'{day}fruit3',
    'vegetable': '{day}vege', 'add2':'{day}add2'
};
function dayPrefix(day){ return day.toLowerCase(); }
function applyResponseToDay(day, payload) {
    if (!payload || typeof payload !== 'object') return;
    const prefix = dayPrefix(day);
    Object.entries(payload).forEach(([k, v]) => {
        if (v == null) v = '';
        let template = KEY_ID_MAP[k] || KEY_ID_MAP[k.toLowerCase()];
        if (template) { safeSetText(template.replace('{day}', prefix), v); return; }
        if (typeof v === 'object') {
            Object.entries(v).forEach(([subk, subv]) => {
                let t = KEY_ID_MAP[subk] || KEY_ID_MAP[subk.toLowerCase()];
                if (t) safeSetText(t.replace('{day}', prefix), subv);
            });
            return;
        }
        const fallbackId = prefix + k.charAt(0).toUpperCase() + k.slice(1);
        if (document.getElementById(fallbackId)) safeSetText(fallbackId, v);
        else {
            const fallback2 = prefix + k.toLowerCase();
            if (document.getElementById(fallback2)) safeSetText(fallback2, v);
        }
    });
}
function populateFromResponse(response) {
    if (!response) return;
    ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(day => { if (response[day]) applyResponseToDay(day, response[day]); });
}

/* Editable support */
function makeEditable(el) {
    if (!el || el.dataset.editable === 'true') return;
    el.dataset.editable = 'true';
    el.addEventListener('click', function () {
        const current = el.innerText.trim();
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'input-box form-control';
        input.value = current;
        el.innerText = '';
        el.appendChild(input);
        input.focus();
        input.addEventListener('blur', function () {
            el.innerText = input.value.trim();
            saveMenuProgressToLocalStorage();
            applyGradientsToCells();
            ensureDailyWG(); // WG check after manual edits
        });
        input.addEventListener('keydown', function (e) { if (e.key === 'Enter') input.blur(); });
    });
}
function enableEditablesForAllCells() {
    const els = Array.from(document.querySelectorAll('#weeklyMenuTable td, #weeklyMenuTable th'));
    els.forEach(el => { if (el.id && el.id !== 'weeklyMenuHeader') makeEditable(el); });
}

/* Date helper */
function updateDates() {
    const today = new Date();
    const currentDayIndex = today.getDay();
    const daysUntilNextMonday = (currentDayIndex === 0) ? 1 : (8 - currentDayIndex);
    const nextMonday = new Date(today);
    nextMonday.setDate(today.getDate() + daysUntilNextMonday);
    const nextFriday = new Date(nextMonday);
    nextFriday.setDate(nextMonday.getDate() + 4);
    const startDateString = ('0' + (nextMonday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextMonday.getDate()).slice(-2);
    const endDateString = ('0' + (nextFriday.getMonth() + 1)).slice(-2) + '/' + ('0' + nextFriday.getDate()).slice(-2);
    const headerTitle = document.querySelector('.weekly-header-title');
    if (headerTitle) headerTitle.textContent = 'Weekly Menu: ' + startDateString + ' - ' + endDateString;
    $('.weekday-date').each(function(index) {
        const date = new Date(nextMonday);
        date.setDate(nextMonday.getDate() + index);
        const formattedDate = ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
        $(this).text(formattedDate);
    });
    window.nextMondayDate = nextMonday;
    updateDropdownWithDates();
}

/* Update dropdown options with dates */
function updateDropdownWithDates() {
    const daySelect = document.getElementById('daySelect');
    if (!daySelect) return;
    const dates = Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText.trim());
    DAYS.forEach((day, index) => {
        const option = daySelect.querySelector(`option[value="${day}"]`);
        if (option && dates[index]) option.textContent = `${DAY_FULL[index]} (${dates[index]})`;
    });
}

/* WG filler: ensure each day has at least one WG somewhere; place in allowed slots, dedupe, keep colors */
async function ensureDailyWG() {
    const { weekly_qty, candidates } = await fetchWGCandidates();
    if (!weekly_qty || !Array.isArray(candidates) || candidates.length === 0) return;

    const candidateNameSet = new Set(candidates.map(c => norm(c.name)));

    // Check if a day already has WG anywhere (by rule_label or name markers)
    function dayHasWG(day) {
        const cells = Array.from(document.querySelectorAll(`[data-day="${day}"]`));
        if (cells.some(el => el.dataset.ruleLabel === 'Whole Grain')) return true;
        return cells.some(el => {
            const parts = (el.innerText || '').split(';').map(p => norm(p));
            return parts.some(p => candidateNameSet.has(p) || isWGText(p));
        });
    }

    function pickCandidateFor(slot) {
        const pool = candidates.filter(c =>
            (slot === 'breakfast' && c.break_only) ||
            (slot === 'am' && c.am_only) ||
            (slot === 'lunch' && c.lunch_only) ||
            (slot === 'pm' && c.pm_only)
        );
        if (pool.length === 0) return null;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    let alreadyWG = DAYS.reduce((acc, d) => acc + (dayHasWG(d) ? 1 : 0), 0);
    let remaining = Math.max(0, weekly_qty - alreadyWG);
    if (remaining <= 0) return;

    for (const day of DAYS) {
        if (remaining <= 0) break;
        if (dayHasWG(day)) continue;

        // Preferred order: breakfast add1 → lunch add2 → am bread2 → pm bread3
        let cand = pickCandidateFor('breakfast'), targetId = cand ? `${day}add1` : null;
        if (!cand) { cand = pickCandidateFor('lunch'); if (cand) targetId = `${day}add2`; }
        if (!cand) { cand = pickCandidateFor('am');    if (cand) targetId = `${day}bread2`; }
        if (!cand) { cand = pickCandidateFor('pm');    if (cand) targetId = `${day}bread3`; }
        if (!cand || !targetId) continue;

        const cell = document.getElementById(targetId);
        if (!cell) continue;

        // Dedupe within the cell
        const existingParts = (cell.innerText || '').split(';').map(p => norm(p));
        if (existingParts.includes(norm(cand.name))) {
            // still tag/color
            const style = cand.style || WG_DEFAULT_STYLE;
            cell.dataset.ruleLabel = style.rule_label || 'Whole Grain';
            cell.style.background = `linear-gradient(135deg, ${style.gradient_start}, ${style.gradient_end})`;
            cell.style.color = style.text_color;
            continue;
        }

        // Place text (append if needed)
        const current = (cell.innerText || '').trim();
        cell.innerText = current ? `${current}; ${cand.name}` : cand.name;

        // Prime cache for coloring and color immediately
        inventoryRulesCache = inventoryRulesCache || {};
        if (cand.style) inventoryRulesCache[cand.name] = cand.style;

        const style = (inventoryRulesCache && inventoryRulesCache[cand.name]) || cand.style || WG_DEFAULT_STYLE;
        cell.style.background = `linear-gradient(135deg, ${style.gradient_start}, ${style.gradient_end})`;
        cell.style.color = style.text_color;
        cell.dataset.ruleApplied = 'true';
        cell.dataset.ruleLabel = style.rule_label || 'Whole Grain';

        remaining--;
    }

    // Re-apply gradients to unify appearance
    if (remaining < Math.max(0, weekly_qty - alreadyWG)) setTimeout(() => applyGradientsToCells(), 50);
}

/* CSRF helper */
function getCookie(name) {
    try {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    } catch (e) {}
    return '';
}

/* The table updaters used by AJAX success handlers */
function updateTable(response){
    populateFromResponse(response);
    DAYS.forEach(day => {
        safeSetText(day + 'Milk', '1% w.milk (unflavored)');
        safeSetText(day + 'LunchMilk', '1% w.milk (unflavored)');
    });
    {% if not use_inventory_selectors %}
    enableEditablesForAllCells();
    {% endif %}
}
function updateAMTable(response){ populateFromResponse(response); {% if not use_inventory_selectors %} enableEditablesForAllCells(); {% endif %} toggleAMSnackVisibility(); }
function updatePMTable(response){ populateFromResponse(response); {% if not use_inventory_selectors %} enableEditablesForAllCells(); {% endif %} }
function updateBreakfastTable(response){
    populateFromResponse(response);
    DAYS.forEach(day => { safeSetText(day + 'Milk', '1% w.milk (unflavored)'); });
    {% if not use_inventory_selectors %}
    enableEditablesForAllCells();
    {% endif %}
}
function updateFruitTable(response){ populateFromResponse(response); {% if not use_inventory_selectors %} enableEditablesForAllCells(); {% endif %} }
function updateVegetableTable(response){ populateFromResponse(response); {% if not use_inventory_selectors %} enableEditablesForAllCells(); {% endif %} }

/* Document ready: restore, attach handlers */

$(document).ready(function() {
    restoreMenuProgressFromLocalStorage();
    {% if not use_inventory_selectors %}
    enableEditablesForAllCells();
    {% endif %}
    initializeDaySelector();
    updateDropdownWithDates();
    // Initial legend build (in case rules are already cached server-side)
    setTimeout(() => { buildRulesLegendFromCache(); }, 100);
    // By default, hide AM Snack on desktop, show on mobile
    setTimeout(() => {
        if (window.matchMedia('(min-width: 1001px)').matches) {
            // On desktop: if any AM Snack field has data, show; else hide
            const rows = Array.from(document.querySelectorAll('#weeklyMenuTable tbody tr.am-snack-row'));
            const amSnackIds = [
                'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
                'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
                'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
                'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1'
            ];
            let hasData = false;
            for (let i = 0; i < amSnackIds.length; i++) {
                const el = document.getElementById(amSnackIds[i]);
                if (el && el.innerText.trim().length > 0) { hasData = true; break; }
            }
            if (rows.length) {
                if (hasData) {
                    rows.forEach(r => r.style.removeProperty('display'));
                    rows[0].classList.remove('am-hidden');
                } else {
                    rows.forEach(row => {
                        try { row.style.setProperty('display', 'none', 'important'); } catch(e) { row.style.display = 'none'; }
                    });
                    rows[0].classList.add('am-hidden');
                }
            }
        } else {
            toggleAMSnackVisibility();
        }
    }, 120);

    $('#generateMenuBtn').on('keydown keypress', function(e){ if (e.key === 'Enter' || e.keyCode === 13){ e.preventDefault(); return false; }});
    $('#menuForm').on('keydown keypress', function(e){
        if (e.key === 'Enter' || e.keyCode === 13){
            if (!$(e.target).is('#saveMenuBtn') && !$(e.target).hasClass('input-box')){ e.preventDefault(); return false; }
        }
    });
    $(document).on('blur', '.input-box', function(){ setTimeout(() => { saveMenuProgressToLocalStorage(); toggleAMSnackVisibility(); }, 80); });

    function ajaxPost(url) {
        return $.ajax({ url, type: 'POST', data: {}, beforeSend: function(xhr){ xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken')); } });
    }

    // Lightweight loading overlay controls
    function showLoading(text = 'Generating menu…') {
        const overlay = document.getElementById('loadingOverlay');
        const label = document.getElementById('loadingOverlayText');
        if (label) label.textContent = text;
        if (overlay) overlay.style.display = 'flex';
        document.body.setAttribute('aria-busy', 'true');
        document.body.classList.add('loading-active');
    }
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
        document.body.removeAttribute('aria-busy');
        document.body.classList.remove('loading-active');
    }

    $('#generateMenuBtn').off('click.simple').on('click.simple', function(e) {
        e.preventDefault();
        const $btn = $(this);
        $btn.prop('disabled', true).addClass('disabled');
        showLoading('Generating menu…');

        // Clear previous colors before regenerating
        clearAllMenuCellStyles();
        clearInventoryRulesCache();

        const calls = [
            ajaxPost('/generate_menu/').done(resp => updateTable(resp)).fail(() => toastr.error('Failed generating lunch menu')).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_am_menu/').done(resp => updateAMTable(resp)).fail(() => toastr.error('Failed generating AM snack')).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_fruit_menu/').done(resp => updateFruitTable(resp)).fail(() => toastr.error('Failed generating fruits')).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_vegetable_menu/').done(resp => updateVegetableTable(resp)).fail(() => toastr.error('Failed generating vegetables')).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_pm_menu/').done(resp => updatePMTable(resp)).fail(() => toastr.error('Failed generating PM snack')).always(saveMenuProgressToLocalStorage),
            ajaxPost('/generate_breakfast_menu/').done(resp => { updateBreakfastTable(resp); }).fail(() => toastr.error('Failed generating breakfast')).always(saveMenuProgressToLocalStorage)
        ];

        $.when.apply($, calls).always(async function() {
            try {
                // Preserve any user-selected week (window.nextMondayDate) instead
                // of recomputing next Monday from today which would overwrite
                // an edited/saved week. If no preserved week exists, fall back
                // to computing the next Monday.
                let preservedMonday = null;
                if (window.nextMondayDate) {
                    preservedMonday = (window.nextMondayDate instanceof Date) ? window.nextMondayDate : parseISO(window.nextMondayDate) || new Date(window.nextMondayDate);
                }
                if (preservedMonday && !isNaN(preservedMonday)) {
                    updateWeekDatesFromMonday(preservedMonday);
                } else {
                    updateDates();
                }
                DAYS.forEach(day => {
                    safeSetText(day + 'Milk', document.getElementById(day + 'Milk')?.innerText || '1% w.milk (unflavored)');
                    safeSetText(day + 'LunchMilk', document.getElementById(day + 'LunchMilk')?.innerText || '1% w.milk (unflavored)');
                });
                saveMenuProgressToLocalStorage();
                {% if not use_inventory_selectors %}
                enableEditablesForAllCells();
                {% endif %}

                // Recolor then ensure WG in sequence
                await applyGradientsToCells();
                await ensureDailyWG();
                toggleAMSnackVisibility();
                await buildRulesLegendFromCache();
            } finally {
                hideLoading();
                setTimeout(function(){ $btn.prop('disabled', false).removeClass('disabled'); }, 200);
            }
        });
    });

    $(document).on('click', '#generateMenuBtn', function (e) { console.log('delegated generate handler (fallback)'); });

    $('#saveMenuBtn').off('click').on('click', function (e) {
        e.preventDefault();
        if (typeof checkMenuExistsAndSave === 'function') checkMenuExistsAndSave();
    });
});

/* Build rule legend from cached inventory rules */
async function buildRulesLegendFromCache() {
    const container = document.getElementById('rulesLegend');
    if (!container) return;
    const rulesMap = await fetchInventoryRules();
    const unique = new Map();
    Object.values(rulesMap || {}).forEach(v => {
        if (!v || !v.rule_label) return;
        if (!unique.has(v.rule_label)) {
            unique.set(v.rule_label, {
                gradient_start: v.gradient_start,
                gradient_end: v.gradient_end,
                text_color: v.text_color,
                rule_label: v.rule_label
            });
        }
    });
    // If nothing was found, clear legend
    if (unique.size === 0) { container.innerHTML = ''; return; }

    const items = Array.from(unique.values()).sort((a, b) => a.rule_label.localeCompare(b.rule_label));
    const html = items.map(item => {
        const swatchStyle = `background: linear-gradient(135deg, ${item.gradient_start}, ${item.gradient_end});`;
        const labelStyle = `color: ${item.text_color};`;
        return `<div class="legend-item" role="listitem">
                    <span class="legend-swatch" style="${swatchStyle}" aria-hidden="true"></span>
                    <span class="legend-label" style="${labelStyle}">${item.rule_label}</span>
                </div>`;
    }).join('');
    // Preserve any existing saved-menus icon (so JS rebuild doesn't remove it)
    const existingIcon = container.querySelector('.saved-menus-icon');
    const existingIconHtml = existingIcon ? existingIcon.outerHTML : '';
    container.innerHTML = existingIconHtml + html;
}

/* Save menu to database */
async function checkMenuExistsAndSave() {
    const datesToCheck = [];
    const nextMonday = window.nextMondayDate;
    if (!nextMonday) { toastr.error('Please generate menu first to set dates'); return; }
    for (let i = 0; i < 5; i++) {
        const date = new Date(nextMonday);
        date.setDate(nextMonday.getDate() + i);
        const formattedDate = date.toISOString().split('T')[0];
        datesToCheck.push(formattedDate);
    }
    try {
        const response = await fetch('/api/check_menu/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ dates: datesToCheck })
        });
        const result = await response.json();
        if (result.exists) {
            const uniqueId = Date.now();
            const warningToast = toastr.warning(
                `<div style="margin-bottom: 15px;">There is already a menu saved for these dates. Saving will override previous entries.</div>
                 <div style="display: flex; gap: 10px; justify-content: center;">
                    <button type="button" class="btn btn-info warning-proceed-btn" style="padding: 8px 20px;">Proceed</button>
                    <button type="button" class="btn btn-secondary warning-cancel-btn" style="padding: 8px 20px;">Cancel</button>
                 </div>
                 <span style="display:none;" data-unique="${uniqueId}"></span>`,
                'Warning',
                { closeButton: false, timeOut: 0, extendedTimeOut: 0, tapToDismiss: false, positionClass: 'toast-top-center',
                  toastClass: 'toastr-warning-custom', escapeHtml: false, preventDuplicates: false,
                  onShown: function() {
                      $('.warning-proceed-btn').off('click').on('click', function() {
                          $('.toastr-warning-custom').fadeOut(200, function(){ $(this).remove(); saveMenu(); });
                      });
                      $('.warning-cancel-btn').off('click').on('click', function() {
                          $('.toastr-warning-custom').fadeOut(200, function(){ $(this).remove(); });
                      });
                  }
                }
            );
        } else {
            saveMenu();
        }
    } catch (error) {
        console.error('Error in checkMenuExistsAndSave:', error);
        toastr.error('Error checking existing menu. Please try again.');
    }
}

function saveMenu() {
    toastr.info('Saving menu...', '', { timeOut: 0, extendedTimeOut: 0, closeButton: false, tapToDismiss: false });

    const facilityName = document.querySelector('th[colspan="2"]')?.textContent.replace('Facility: ', '').trim() || '{{ facility_name }}';
    const sponsorName = document.querySelectorAll('th[colspan="2"]')[1]?.textContent.replace('Sponsor: ', '').trim() || '{{ sponsor_name }}';
    
    let menuData = {
        facility_name: facilityName,
        sponsor_name: sponsorName,
        // include chosen week start so server saves correct dates
        week_start: (window.nextMondayDate ? (new Date(window.nextMondayDate)).toISOString().split('T')[0] : null),
        // also include visible weekday strings (MM/DD) as a fallback
        weekdayDates: Array.from(document.querySelectorAll('.weekday-date')).map(e => e.innerText.trim()),
        monday: {
            am_fluid_milk: document.getElementById('mondayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('mondayfruit')?.innerText || '',
            am_bread: document.getElementById('mondaybread')?.innerText || '',
            am_additional: document.getElementById('mondayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('mondaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('mondayfruit2')?.innerText || '',
            ams_bread: document.getElementById('mondaybread2')?.innerText || '',
            ams_meat: document.getElementById('mondaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('mondayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('mondayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('mondayvege')?.innerText || '',
            lunch_fruit: document.getElementById('mondayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('mondayGrain')?.innerText || '',
            lunch_meat: document.getElementById('mondayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('mondayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('mondaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('mondayfruit4')?.innerText || '',
            pm_bread: document.getElementById('mondaybread3')?.innerText || '',
            pm_meat: document.getElementById('mondaymeat3')?.innerText || ''
        },
        tuesday: {
            am_fluid_milk: document.getElementById('tuesdayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('tuesdayfruit')?.innerText || '',
            am_bread: document.getElementById('tuesdaybread')?.innerText || '',
            am_additional: document.getElementById('tuesdayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('tuesdaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('tuesdayfruit2')?.innerText || '',
            ams_bread: document.getElementById('tuesdaybread2')?.innerText || '',
            ams_meat: document.getElementById('tuesdaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('tuesdayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('tuesdayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('tuesdayvege')?.innerText || '',
            lunch_fruit: document.getElementById('tuesdayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('tuesdayGrain')?.innerText || '',
            lunch_meat: document.getElementById('tuesdayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('tuesdayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('tuesdaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('tuesdayfruit4')?.innerText || '',
            pm_bread: document.getElementById('tuesdaybread3')?.innerText || '',
            pm_meat: document.getElementById('tuesdaymeat3')?.innerText || ''
        },
        wednesday: {
            am_fluid_milk: document.getElementById('wednesdayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('wednesdayfruit')?.innerText || '',
            am_bread: document.getElementById('wednesdaybread')?.innerText || '',
            am_additional: document.getElementById('wednesdayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('wednesdaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('wednesdayfruit2')?.innerText || '',
            ams_bread: document.getElementById('wednesdaybread2')?.innerText || '',
            ams_meat: document.getElementById('wednesdaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('wednesdayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('wednesdayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('wednesdayvege')?.innerText || '',
            lunch_fruit: document.getElementById('wednesdayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('wednesdayGrain')?.innerText || '',
            lunch_meat: document.getElementById('wednesdayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('wednesdayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('wednesdaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('wednesdayfruit4')?.innerText || '',
            pm_bread: document.getElementById('wednesdaybread3')?.innerText || '',
            pm_meat: document.getElementById('wednesdaymeat3')?.innerText || ''
        },
        thursday: {
            am_fluid_milk: document.getElementById('thursdayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('thursdayfruit')?.innerText || '',
            am_bread: document.getElementById('thursdaybread')?.innerText || '',
            am_additional: document.getElementById('thursdayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('thursdaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('thursdayfruit2')?.innerText || '',
            ams_bread: document.getElementById('thursdaybread2')?.innerText || '',
            ams_meat: document.getElementById('thursdaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('thursdayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('thursdayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('thursdayvege')?.innerText || '',
            lunch_fruit: document.getElementById('thursdayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('thursdayGrain')?.innerText || '',
            lunch_meat: document.getElementById('thursdayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('thursdayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('thursdaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('thursdayfruit4')?.innerText || '',
            pm_bread: document.getElementById('thursdaybread3')?.innerText || '',
            pm_meat: document.getElementById('thursdaymeat3')?.innerText || ''
        },
        friday: {
            am_fluid_milk: document.getElementById('fridayMilk')?.innerText || '',
            am_fruit_veg: document.getElementById('fridayfruit')?.innerText || '',
            am_bread: document.getElementById('fridaybread')?.innerText || '',
            am_additional: document.getElementById('fridayadd1')?.innerText || '',
            ams_fluid_milk: document.getElementById('fridaychoose1')?.innerText || '',
            ams_fruit_veg: document.getElementById('fridayfruit2')?.innerText || '',
            ams_bread: document.getElementById('fridaybread2')?.innerText || '',
            ams_meat: document.getElementById('fridaymeat1')?.innerText || '',
            lunch_main_dish: document.getElementById('fridayMeals')?.innerText || '',
            lunch_fluid_milk: document.getElementById('fridayLunchMilk')?.innerText || '',
            lunch_vegetable: document.getElementById('fridayvege')?.innerText || '',
            lunch_fruit: document.getElementById('fridayfruit3')?.innerText || '',
            lunch_grain: document.getElementById('fridayGrain')?.innerText || '',
            lunch_meat: document.getElementById('fridayMeatAlternate')?.innerText || '',
            lunch_additional: document.getElementById('fridayadd2')?.innerText || '',
            pm_fluid_milk: document.getElementById('fridaychoose2')?.innerText || '',
            pm_fruit_veg: document.getElementById('fridayfruit4')?.innerText || '',
            pm_bread: document.getElementById('fridaybread3')?.innerText || '',
            pm_meat: document.getElementById('fridaymeat3')?.innerText || ''
        }
    };

    // Collect assigned rules (cellId -> ruleId)
    try {
        const assigned = {};
        document.querySelectorAll('[data-rule-id]').forEach(el => { if (el.id && el.dataset.ruleId) assigned[el.id] = el.dataset.ruleId; });
        menuData.assigned_rules = assigned;
    } catch(e) { /* ignore */ }

    $.ajax({
        url: '/api/save_menu/',
        type: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        data: JSON.stringify(menuData),
        success: function (response) {
            toastr.clear();
            toastr.success('Menu saved successfully!');
            clearMenuProgressFromLocalStorage();
        },
        error: function (xhr, status, error) {
            toastr.clear();
            toastr.error('Error saving menu: ' + (xhr.responseJSON?.error || error));
        }
    });
}

/* expose helpers */
window.updateTable = updateTable;
window.updateAMTable = updateAMTable;
window.updatePMTable = updatePMTable;
window.updateBreakfastTable = updateBreakfastTable;
window.updateFruitTable = updateFruitTable;
window.updateVegetableTable = updateVegetableTable;
window.saveMenuProgressToLocalStorage = saveMenuProgressToLocalStorage;
window.restoreMenuProgressFromLocalStorage = restoreMenuProgressFromLocalStorage;
window.checkMenuExistsAndSave = checkMenuExistsAndSave;
window.saveMenu = saveMenu;
window.applyGradientsToCells = applyGradientsToCells;
window.clearInventoryRulesCache = clearInventoryRulesCache;
window.ensureDailyWG = ensureDailyWG;
</script>
<script>
function openInventoryWindow() {
    window.open(
        "{% url 'inventory_list' %}?public=true&popup=1",
        "InventoryWindow",
        "width=1100,height=700,scrollbars=yes,resizable=yes"
    );
}

// Mobile menu dropdown toggle
$('#mobileMenuBtn').on('click', function(e) {
    e.stopPropagation();
    $('#mobileMenuDropdown').toggleClass('show');
});

// Desktop header dropdown toggle
$('#desktopMenuBtn').on('click', function(e) {
    e.stopPropagation();
    $('#desktopMenuDropdown').toggleClass('show');
});

// Close dropdown when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('#mobileMenuBtn, #mobileMenuDropdown, #desktopMenuBtn, #desktopMenuDropdown').length) {
        $('#mobileMenuDropdown, #desktopMenuDropdown').removeClass('show');
    }
});

// Generate PDF button - prints full weekly table regardless of screen size
$(document).on('click', '#generatePDFBtn, #generatePDFBtnMobile', function(e) {
    e.preventDefault();
    $('#mobileMenuDropdown, #desktopMenuDropdown').removeClass('show');
    
    const isMobile = window.innerWidth <= 1000;
    const mobileShowElements = document.querySelectorAll('.mobile-show-day');
    const allDayElements = document.querySelectorAll('[data-day]');
    const verticalHeaders = document.querySelectorAll('.vertical-header');
    const tbody = document.querySelector('.table tbody');
    const thead = document.querySelector('.table thead');
    const allRows = document.querySelectorAll('.table tbody tr');

    const originalStyles = {
        body: tbody ? tbody.style.cssText : '',
        head: thead ? thead.style.cssText : '',
    };
    
    const printStyle = document.createElement('style');
    printStyle.id = 'temp-print-style';
    printStyle.innerHTML = `
        body.printing-pdf { overflow-x: visible !important; max-width: none !important; }
        body.printing-pdf .table { table-layout: fixed !important; width: 100% !important; }
        body.printing-pdf .table thead { display: table-header-group !important; }
        body.printing-pdf .table tbody { display: table-row-group !important; background-color: #fff !important; }
        body.printing-pdf .table tbody tr { display: table-row !important; grid-template-columns: none !important; margin-top: 0 !important; margin-left: 0 !important; width: auto !important; position: static !important; }
        body.printing-pdf .table tbody tr::before { content: none !important; display: none !important; }
        body.printing-pdf .table tbody tr td, body.printing-pdf .table tbody tr th, body.printing-pdf .table thead tr th { display: table-cell !important; padding: 0.2rem !important; font-size: 0.65rem !important; line-height: 1.1 !important; word-wrap: break-word !important; overflow-wrap: break-word !important; }
        body.printing-pdf .table tbody tr td.vertical-header { display: table-cell !important; writing-mode: vertical-rl !important; transform: rotate(180deg) !important; white-space: nowrap !important; box-sizing: border-box; width: 24px; min-width: 24px; max-width: 24px; padding: 2px 1px; text-align: center !important; font-size: 0.7rem !important; }
        body.printing-pdf .table thead tr th[data-day], body.printing-pdf .table tbody tr td[data-day], body.printing-pdf .table tbody tr th[data-day] { display: table-cell !important; }
        body.printing-pdf #mobileDaySelector, body.printing-pdf #mobileBottomNav { display: none !important; }
        body.printing-pdf .container { padding-left: 10px !important; padding-right: 10px !important; margin-left: auto !important; margin-right: auto !important; max-width: 100% !important; }
        body.printing-pdf #printableTable { margin: 0 !important; padding: 0 !important; width: 100% !important; }
        @media print {
            h1, .sb-topnav, .sb-sidenav-footer, .button-container, #generateMenuBtn, #saveMenuBtn, #mobileDaySelector, #mobileBottomNav { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { margin: 0; padding: 0; width: 100%; }
            .container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .table { table-layout: fixed !important; width: 100% !important; border-collapse: collapse !important; }
            .table thead { display: table-header-group !important; }
            .table tbody { display: table-row-group !important; }
            .table tbody tr { display: table-row !important; grid-template-columns: none !important; position: static !important; margin: 0 !important; page-break-inside: avoid !important; }
            .table tbody tr::before { content: none !important; display: none !important; }
            .table tbody tr td.vertical-header { display: table-cell !important; writing-mode: vertical-rl !important; transform: rotate(180deg) !important; white-space: nowrap !important; width: 24px !important; min-width: 24px !important; max-width: 24px !important; padding: 2px 1px !important; font-size: 0.7rem !important; }
            .table thead tr th, .table tbody tr td, .table tbody tr th { display: table-cell !important; padding: 0.2rem 0.15rem !important; font-size: 0.6rem !important; line-height: 1.1 !important; word-wrap: break-word !important; white-space: normal !important; overflow-wrap: break-word !important; }
            .table tbody tr td:nth-child(2) { width: 18% !important; font-size: 0.58rem !important; }
            .table tbody tr td[data-day], .table thead tr th[data-day] { width: 13.5% !important; }
            .table thead tr th { font-size: 0.65rem !important; padding: 0.25rem !important; }
            #weeklyMenuHeader { font-size: 0.75rem !important; padding: 0.3rem !important; }
            .vertical-header { writing-mode: vertical-rl !important; transform: rotate(180deg) !important; white-space: nowrap !important; }
            @page { size: landscape; margin: 0.3in 0.25in; }
        }
    `;
    document.head.appendChild(printStyle);
    document.body.classList.add('printing-pdf');

    setTimeout(() => {
        window.print();
        setTimeout(() => {
            const tempStyle = document.getElementById('temp-print-style');
            if (tempStyle) tempStyle.remove();
            document.body.classList.remove('printing-pdf');
            allDayElements.forEach(el => { el.style.display = ''; });
            verticalHeaders.forEach(el => { el.style.padding = ''; });
            allRows.forEach(row => { row.style.marginTop = ''; });
            if (tbody) tbody.style.cssText = originalStyles.body;
            if (thead) thead.style.cssText = originalStyles.head;

            if (isMobile) {
                const daySelect = document.getElementById('daySelect');
                const selectedDay = daySelect ? daySelect.value : 'monday';
                document.querySelectorAll('[data-day]').forEach(el => el.classList.remove('mobile-show-day'));
                document.querySelectorAll(`[data-day="${selectedDay}"]`).forEach(el => el.classList.add('mobile-show-day'));
            }
        }, 500);
    }, 100);
}); // close PDF click handler

function exportWeeklyMenuCSV() {
    const table = document.getElementById('weeklyMenuTable');
    if (!table) return;

    const getText = (el) => (el ? el.textContent.replace(/\s+/g, ' ').trim() : '');
    const rows = [];
    const headerTitle = document.querySelector('.weekly-header-title');
    if (headerTitle) rows.push([getText(headerTitle)]);
    const thead = table.querySelector('thead');
    if (thead) thead.querySelectorAll('tr').forEach(tr => { rows.push(Array.from(tr.children).map(getText)); });
    const tbody = table.querySelector('tbody');
    if (tbody) {
        Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
            const cells = Array.from(tr.children);
            if (cells[0] && cells[0].classList.contains('vertical-header')) { rows.push([getText(cells[0])]); return; }
            rows.push(cells.map(getText));
        });
    }
    const toCSVLine = (arr) => arr.map(v => {
        const s = v == null ? '' : String(v);
        const escaped = s.replace(/"/g, '""');
        return /[",\n]/.test(s) ? `"${escaped}"` : escaped;
    }).join(',');
    const csv = rows.map(toCSVLine).join('\n');

    let fileName = 'weekly-menu.csv';
    const titleText = getText(headerTitle);
    const match = titleText.match(/Weekly Menu:\s*([0-9/]+)\s*-\s*([0-9/]+)/i);
    if (match) fileName = `weekly-menu-${match[1].replace(/\//g, '-')}-to-${match[2].replace(/\//g, '-')}.csv`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    $('#mobileMenuDropdown, #desktopMenuDropdown').removeClass('show');
}
$(document).on('click', '#exportWeeklyMenuCSV, #exportWeeklyMenuCSVMobile', function(e) { e.preventDefault(); exportWeeklyMenuCSV(); });

// Desktop dropdown: Toggle AM Snack
$(document).on('click', '#toggleAMSnackDesktopBtn', function(e) {
    e.preventDefault();
    $('#desktopMenuDropdown').removeClass('show');
    toggleAMSnackMobile();
});
</script>
<script>
// Autocomplete selector for menu cells
(function(){
    // Inventory items passed from view
    const INVENTORY_ITEMS = {{ inventory_items_json|safe }} || [];

    // Build dropdown container
    const dropdown = document.createElement('div');
    dropdown.id = 'inventory-autocomplete-popup';
    Object.assign(dropdown.style, {
        position: 'absolute', zIndex: 2000, background: '#fff', border: '1px solid #ccc',
        minWidth: '220px', maxHeight: '260px', overflowY: 'auto', boxShadow: '0 6px 18px rgba(0,0,0,0.15)', display: 'none'
    });

    const searchInput = document.createElement('input');
    searchInput.type = 'search';
    searchInput.setAttribute('aria-label','Search inventory items');
    Object.assign(searchInput.style, { width: '100%', boxSizing: 'border-box', padding: '8px 10px', border: 'none', outline: 'none' });

    const list = document.createElement('div');
    list.style.padding = '6px';

    dropdown.appendChild(searchInput);
    dropdown.appendChild(list);
    document.body.appendChild(dropdown);

    let activeCell = null;
    let actionCell = null;

    // Action popup: offers Edit Item or Edit Rule for the clicked cell
    const actionPopup = document.createElement('div');
    actionPopup.id = 'inventory-action-popup';
    Object.assign(actionPopup.style, {
        position: 'absolute', zIndex: 2100, background: '#fff', border: '1px solid #ccc',
        padding: '6px', borderRadius: '6px', boxShadow: '0 6px 18px rgba(0,0,0,0.12)', display: 'none'
    });
    const itemBtn = document.createElement('button');
    itemBtn.type = 'button';
    itemBtn.textContent = 'Edit Item';
    itemBtn.className = 'btn btn-primary btn-sm';
    Object.assign(itemBtn.style, { marginRight: '6px', padding: '6px 8px', cursor: 'pointer' });
    const ruleBtn = document.createElement('button');
    ruleBtn.type = 'button';
    ruleBtn.textContent = 'Edit Rule';
    ruleBtn.className = 'btn btn-primary btn-sm';
    Object.assign(ruleBtn.style, { padding: '6px 8px', cursor: 'pointer' });
    actionPopup.appendChild(itemBtn);
    actionPopup.appendChild(ruleBtn);
    document.body.appendChild(actionPopup);

    // Rules dropdown (select a Rule model instance by id)
    const rulesMenu = document.createElement('div');
    rulesMenu.id = 'inventory-rules-menu';
    Object.assign(rulesMenu.style, {
        position: 'absolute', zIndex: 2200, background: '#fff', border: '1px solid #ccc',
        minWidth: '220px', maxHeight: '300px', overflowY: 'auto', boxShadow: '0 6px 18px rgba(0,0,0,0.15)', display: 'none', padding: '6px'
    });
    document.body.appendChild(rulesMenu);
    let rulesCache = null;


    // wire action buttons
    itemBtn.addEventListener('click', function(e){
        e.stopPropagation();
        e.preventDefault(); if (!actionCell) { closeActionPopup(); return; } const cell = actionCell; closeActionPopup(); showPopupForCell(cell);
    });
    ruleBtn.addEventListener('click', function(e){
        e.stopPropagation();
        e.preventDefault();
        if (!actionCell) { closeActionPopup(); return; }
        const cell = actionCell;
        closeActionPopup();
        openRuleEditor(cell);
    });

    function openRuleEditor(cell){
        if (!cell) return;
        // fetch rules if needed then show rulesMenu anchored to the cell
        const rect = cell.getBoundingClientRect();
        // temporarily show hidden to measure and clamp into viewport
        rulesMenu.style.zIndex = 99999;
        rulesMenu.style.left = '0px';
        rulesMenu.style.top = '0px';
        rulesMenu.style.visibility = 'hidden';
        rulesMenu.style.display = 'block';
        rulesMenu.innerHTML = '<div style="padding:6px;font-style:italic;color:#666">Loading rules…</div>';
        // allow layout to update then measure
        requestAnimationFrame(() => {
            const menuW = rulesMenu.offsetWidth || 240;
            const menuH = rulesMenu.offsetHeight || 160;
            let left = window.scrollX + rect.left;
            let top = window.scrollY + rect.bottom + 6;
            // clamp to viewport
            const maxLeft = window.scrollX + Math.max(8, window.innerWidth - menuW - 8);
            const maxTop = window.scrollY + Math.max(8, window.innerHeight - menuH - 8);
            if (left > maxLeft) left = maxLeft;
            if (top > maxTop) top = maxTop;
            if (left < window.scrollX + 6) left = window.scrollX + 6;
            if (top < window.scrollY + 6) top = window.scrollY + 6;
            rulesMenu.style.left = left + 'px';
            rulesMenu.style.top = top + 'px';
            rulesMenu.style.visibility = 'visible';
            rulesMenu.style.pointerEvents = 'auto';
        });

        function renderRules(list){
            rulesMenu.innerHTML = '';
            const clearRow = document.createElement('div');
            clearRow.textContent = 'Clear rule';
            Object.assign(clearRow.style, { padding: '6px 8px', cursor: 'pointer', borderRadius: '4px', fontWeight: '600' });
            clearRow.addEventListener('click', () => {
                delete cell.dataset.ruleId;
                cell.dataset.ruleLabel = '';
                cell.dataset.ruleApplied = 'false';
                cell.style.background = '';
                cell.style.color = '';
                rulesMenu.style.display = 'none';
                try { saveMenuProgressToLocalStorage(); applyGradientsToCells(); ensureDailyWG(); } catch(e){}
            });
            rulesMenu.appendChild(clearRow);

            list.forEach(r => {
                const row = document.createElement('div');
                row.textContent = r.rule || r.rule_label || r.rule_text || ('Rule ' + r.id);
                Object.assign(row.style, { padding: '6px 8px', cursor: 'pointer', borderRadius: '4px' });
                row.addEventListener('click', () => {
                    cell.dataset.ruleId = r.id;
                    cell.dataset.ruleLabel = r.rule || r.rule_label || '';
                    cell.dataset.ruleApplied = 'true';
                    const gs = r.gradient_start || WG_DEFAULT_STYLE.gradient_start;
                    const ge = r.gradient_end || WG_DEFAULT_STYLE.gradient_end;
                    const tc = r.text_color || WG_DEFAULT_STYLE.text_color;
                    cell.style.background = `linear-gradient(135deg, ${gs}, ${ge})`;
                    cell.style.color = tc;
                    rulesMenu.style.display = 'none';
                    try { saveMenuProgressToLocalStorage(); applyGradientsToCells(); ensureDailyWG(); } catch(e){}
                });
                row.addEventListener('mouseenter', () => row.style.background = 'rgba(0,0,0,0.04)');
                row.addEventListener('mouseleave', () => row.style.background = '');
                rulesMenu.appendChild(row);
            });
        }

        if (rulesCache) {
            renderRules(rulesCache);
            return;
        }

        fetch('/api/list_rules/', { method: 'GET', headers: { 'X-CSRFToken': getCookie('csrftoken') }})
            .then(r => r.json())
            .then(data => {
                // Expecting an array of rule objects: {id, rule, gradient_start, gradient_end, text_color}
                rulesCache = Array.isArray(data) ? data : (data.rules || []);
                renderRules(rulesCache);
            })
            .catch(err => {
                console.warn('Failed to fetch rules:', err);
                rulesMenu.innerHTML = '<div style="padding:6px;color:#900">Failed to load rules</div>';
            });
    }

    function showActionPopupForCell(cell){
        if (!cell) return;
        actionCell = cell;
        const rect = cell.getBoundingClientRect();
        actionPopup.style.left = (window.scrollX + rect.left) + 'px';
        actionPopup.style.top = (window.scrollY + rect.bottom + 6) + 'px';
        actionPopup.style.display = 'block';
    }

    function closeActionPopup(){ actionPopup.style.display = 'none'; actionCell = null; }

    function showPopupForCell(cell){
        if (!cell) return;
        activeCell = cell;
        searchInput.value = cell.innerText.trim();
        renderList(searchInput.value || '');
        const rect = cell.getBoundingClientRect();
        dropdown.style.left = (window.scrollX + rect.left) + 'px';
        dropdown.style.top = (window.scrollY + rect.bottom + 6) + 'px';
        dropdown.style.minWidth = Math.max(220, rect.width) + 'px';
        dropdown.style.display = 'block';
        searchInput.focus();
        searchInput.select();
    }

    function closePopup(){ dropdown.style.display = 'none'; activeCell = null; }

    function renderList(filter){
        const q = (filter || '').toLowerCase().trim();
        list.innerHTML = '';
        const matches = INVENTORY_ITEMS.filter(it => it.toLowerCase().indexOf(q) !== -1);
        const toShow = q === '' ? INVENTORY_ITEMS.slice(0,100) : matches.slice(0,100);

        toShow.forEach(item => {
            const row = document.createElement('div');
            row.textContent = item;
            Object.assign(row.style, { padding: '6px 8px', cursor: 'pointer', borderRadius: '4px' });
            row.addEventListener('click', () => { if (!activeCell) return; activeCell.innerText = item; closePopup(); try { saveMenuProgressToLocalStorage(); applyGradientsToCells(); ensureDailyWG(); } catch(e){} });
            row.addEventListener('mouseenter', () => row.style.background = 'rgba(0,0,0,0.04)');
            row.addEventListener('mouseleave', () => row.style.background = '');
            list.appendChild(row);
        });

        if (q !== '' && matches.length === 0) {
            const addRow = document.createElement('div');
            addRow.textContent = `Add custom: "${filter}"`;
            Object.assign(addRow.style, { padding: '8px', fontStyle: 'italic', cursor: 'pointer', borderTop: '1px solid rgba(0,0,0,0.06)' });
            addRow.addEventListener('click', () => { if (!activeCell) return; activeCell.innerText = filter; closePopup(); try { saveMenuProgressToLocalStorage(); applyGradientsToCells(); ensureDailyWG(); } catch(e){} });
            list.appendChild(addRow);
        }
    }

    function attachHandlers(){
        const ids = [
            'mondayMilk','tuesdayMilk','wednesdayMilk','thursdayMilk','fridayMilk',
            'mondayfruit','tuesdayfruit','wednesdayfruit','thursdayfruit','fridayfruit',
            'mondaybread','tuesdaybread','wednesdaybread','thursdaybread','fridaybread',
            'mondayadd1','tuesdayadd1','wednesdayadd1','thursdayadd1','fridayadd1',
            'mondaychoose1','tuesdaychoose1','wednesdaychoose1','thursdaychoose1','fridaychoose1',
            'mondayfruit2','tuesdayfruit2','wednesdayfruit2','thursdayfruit2','fridayfruit2',
            'mondaybread2','tuesdaybread2','wednesdaybread2','thursdaybread2','fridaybread2',
            'mondaymeat1','tuesdaymeat1','wednesdaymeat1','thursdaymeat1','fridaymeat1',
            'mondayMeals','tuesdayMeals','wednesdayMeals','thursdayMeals','fridayMeals',
            'mondayLunchMilk','tuesdayLunchMilk','wednesdayLunchMilk','thursdayLunchMilk','fridayLunchMilk',
            'mondayvege','tuesdayvege','wednesdayvege','thursdayvege','fridayvege',
            'mondayfruit3','tuesdayfruit3','wednesdayfruit3','thursdayfruit3','fridayfruit3',
            'mondayGrain','tuesdayGrain','wednesdayGrain','thursdayGrain','fridayGrain',
            'mondayMeatAlternate','tuesdayMeatAlternate','wednesdayMeatAlternate','thursdayMeatAlternate','fridayMeatAlternate',
            'mondayadd2','tuesdayadd2','wednesdayadd2','thursdayadd2','fridayadd2',
            'mondaychoose2','tuesdaychoose2','wednesdaychoose2','thursdaychoose2','fridaychoose2',
            'mondayfruit4','tuesdayfruit4','wednesdayfruit4','thursdayfruit4','fridayfruit4',
            'mondaybread3','tuesdaybread3','wednesdaybread3','thursdaybread3','fridaybread3',
            'mondaymeat3','tuesdaymeat3','wednesdaymeat3','thursdaymeat3','fridaymeat3'
        ];

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.cursor = 'text';
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                // If an autocomplete dropdown or rules menu is open, don't re-open the action popup
                if (dropdown.style.display === 'block' || rulesMenu.style.display === 'block') return;
                // If user clicked into an input element inside the cell, allow default (don't show popup)
                const tg = e.target || null;
                if (tg && (tg.tagName === 'INPUT' || tg.tagName === 'TEXTAREA' || tg.classList && tg.classList.contains('input-box'))) return;
                // If the action popup is already showing for this cell, don't show it again
                if (actionCell === el && actionPopup.style.display === 'block') return;

                closePopup();
                closeActionPopup();
                showActionPopupForCell(el);
            });
        });
    }

    searchInput.addEventListener('input', () => renderList(searchInput.value));
    searchInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') { closePopup(); }
        if (ev.key === 'Enter') { const first = list.firstElementChild; if (first) { first.click(); ev.preventDefault(); } }
    });

    document.addEventListener('click', (ev) => {
        if (!dropdown.contains(ev.target) && !actionPopup.contains(ev.target) && !rulesMenu.contains(ev.target)) closePopup();
        if (!actionPopup.contains(ev.target)) closeActionPopup();
        if (!rulesMenu.contains(ev.target)) rulesMenu.style.display = 'none';
    });
    window.addEventListener('resize', closePopup);
    window.addEventListener('scroll', closePopup, true);
    window.addEventListener('resize', () => { rulesMenu.style.display = 'none'; });
    window.addEventListener('scroll', () => { rulesMenu.style.display = 'none'; }, true);

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachHandlers);
    else attachHandlers();
})();
</script>
<script>
// Clickable weekly header date editor (Mon–Fri only)
(function(){
    const header = document.querySelector('.weekly-header-title');
    if (!header) return;

    function formatMMDD(date) {
        const mm = String(date.getMonth()+1).padStart(2,'0');
        const dd = String(date.getDate()).padStart(2,'0');
        return mm + '/' + dd;
    }

    // Use local YYYY-MM-DD formatting/parsing to avoid timezone shifts
    function toISO(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function parseISO(v) {
        if (!v || typeof v !== 'string') return null;
        const parts = v.split('-').map(p => parseInt(p, 10));
        if (parts.length !== 3 || parts.some(isNaN)) return null;
        const [y, m, d] = parts;
        return new Date(y, m - 1, d);
    }

    function getMondayOf(date) {
        const d = new Date(date);
        const dow = d.getDay(); // 0 Sun .. 6 Sat
        const diff = (dow === 0) ? -6 : (1 - dow); // shift Sun->Mon previous, else to Monday
        d.setDate(d.getDate() + diff);
        d.setHours(0,0,0,0);
        return d;
    }

    function updateWeekDatesFromMonday(monday) {
        if (!monday) return;
        const spans = document.querySelectorAll('.weekday-date');
        for (let i=0;i<5;i++){
            const d = new Date(monday); d.setDate(monday.getDate()+i);
            if (spans[i]) spans[i].innerText = formatMMDD(d);
        }
        // update header
        const friday = new Date(monday); friday.setDate(monday.getDate()+4);
        header.innerText = `Weekly Menu: ${formatMMDD(monday)} - ${formatMMDD(friday)}`;
        // remember for other code
        window.nextMondayDate = monday;
        try { updateDropdownWithDates(); saveMenuProgressToLocalStorage(); } catch(e){}
    }

    header.style.cursor = 'pointer';
    header.title = 'Click to edit week start date (Mon–Fri)';

    header.addEventListener('click', function(e){
        e.stopPropagation();
        // prevent multiple editors
        if (document.getElementById('weekly-start-editor')) return;

        // initial value: prefer existing weekday spans or nextMondayDate
        let initMonday = window.nextMondayDate || null;
        const firstSpan = document.querySelector('.weekday-date');
        if (!initMonday && firstSpan && firstSpan.innerText.trim()) {
            const parts = firstSpan.innerText.trim().split('/');
            if (parts.length === 2) {
                const now = new Date(); const year = now.getFullYear();
                const d = new Date(`${year}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`);
                if (!isNaN(d)) initMonday = getMondayOf(d);
            }
        }
        if (!initMonday) {
            // compute next Monday
            const today = new Date(); const dow = today.getDay();
            const daysUntilNextMonday = (dow === 0) ? 1 : (8 - dow);
            initMonday = new Date(today); initMonday.setDate(today.getDate() + daysUntilNextMonday);
            initMonday.setHours(0,0,0,0);
        }

        // build editor
        const container = document.createElement('span');
        container.id = 'weekly-start-editor';
        container.style.display = 'inline-flex';
        container.style.gap = '8px';
        container.style.alignItems = 'center';

        const input = document.createElement('input');
        input.type = 'date';
        input.value = toISO(initMonday);
        input.style.padding = '4px 8px';
        input.style.borderRadius = '4px';
        input.style.border = '1px solid #ccc';

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button'; saveBtn.className = 'btn btn-primary btn-sm'; saveBtn.textContent = 'Save';
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button'; cancelBtn.className = 'btn btn-secondary btn-sm'; cancelBtn.textContent = 'Cancel';

        const note = document.createElement('small');
        note.style.color = '#d00'; note.style.marginLeft = '6px'; note.style.display = 'none';

        container.appendChild(input); container.appendChild(saveBtn); container.appendChild(cancelBtn); container.appendChild(note);

        // swap header content
        const originalText = header.innerText;
        header.innerText = '';
        header.appendChild(container);
        input.focus();

        function closeEditor(restory=true){
            // remove editor UI if present and restore header styling/clickability
            const el = document.getElementById('weekly-start-editor');
            if (el && el.parentNode) el.parentNode.removeChild(el);
            if (restory) {
                header.innerText = originalText;
            } else {
                // ensure header shows the updated text (compute from weekday spans if necessary)
                const spans = document.querySelectorAll('.weekday-date');
                if (spans && spans.length >= 5 && spans[0].innerText.trim()) {
                    const m = spans[0].innerText.trim();
                    const f = spans[4].innerText.trim();
                    header.innerText = `Weekly Menu: ${m} - ${f}`;
                }
            }
            header.style.cursor = 'pointer';
            header.title = 'Click to edit week start date (Mon–Fri)';
            header.removeAttribute('data-editing');
        }

        cancelBtn.addEventListener('click', function(){
            // defensively remove editor and restore header (mirror save fallback)
            try { closeEditor(true); } catch(e) { /* ignore */ }
            setTimeout(() => {
                const lingering = document.querySelectorAll('#weekly-start-editor');
                lingering.forEach(n => { if (n && n.parentNode) n.parentNode.removeChild(n); });
                // restore header text if necessary
                if (originalText && header) header.innerText = originalText;
                header.style.cursor = 'pointer';
                header.title = 'Click to edit week start date (Mon–Fri)';
                header.removeAttribute('data-editing');
            }, 10);
        });
        input.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') { closeEditor(true); } if (ev.key === 'Enter') { saveBtn.click(); } });

                saveBtn.addEventListener('click', function(){
                        const v = input.value; const d = parseISO(v);
                        if (!d) { note.innerText = 'Invalid date'; note.style.display='inline'; return; }
                        const dow = d.getDay();
                        if (dow === 0 || dow === 6) { note.innerText = 'Please choose a weekday (Mon–Fri)'; note.style.display='inline'; return; }
                        // compute monday of that week
                        const monday = getMondayOf(d);
                        updateWeekDatesFromMonday(monday);
                        // ensure editor is removed after any other updates settle
                        setTimeout(() => {
                            try { closeEditor(false); } catch(e) { /* ignore */ }
                            // as a fallback, remove any lingering editor elements under header
                            const lingering = document.querySelectorAll('#weekly-start-editor');
                            lingering.forEach(n => { if (n && n.parentNode) n.parentNode.removeChild(n); });
                            // ensure header displays expected text
                            const spans = document.querySelectorAll('.weekday-date');
                            if (spans && spans.length >= 5 && spans[0].innerText.trim()) {
                                header.innerText = `Weekly Menu: ${spans[0].innerText.trim()} - ${spans[4].innerText.trim()}`;
                            }
                        }, 50);
                });
    });
})();

// Dropdown 'Edit Dates' handlers — trigger the same header editor
(function(){
    function openWeeklyDateEditor(){
        const headerTitle = document.querySelector('.weekly-header-title');
        if (headerTitle) {
            headerTitle.click();
        } else {
            console.warn('weekly-header-title not found');
        }
    }

    // Attach handlers if buttons exist (works with dynamic DOM loading)
    document.addEventListener('click', function(e){
        const t = e.target;
        if (!t) return;
        // support clicks on inner <i> or button
        const btn = t.closest && t.closest('#editDatesBtn, #editDatesBtnMobile');
        if (!btn) return;
        openWeeklyDateEditor();
        // close dropdowns if open
        const d1 = document.getElementById('desktopMenuDropdown');
        const d2 = document.getElementById('mobileMenuDropdown');
        if (d1) d1.classList.remove('show');
        if (d2) d2.classList.remove('show');
    });
})();
</script>
{% endblock %}
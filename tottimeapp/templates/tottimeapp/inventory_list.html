{% extends 'tottimeapp/base_dynamic.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Inventory{% endblock %}
{% block styles %} 
<style>
@media (max-width: 999px) {
    /* Add a solid spacer so scrolling reaches below the fixed nav */
    #categoryTabContent::after {
        content: "";
        display: block;
        height: 100px; /* adjust as needed (64px nav + extra for decorative circle) */
        width: 1px;
        pointer-events: none;
    }

    /* Make sure the tab container actually scrolls to include the spacer */
    #categoryTabContent,
    .tab-content {
        -webkit-overflow-scrolling: touch;
        padding-bottom: 0; /* spacer handles visual space; avoid double-padding */
    }
}

.table-tabs {
        margin-left: 30px!important;
    }

    /* Tab styles */
    .table-tabs .table-link {
        padding: 5px 15px; /* Reduce padding for smaller tabs */
        text-decoration: none;
        color: #000; /* Default text color */
        background-color: #f8f9fa; /* Light gray background */
        border: 1px solid #ddd; /* Light gray border */
        border-bottom: none; /* Remove bottom border */
        border-radius: 10px 10px 0 0; /* Curved corners */
        margin-right: 5px; /* Spacing between tabs */
        cursor: pointer; /* Pointer cursor for tabs */
        transition: background-color 0.3s, color 0.3s; /* Smooth hover effect */
        white-space: nowrap; /* Prevent text wrapping */
        display: inline-block; /* Ensure proper width calculation */
    }

    /* Hover effect for inactive tabs */
    .table-tabs .table-link:hover:not(.active) {
        background-color: #e9ecef; /* Slightly darker gray on hover */
        color: rgb(57, 189, 180); /* Change hover text color */
    }

    /* Active tab styles */
    .table-tabs .table-link.active {
        background-color: #272630; /* Dark background for active tab */
        color: rgb(57, 189, 180) ;/* White text for active tab */
        font-weight: bold; /* Bold text for active tab */
        cursor: default; /* Default cursor for active tab */
        border-radius: 10px 10px 0 0; /* Match curved corners */
        border-color: #272630; /* Match border color with background */
    }

    /* Optional: Hover effect for active tab */
    .table-tabs .table-link.active:hover {
        color: rgb(57, 189, 180); /* Change text color on hover */
    }
    
    .item-header, td:first-child {
        width: 560px;
    }
    
    .btn-primary {
        margin-top: 25px;
        margin-left: 25px!important;
    }
    
    #scanner-container canvas {
        display: none; /* Hide the canvas used by QuaggaJS for processing */
    }
    
    .btn-warning {
        margin-right:25px;
    }
    
    /* Quantity input styling - wider for all screen sizes */
    input[type="number"][id^="new_quantity_"], 
    input[type="number"][id^="extra_milk_quantity_"] {
        width: 85px !important; /* Increased width to accommodate 3+ digits */
        padding: 2px 5px; /* Add some padding for better appearance */
        text-align: center; /* Center the text */
        border: 1px solid #ccc; /* Add a subtle border */
        border-radius: 3px; /* Slight rounding */
    }

#scanner-container {
    width: 340px;
    height: 300px;
    margin: 0 auto;
    border: 2px solid #000;
    position: relative;
    overflow: hidden;
}

#scanner-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#barcode-guideline {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 300px;   /* wider for easier alignment */
    height: 160px;  /* much taller for less dead space */
    transform: translate(-50%, -50%);
    border: 3px solid red;
    border-radius: 8px;
    pointer-events: none;
    z-index: 10;
}

#barcodeScannerModal {
    z-index: 1080 !important;
}

#barcodeScannerModal + .modal-backdrop {
    z-index: 1079 !important;
}

@media (max-width: 999px) {
    #categoryTabs {
        display: none !important;
    }
    #categoryDropdownContainer {
        display: block !important;
    }
    
    body {
        padding-bottom: 80px; /* space for fixed bottom nav */
    }

    /* hide the top controls on mobile (we'll show mobile nav instead) */
    .inventory-top-controls {
        display: none !important;
    }

    /* mobile fixed bottom nav */
    #mobileBottomNav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 64px;
        background-color: #212529;
        border-top: 1px solid #dee2e6;
        z-index: 1200;
        justify-content: space-around;
        align-items: center;
        padding: 6px 10px;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
    }

    /* ensure icons/text are visible on dark background */
    #mobileBottomNav .btn,
    #mobileBottomNav .btn i {
        color: #ffffff;
    }

    #mobileBottomNav .btn {
        flex: 0 0 auto;
        font-size: 0.95rem;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
    }

    #mobileBottomNav .btn i {
        font-size: 1.15rem; /* default icon size */
    }

    /* Make the update icon larger than the other buttons */
    #mobileBottomNav .btn.update-btn i {
        font-size: 2.3rem; /* larger sync icon */
        color: rgb(57, 189, 180) !important;
        margin-bottom: 10px;
        margin-left: 4px;

    }

    /* ensure update button sits above its decorative circle */
    #mobileBottomNav .update-btn {
        position: relative;
        z-index: 2;
    }

    /* decorative circle behind the update button (same color as bar) */
    #mobileBottomNav .update-btn::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 94px;
        height: 94px;
        border-radius: 50%;
        background-color: #212529; /* same as bottom bar */
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.11);
        pointer-events: none;
        z-index: 1;
    }

    /* ensure the icon sits above the circle */
    #mobileBottomNav .update-btn i {
        position: relative;
        z-index: 3;
    }
}

@media (min-width: 1000px) {
    #categoryDropdownContainer {
        display: none !important;
    }
    
    /* Make table responsive with proper margins on larger screens */
    .tab-content table {
        width: calc(100% - 40px); /* Full container width minus left and right margins */
        min-width: fit-content;
        margin-left: 15px; /* Left margin */
        margin-right: 25px; /* Right margin */
        table-layout: auto;
    }
    
    /* Ensure the tab content container doesn't exceed viewport */
    .tab-content {
        overflow-x: auto;
        width: 100%;
        max-width: calc(100vw - 50px); /* Prevent exceeding viewport width */
        margin: 0;
        padding: 0;
    }
    
    /* Allow tabs to scroll horizontally if needed on large screens */
    .table-tabs {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        scrollbar-width: thin;
        margin-left: 50px; /* Keep existing tab margin */
    }
    
    .table-tabs .table-link {
        display: inline-block;
        flex-shrink: 0;
    }
    
    .table-tabs::-webkit-scrollbar {
        height: 6px;
    }
    
    .table-tabs::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .table-tabs::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .table-tabs::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Flexible container for large screens */
    .tab-content {
        overflow-x: auto;
        width: 100%; /* Use full width */
        margin-left: 0; /* No left margin */
    }
}

#categoryDropdown {
    width: 300px;
    margin-left: auto!important;
    margin-right: auto!important;
}

.status-header {
    width: 100px;
    text-align: center;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.status-ordered {
    background-color: #d4edda;
    color: #155724;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    display: none;
}

.popup-form {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    min-width: 300px;
}

.close-btn {
    margin-top: 10px;
}
.shopping-list-buttons {
    display: none; /* Hide by default */
}

.status-dropdown {
    background: none;
    border: none;
    cursor: pointer;
    width: 100%;
}

.status-dropdown:focus {
    outline: none;
}

/* TABLE-SPECIFIC DROPDOWN STYLES - RENAMED TO AVOID CONFLICTS */

/* Fix table dropdown positioning to extend beyond table */
.table-status-dropdown {
    position: relative;
    z-index: 1000;
}

/* When table dropdown is open, bring it to front */
.table-status-dropdown.show {
    z-index: 9998 !important;
}

.table-status-dropdown.show .table-dropdown-menu {
    z-index: 9999 !important;
}

/* Make sure the table dropdown menu can extend outside its parent */
.table-dropdown-menu {
    min-width: 120px;
    z-index: 9999 !important;
    position: absolute !important;
    background-color: white !important;
    border: 1px solid #dee2e6 !important;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    will-change: transform;
    top: 100% !important;
    left: 0 !important;
    min-width: 150px;
    max-height: none !important;
    overflow: visible !important;
    border-radius: 0.375rem !important;
}

/* For mobile devices, ensure even higher z-index for table dropdowns */
@media (max-width: 999px) {
    /* Adjust table dropdown positioning for mobile */
    .table-dropdown-menu {
        position: fixed !important; /* Use fixed positioning for mobile */
        z-index: 10000 !important; /* Even higher for mobile */
        min-width: 100px;
        max-width: 120px;
        right: 10px !important; /* Position from right edge */
        left: auto !important;
        background-color: white !important;
        border: 1px solid #dee2e6 !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.25) !important;
    }
    
    .table-status-dropdown.show {
        z-index: 9999 !important;
    }
    
    .table-status-dropdown.show .table-dropdown-menu {
        z-index: 10000 !important;
    }
}

/* Allow dropdown to extend beyond table container */
.tab-content {
    overflow: visible !important; /* Override any overflow hidden */
}

.tab-pane {
    overflow: visible !important; /* Override any overflow hidden */
}

table {
    overflow: visible !important; /* Override any overflow hidden */
}

tbody {
    overflow: visible !important; /* Override any overflow hidden */
}

.table-dropdown-item {
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 8px 12px;
}

.table-dropdown-item i {
    margin-right: 8px;
    width: 16px;
}

.table-dropdown-item:hover {
    background-color: #f8f9fa;
}

/* Ensure the entire page container allows overflow for dropdowns */
#categoryTabContent {
    overflow: visible !important;
}

/* Specifically for the shopping list table */
#category-shopping-list {
    overflow: visible !important;
}

#category-shopping-list table {
    overflow: visible !important;
}

@media (max-width: 999px) {
    #categoryTabs {
        display: none !important;
    }
    #categoryDropdownContainer {
        display: block !important;
    }
    
    /* Make the shopping list table responsive */
    #category-shopping-list table {
        width: 100% !important;
        table-layout: fixed;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* Set specific column widths for mobile */
    #category-shopping-list th:first-child,
    #category-shopping-list td:first-child {
        width: 50%; /* Item name */
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    #category-shopping-list th:nth-child(2),
    #category-shopping-list td:nth-child(2) {
        width: 15%; /* Quantity */
        text-align: center;
    }
    
    #category-shopping-list th:nth-child(3),
    #category-shopping-list td:nth-child(3) {
        width: 35%; /* Status */
        text-align: center;
        padding: 4px 2px;
    }
    
    /* Make status badges much smaller on mobile */
    .status-badge {
        padding: 1px 4px;
        border-radius: 6px;
        font-weight: bold;
        white-space: nowrap;
    }
    
    /* Adjust table dropdown positioning for mobile */
    .table-dropdown-menu {
        position: absolute !important;
        z-index: 1050;
        min-width: 100px;
        max-width: 120px;
        right: 0 !important;
        left: auto !important;
    }
    
    /* Ensure table dropdown items fit on mobile */
    .table-dropdown-item {
        padding: 4px 8px;
        white-space: nowrap;
    }
    
    .table-dropdown-item i {
        margin-right: 4px;
        width: 12px;
    }
    
    /* Make sure status column content fits */
    .status-dropdown {
        padding: 1px;
        width: 100%;
        border: none;
        background: transparent;
    }
    
    /* Ensure the tab content doesn't overflow */
    .tab-content {
        overflow-x: auto;
        width: 100%;
        padding: 0 10px;
    }
    
    .tab-pane {
        overflow-x: auto;
        width: 100%;
    }
}

.autocomplete-container {
    position: relative;
}

.autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.autocomplete-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.autocomplete-item:hover,
.autocomplete-item.selected {
    background-color: #f5f5f5;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.item-name {
    font-weight: bold;
    color: #333;
}

.item-category {
    font-size: 0.9em;
    color: #666;
    margin-left: 5px;
}

.item-units {
    font-size: 0.8em;
    color: #999;
    font-style: italic;
}

/* Order Soon tab specific styling */
#category-order-soon table {
    overflow: visible !important;
}

#category-order-soon th:nth-child(2),
#category-order-soon td:nth-child(2),
#category-order-soon th:nth-child(3),
#category-order-soon td:nth-child(3) {
    text-align: center;
}

/* Mobile responsive adjustments for Order Soon */
@media (max-width: 999px) {
    #category-order-soon th:first-child,
    #category-order-soon td:first-child {
        width: 50%; /* Item name */
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    #category-order-soon th:nth-child(2),
    #category-order-soon td:nth-child(2),
    #category-order-soon th:nth-child(3),
    #category-order-soon td:nth-child(3) {
        width: 25%; /* Current Qty and Threshold */
        text-align: center;
        font-size: 0.9em;
    }
}

/* Out of Stock tab specific styling */
#category-out-of-stock table {
    overflow: visible !important;
}

#category-out-of-stock th:first-child,
#category-out-of-stock td:first-child {
    width: 100%; /* Item name takes full width */
    word-wrap: break-word;
    overflow-wrap: break-word;
}
@media (max-width: 999px) {
    /* make wrapper size to content so arrow sits right after the visible text */
    th.item-header > .mobile-select-wrap {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    /* plain header-like select (no box) */
    th.item-header .mobile-select-wrap .form-select {
        display: inline-block;
        width: auto;
        padding: 0;
        margin: 0;
        height: auto;
        line-height: 1;
        border: none;
        background: transparent;
        color: #ffffff;
        font-weight: 600;
        box-shadow: none !important;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }

    /* hide native IE/Edge arrow */
    th.item-header .form-select::-ms-expand { display: none; }

    /* remove focus/hover box affordances */
    th.item-header .form-select:focus,
    th.item-header .form-select:hover,
    th.item-header .form-select:active {
        outline: none !important;
        box-shadow: none !important;
        background: transparent !important;
        border: none !important;
    }

    /* inline white triangle right after select text */
    th.item-header .mobile-dropdown-indicator {
        display: inline-block;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid #ffffff;
        pointer-events: none;
        margin-left: 4px;
    }

    /* keep option list contrast where supported */
    th.item-header .form-select,
    th.item-header .form-select option,
    th.item-header .form-select optgroup {
        background-color: #272630 !important;
        color: #ffffff !important;
    }
}
table {
    border-collapse: separate !important;
    border-spacing: 0;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #dee2e6;
    margin-bottom: 50px;
}

/* Default: Left corners always on first column */
table thead th:first-child {
    border-top-left-radius: 10px;
}

table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 10px;
}

/* Right corners for quantity column (2nd) on regular inventory tabs when delete is hidden */
table thead th:nth-child(2) {
    border-top-right-radius: 10px;
}


/* Delete column width constraint */
.delete-item-header,
.delete-item-column {
    width: 50px !important;
    min-width: 50px !important;
    max-width: 50px !important;
    text-align: center;
    padding: 8px 4px !important;
}

/* Make sure the delete button fits in the narrow column */
.delete-item-column .btn {
    padding: 2px 6px;
    font-size: 0.8em;
}

/* Ensure the trash icon fits */
.delete-item-column .fas {
    font-size: 0.9em;
}

/* New: control which column gets the right-side radius via container class */
.delete-hidden table thead th:nth-child(2),
.delete-hidden table tbody tr:last-child td:nth-child(2) {
    border-top-right-radius: 10px !important;

}

/* When delete column is visible, ensure qty column has no right radius and delete column gets it */
.delete-visible table thead th:nth-child(2),
.delete-visible table tbody tr:last-child td:nth-child(2) {
    border-top-right-radius: 0 !important;
}

.delete-visible table thead th.delete-column,
.delete-visible table tbody tr:last-child td.delete-column {
    border-top-right-radius: 10px !important;

}

</style>
{% endblock %}
{% block content %}
{% if not hide_inventory_controls %}
<h1 class="mt-4">Inventory</h1>

<!-- WRAPPED existing top controls so they can be hidden on mobile -->
<div class="inventory-top-controls">
    <div class="d-flex justify-content-start align-items-center mt-4">
        <div class="text-center me-3">
            <button type="button" class="btn btn-primarytwo" style="margin-left:15px;" onclick="updateInventory()">Update Inventory</button>
        </div>
        <div class="d-flex align-items-center">
            <button type="button" class="btn btn-secondary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addItemModal" style="font-weight: bold; font-size: 1em;">
                <span>+Add</span>
            </button>
            <button id="toggleDeleteColumn" onclick="toggleDeleteColumn()" class="btn btn-link btn-sm" style="text-decoration: none; font-weight: bold; font-size: 1.2em;">
                <i class="fas fa-trash-alt" style="color: red;"></i>
            </button>
        </div>
    </div>

    <div class="d-flex justify-content-start align-items-center mt-3" style="margin-left: 50px;">
        <div id="shoppingListButtons" class="shopping-list-buttons">
            <button type="button" class="btn btn-primary btn-sm me-2" onclick="toggleOrderForm()">
                <i class="fas fa-plus"></i> Add to Shopping List
            </button>
        </div>
    </div>
</div>

<!-- MOBILE: fixed bottom navigation (visible only on small screens via CSS) -->
<div id="mobileBottomNav" class="d-md-none" role="navigation" aria-label="Mobile actions">
    <button type="button" class="btn btn-link text-danger" onclick="toggleDeleteColumn()" title="Toggle Delete Column">
        <i class="fas fa-trash-alt"></i>
    </button>
    
    <button type="button" class="btn btn-secondary update-btn" onclick="updateInventory()" title="Update Inventory">
        <i class="fas fa-sync"></i>
    </button>

    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#addItemModal" title="Add Item">
        <i class="fas fa-plus"></i>
    </button>

   

   
</div>
{% endif %}

<!-- barcode scanner modal
<div class="modal fade" id="barcodeScannerModal" tabindex="-1" aria-labelledby="barcodeScannerModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="barcodeScannerModalLabel">Scan Barcode</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div id="scanner-container" style="position: relative;">
                <canvas></canvas>
                Guideline overlay 
                <div id="barcode-guideline"></div>
            </div>
        </div>
    </div>
</div>-->

<div id="updateMessage" class="alert alert-success mt-2" style="display: none;">Inventory Updated Successfully!</div>

<!-- Tabs for categories -->
<ul class="nav table-tabs d-none d-md-flex" id="categoryTabs" role="tablist">
    {% for category in categories %}
    <li class="nav-item" role="presentation">
        <button class="table-link {% if forloop.first %}active{% endif %}" id="tab-{{ category }}" data-bs-toggle="tab" data-bs-target="#category-{{ category|slugify }}" type="button" role="tab" aria-controls="category-{{ category|slugify }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
            {{ category }}
        </button>
    </li>
    {% endfor %}
    <!-- Add Shopping List tab -->
    <li class="nav-item" role="presentation">
        <button class="table-link" id="tab-shopping-list" data-bs-toggle="tab" data-bs-target="#category-shopping-list" type="button" role="tab" aria-controls="category-shopping-list" aria-selected="false">
            Shopping List
        </button>
    </li>
    <!-- Add Order Soon tab -->
    <li class="nav-item" role="presentation">
        <button class="table-link" id="tab-order-soon" data-bs-toggle="tab" data-bs-target="#category-order-soon" type="button" role="tab" aria-controls="category-order-soon" aria-selected="false">
            Order Soon
        </button>
    </li>
    <!-- Add Out of Stock tab -->
    <li class="nav-item" role="presentation">
        <button class="table-link" id="tab-out-of-stock" data-bs-toggle="tab" data-bs-target="#category-out-of-stock" type="button" role="tab" aria-controls="category-out-of-stock" aria-selected="false">
            Out of Stock
        </button>
    </li>
</ul>

<!-- Single table with dynamic content -->
<div class="tab-content" id="categoryTabContent">
    {% for category in categories %}
    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="category-{{ category|slugify }}" role="tabpanel" aria-labelledby="tab-{{ category }}">
        <table >
            <thead>
                <tr>
                    <th class="item-header">
                        <!-- Desktop: static label -->
                        <span class="d-none d-md-inline">Item</span>

                       <!-- Mobile: category dropdown becomes the header -->
                        <div class="d-block d-md-none mobile-select-wrap">
                            <select class="form-select form-select-sm" id="categoryDropdownHeader" aria-label="Select category (mobile header)">
                                {% for category in categories %}
                                <option value="category-{{ category|slugify }}" {% if forloop.first %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                                <option value="category-shopping-list">Shopping List</option>
                                <option value="category-order-soon">Order Soon</option>
                                <option value="category-out-of-stock">Out of Stock</option>
                            </select>
                            <span class="mobile-dropdown-indicator" aria-hidden="true"></span>
                        </div>
                    </th>
                    <th class="quantity-header">Qty</th>
                    <th class="delete-item-header delete-column" id="deleteColumnHeader"><i class="fas fa-trash-alt" style="color: white;"></i></th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory_items|dictsort:"item" %}
                {% if item.category == category %}
                <tr>
                    <td style="width: 150px;">
                        {{ item.item }}
                        {% if item.units %}
                        <span style="color: grey; font-size: smaller;"> ({{ item.units }})</span>
                        {% endif %}
                     <!--   {% if "Milk" in item.item %}
                        <div style="color: red; font-size: smaller;">Total received this week:</div>
                        {% endif %} -->
                    </td>
                    <td style="width: 100px;">
                        <form id="updateForm_{{ item.id }}" method="post" action="{% url 'edit_quantity' item.id %}" onsubmit="updateQuantity(event, item.id)">
                            {% csrf_token %}
                            <input type="number" step="1" min="0" id="new_quantity_{{ item.id }}" name="new_quantity" value="{{ item.quantity }}" required style="width: 85px;" data-original-value="{{ item.quantity }}">
                        <!--    {% if "Milk" in item.item %}
                            <input type="number" step="1" min="0" id="extra_milk_quantity_{{ item.id }}" name="extra_milk_quantity" placeholder=" +" style="width: 85px;">
                            {% endif %}  -->
                        </form>
                    </td>
                    <td class="delete-item-column delete-column" style="display: table-cell;">
                        <form method="post" action="{% url 'remove_item' item.id %}" onsubmit="handleDeleteItem(event)">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
    
    <!-- Shopping List Tab -->
    <div class="tab-pane fade" id="category-shopping-list" role="tabpanel" aria-labelledby="tab-shopping-list">
        <table>
            <thead>
                <tr>
                    <th class="item-header">Item</th>
                    <th class="quantity-header">Qty</th>
                    <th class="status-header">Status</th>
                </tr>
            </thead>
            <tbody id="shoppingListTableBody">
                <!-- Items will be populated via AJAX -->
            </tbody>
        </table>
    </div>

<!-- Order Soon Tab -->
<div class="tab-pane fade" id="category-order-soon" role="tabpanel" aria-labelledby="tab-order-soon">
    <table>
        <thead>
            <tr>
                <th class="item-header">Item</th>
                <th class="quantity-header">Current Qty</th>
                <th class="quantity-header">Qty Needed</th>  <!-- Changed from "Resupply Threshold" -->
            </tr>
        </thead>
        <tbody id="orderSoonTableBody">
            <!-- Items will be populated via AJAX -->
        </tbody>
    </table>
</div>
<!-- Out of Stock Tab -->
<div class="tab-pane fade" id="category-out-of-stock" role="tabpanel" aria-labelledby="tab-out-of-stock">
    <table>
        <thead>
            <tr>
                <th class="item-header">Item</th>
            </tr>
        </thead>
        <tbody id="outOfStockTableBody">
            <!-- Items will be populated via AJAX -->
        </tbody>
    </table>
</div>
<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm" method="post" action="{% url 'add_item' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="itemName" class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="itemName" name="item" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemCategory" class="form-label">Category</label>
                        <select class="form-control" id="itemCategory" name="category" required onchange="toggleNewCategoryInput(this)">
                            <option value="" disabled selected>Select category</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3" id="newCategoryInput" style="display: none;">
                        <label for="newCategory" class="form-label">New Category</label>
                        <input type="text" class="form-control" id="newCategory" name="new_category" placeholder="Enter new category">
                    </div>
                    <div class="mb-3">
                        <label for="itemUnits" class="form-label">Units</label>
                        <input type="text" class="form-control" id="itemUnits" name="units" placeholder="Enter unit (e.g., Indv., Case, etc.)" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemQuantity" class="form-label">Quantity</label>
                        <input type="number" step="1" min="0" class="form-control" id="itemQuantity" name="quantity" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemResupply" class="form-label">Resupply Threshold</label>
                        <input type="number" step="1" min="0" class="form-control" id="itemResupply" name="resupply" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemRule" class="form-label">Rule</label>
                        <select class="form-control" id="itemRule" name="rule">
                            <option value="">No Rule</option>
                            {% for rule in rules %}
                            <option value="{{ rule.id }}">{{ rule.rule }}</option>
                            {% endfor %}
                        </select>
                    </div>
                 <!--  <div class="mb-3>
                        <label for="barcode" class="form-label">Barcode</label>
                        <div class="d-flex align-items-center">
                            <input type="text" 
                                class="form-control" 
                                id="barcode" 
                                name="barcode" 
                                readonly 
                                required 
                                tabindex="-1"
                                style="background-color: #e9ecef; cursor: not-allowed;"
                                onpaste="return false;">
                            <button type="button" class="btn btn-warning ms-2" onclick="startBarcodeScanner(function(barcode){ document.getElementById('barcode').value = barcode; })">
                                <i class="fas fa-barcode"></i> Scan
                            </button>
                        </div>
                    </div>--> 
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div id="orderFormOverlay" class="popup-overlay" style="display: none;">
    <div class="popup-form">
        <h2>Add to Shopping List</h2>
        <form action="{% url 'order_list' %}" method="post">
            {% csrf_token %}
            <!-- Item input field with autocomplete -->
            <div class="form-group mb-3">
                <label for="item">Item:</label>
                <div class="autocomplete-container" style="position: relative;">
                    <input type="text" id="item" name="item" class="form-control" autocomplete="off" placeholder="Type to search inventory items...">
                    <div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display: none;">
                        <!-- Autocomplete suggestions will appear here -->
                    </div>
                </div>
            </div>
            <!-- Quantity input field -->
            <div class="form-group mb-3">
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" class="form-control" value="1">
            </div>
            <button type="submit" class="btn btn-primary me-2">Add to Shopping List</button>
            <button type="button" class="btn btn-danger close-btn" onclick="closeOrderForm()">Close</button>
        </form>
    </div>
</div>


{% endblock %}
{% block scripts %}
<script>
// Format quantity display on page load
document.addEventListener('DOMContentLoaded', function() {
    // Format all existing quantity inputs to show decimals only when needed
    document.querySelectorAll('input[id^="new_quantity_"]').forEach(function(input) {
        formatQuantityDisplay(input);
    });
});

function formatQuantityDisplay(input) {
    const originalValue = parseFloat(input.dataset.originalValue || input.value);
    
    // If it's a whole number, display without decimals
    if (originalValue === Math.floor(originalValue)) {
        input.value = Math.floor(originalValue);
    } else {
        // If it has decimals, show the full decimal value
        input.value = originalValue;
    }
}

// Optional: Format display when user finishes editing (on blur)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[id^="new_quantity_"]').forEach(function(input) {
        input.addEventListener('blur', function() {
            const value = parseFloat(this.value);
            if (!isNaN(value)) {
                if (value === Math.floor(value)) {
                    this.value = Math.floor(value);
                } else {
                    this.value = value;
                }
            }
        });
    });
});
</script>
<script>
        // Flag to track if there are unsaved changes
        let isFormChanged = false;
    
        // Mark the form as changed when any input field is modified
        document.querySelectorAll('form[id^="updateForm_"] input').forEach(function(input) {
            input.addEventListener('change', function() {
                isFormChanged = true;
            });
        });
    
        // Function to toggle the visibility of the popup form and background
        function togglePopup() {
            const popupBackground = document.getElementById('popupBackground');
            const popupForm = document.getElementById('popupForm');

            if (popupForm.style.display === 'block') {
                // Hide popup background and form
                popupBackground.style.display = 'none';
                popupForm.style.display = 'none';
            } else {
                // Show popup background and form
                popupBackground.style.display = 'block';
                popupForm.style.display = 'block';

                // Reset the form fields when opening the popup
                document.querySelector('#popupForm form').reset();
            }
        }
    
        function updateInventory() {
        // Show "Inventory submitting" message using Toastr
        toastr.info('Inventory is being updated. This may take a few minutes.', 'Updating Inventory', {
            timeOut: 0, // Disable auto-dismiss
            extendedTimeOut: 0,
            closeButton: true,
            progressBar: true
        });

        // Reset the unsaved changes flag (indicating changes are saved)
        isFormChanged = false;

        // Track the number of AJAX requests
        let totalRequests = 0;
        let completedRequests = 0;

        // Iterate over each form and perform AJAX request
        const forms = $('form[id^="updateForm_"]');
        totalRequests = forms.length;

        forms.each(function () {
            const form = $(this);
            const itemId = form.attr('id').split('_')[1];
            const newQuantity = form.find('#new_quantity_' + itemId).val();
            const extraMilkQuantity = form.find('#extra_milk_quantity_' + itemId).val();

            // Perform AJAX request to update inventory
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: {
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                    new_quantity: newQuantity,
                    extra_milk_quantity: extraMilkQuantity,
                    inventory_item_id: itemId
                },
                success: function (response) {
                    console.log(`Inventory for item ${itemId} updated successfully`);
                },
                error: function (xhr, status, error) {
                    console.error(`Failed to update inventory for item ${itemId}`, error);
                    // Show error message using Toastr
                    toastr.error(`Error updating inventory for item ${itemId}. Please try again.`, 'Error', {
                        timeOut: 5000, // Auto-dismiss after 5 seconds
                        closeButton: true,
                        progressBar: true
                    });
                },
                complete: function () {
                    completedRequests++;

                    // Check if all requests are completed
                    if (completedRequests === totalRequests) {
                        // Show success message using Toastr once
                        toastr.clear(); // Clear the "Please wait" message
                        toastr.success('Inventory updated successfully!', 'Success', {
                            timeOut: 3000, // Auto-dismiss after 3 seconds
                            closeButton: true,
                            progressBar: true
                        });
                    }
                }
            });
        });
    }
    
        // Before the user leaves the page, show a confirmation dialog if there are unsaved changes
    // Enhanced unsaved-change handling:
    // - Show a toastr confirm for in-page link clicks and form submits when there are unsaved changes.
    // - Keep native beforeunload fallback for browser-level navigation (close / address bar / back).
    (function() {
    let unsavedToastVisible = false;
    let suppressBeforeUnload = false; // flag to avoid native dialog when user confirmed leave

    function showUnsavedToastr(onProceed) {
        if (unsavedToastVisible) return;
        unsavedToastVisible = true;

        // remove any existing toasts first (clean slate)
        try { toastr.remove(); toastr.clear(); } catch (e) {}

        const toastHtml =
            '<div>You have unsaved changes.</div><br>' +
            '<button id="ts-stay" class="btn btn-sm btn-secondary me-2">Stay</button>' +
            '<button id="ts-leave" class="btn btn-sm btn-danger">Leave without saving</button>';

        toastr.warning(toastHtml, 'Unsaved Changes', {
            allowHtml: true,
            timeOut: 0,
            extendedTimeOut: 0,
            closeButton: false,
            tapToDismiss: false,
            onHidden: function() { unsavedToastVisible = false; }
        });

        // Use document-level click handler (works for DOM-inserted buttons)
        function onToastButtonClick(e) {
            const id = e.target && e.target.id;
            if (id !== 'ts-stay' && id !== 'ts-leave') return;

            // prevent other handlers
            e.stopPropagation();
            e.preventDefault();

            // Always remove the toast DOM immediately
            try { toastr.remove(); toastr.clear(); } catch (err) {}

            if (id === 'ts-stay') {
                // user chose to stay: just close toast and keep isFormChanged true
                unsavedToastVisible = false;
                // remove handler
                document.removeEventListener('click', onToastButtonClick, true);
                return;
            }

            if (id === 'ts-leave') {
                // user chose to leave: suppress native beforeunload and proceed
                suppressBeforeUnload = true;
                isFormChanged = false;

                // small delay to ensure beforeunload handler sees suppression
                setTimeout(function() {
                    if (typeof onProceed === 'function') onProceed();
                    // restore suppression briefly after navigation attempt
                    setTimeout(function(){ suppressBeforeUnload = false; }, 500);
                }, 10);

                unsavedToastVisible = false;
                document.removeEventListener('click', onToastButtonClick, true);
                return;
            }
        }

        // listen in capture phase so we catch clicks inside the toast quickly
        document.addEventListener('click', onToastButtonClick, true);
    }

    // Intercept same-origin anchor clicks
    document.addEventListener('click', function(e) {
        if (!isFormChanged) return;
        const a = e.target.closest('a[href]');
        if (!a) return;
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || href.startsWith('javascript:') || a.target === '_blank' || a.hasAttribute('data-no-confirm')) return;
        const linkUrl = new URL(href, location.href);
        if (linkUrl.origin !== location.origin) return; // external links proceed
        e.preventDefault();
        showUnsavedToastr(function() { location.href = linkUrl.href; });
    }, true);

    // Intercept form submissions (except the update forms and forms that opt-out)
    document.addEventListener('submit', function(e) {
        if (!isFormChanged) return;
        const form = e.target;
        if (!form || !(form.tagName === 'FORM')) return;
        if (form.matches('form[id^="updateForm_"]') || form.hasAttribute('data-no-confirm')) return;
        e.preventDefault();
        showUnsavedToastr(function() {
            // mark suppressed and clear flag before submitting to avoid native dialog
            suppressBeforeUnload = true;
            isFormChanged = false;
            form.submit();
            setTimeout(function(){ suppressBeforeUnload = false; }, 500);
        });
    }, true);

    // Native fallback for browser-level navigation (can't be replaced by custom UI)
    window.addEventListener('beforeunload', function(e) {
        if (isFormChanged && !suppressBeforeUnload) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });
})();
    
        // Toggle visibility of delete columns
        function toggleDeleteColumn() {
            var deleteColumnElements = document.querySelectorAll('.delete-column');
            var container = document.getElementById('categoryTabContent') || document.querySelector('.tab-content') || document.body;
            var anyVisible = false;

            deleteColumnElements.forEach(function(element) {
                // Use computed style to determine current visibility
                var isVisible = window.getComputedStyle(element).display !== 'none';
                if (isVisible) {
                    element.style.display = 'none';
                } else {
                    // Make sure table cells show correctly
                    element.style.display = 'table-cell';
                    anyVisible = true;
                }
            });

            if (anyVisible) {
                container.classList.add('delete-visible');
                container.classList.remove('delete-hidden');
            } else {
                container.classList.add('delete-hidden');
                container.classList.remove('delete-visible');
            }
        }
    
        // Function to run when the page loads
        window.onload = function() {
            // Toggle the visibility of the delete items column
            toggleDeleteColumn();
        };

        let isSubmitting = false; // Flag to prevent duplicate submissions

        function handleAddItem(event) {
            event.preventDefault(); // Prevent the default form submission

            if (isSubmitting) return; // Prevent duplicate submissions
            isSubmitting = true;

            const form = event.target;

            $.ajax({
                url: form.action,
                type: form.method,
                data: $(form).serialize(),
                success: function(response) {
                    toastr.success('Item added successfully!', 'Success', {
                        timeOut: 2000, // Auto-dismiss after 2 seconds
                        closeButton: true,
                        progressBar: true
                    });

                    // Close the popup after success
                    togglePopup();

                    // Refresh the page after a shorter delay
                    setTimeout(() => {
                        location.reload();
                    }, 500); // Reduced delay to 0.5 seconds
                },
                error: function(xhr, status, error) {
                    toastr.error('Failed to add item. Please try again.', 'Error', {
                        timeOut: 5000, // Auto-dismiss after 5 seconds
                        closeButton: true,
                        progressBar: true
                    });
                },
                complete: function() {
                    isSubmitting = false; // Reset the flag after the request completes
                }
            });
        }

        function handleDeleteItem(event) {
            event.preventDefault(); // Prevent the default form submission

            const form = event.target;

            if (isSubmitting) return; // Prevent duplicate submissions
            isSubmitting = true;

            // Show the Toastr notification immediately
            toastr.info('Deleting item...', 'Please Wait', {
                timeOut: 2000, // Auto-dismiss after 2 seconds
                closeButton: true,
                progressBar: true
            });

            $.ajax({
                url: form.action,
                type: form.method,
                data: $(form).serialize(),
                success: function(response) {
                    // Show success message using Toastr
                    toastr.success('Item deleted successfully!', 'Success', {
                        timeOut: 1000,
                        closeButton: true,
                        progressBar: true
                    });

                    // Refresh the page immediately after showing success message
                    setTimeout(() => {
                        location.reload();
                    }, 500); // Reduced delay to 0.5 seconds
                },
                error: function(xhr, status, error) {
                    // Show error message using Toastr
                    toastr.error('Failed to delete item. Please try again.', 'Error', {
                        timeOut: 5000,
                        closeButton: true,
                        progressBar: true
                    });
                    isSubmitting = false; // Reset flag on error
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Select all delete forms and bind the handleDeleteItem function
            document.querySelectorAll('form[onsubmit="handleDeleteItem(event)"]').forEach(function (form) {
                form.addEventListener('submit', handleDeleteItem);
            });
        });

    function toggleNewCategoryInput(selectElement) {
        const newCategoryInput = document.getElementById('newCategoryInput');
        if (selectElement.value === 'Other') {
            newCategoryInput.style.display = 'block';
        } else {
            newCategoryInput.style.display = 'none';
            document.getElementById('newCategory').value = ''; // Clear the input field
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const addItemForm = document.getElementById('addItemForm');

        addItemForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            const formData = new FormData(addItemForm);

            fetch(addItemForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload(); // Reload the page after success
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });

    const barcodeImage = document.getElementById('barcodeImage');
    if (barcodeImage) {
        barcodeImage.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.style.maxWidth = '100%';
                    preview.style.marginTop = '10px';
                    document.getElementById('addItemForm').appendChild(preview);
                };
                reader.readAsDataURL(file);
            }
        });
    }

 
</script>
<script>
document.addEventListener('deviceready', function () {
    // Request only CAMERA permission
    if (window.cordova && cordova.plugins && cordova.plugins.permissions) {
        var permissions = cordova.plugins.permissions;
        permissions.requestPermission(permissions.CAMERA,
            function(status) {
                if (!status.hasPermission) {
                    alert('Camera permission is required for barcode scanning.');
                }
            },
            function() {
                alert('Permission request failed');
            }
        );
    }
});
</script>
<script>
function startBarcodeScanner(onDetectedCallback) {
    if (window.cordova && cordova.plugins && cordova.plugins.permissions) {
        var permissions = cordova.plugins.permissions;
        permissions.hasPermission(permissions.CAMERA, function(status) {
            if (!status.hasPermission) {
                permissions.requestPermission(permissions.CAMERA, function(status2) {
                    if (status2.hasPermission) {
                        launchBarcodeScanner(onDetectedCallback);
                    } else {
                        alert('Camera permission is required for barcode scanning.');
                    }
                }, function() {
                    alert('Permission request failed');
                });
            } else {
                launchBarcodeScanner(onDetectedCallback);
            }
        }, function() {
            alert('Permission check failed');
        });
    } else {
        // Not Cordova, assume permissions are granted
        launchBarcodeScanner(onDetectedCallback);
    }
}

function launchBarcodeScanner(onDetectedCallback) {
    const modal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'));
    modal.show();
    if (typeof Quagga === "undefined") {
        alert("Barcode scanner not available.");
        return;
    }
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#scanner-container'),
            constraints: {
                facingMode: "environment",
                width: { ideal: 360 },
                height: { ideal: 640 }
            },
            area: {
                top: "38%",
                right: "8%",
                left: "8%",
                bottom: "38%"
            }
        },
        decoder: {
            readers: [
                "code_128_reader",
                "ean_reader",
                "ean_8_reader",
                "upc_reader",
                "code_39_reader",
                "i2of5_reader",
                "2of5_reader"
            ],
            multiple: false
        },
        locate: true,
        locator: {
            patchSize: "medium",
            halfSample: false
        },
        numOfWorkers: 2,
        frequency: 25
    }, function(err) {
        if (err) {
            console.error(err);
            alert("Failed to initialize barcode scanner.");
            return;
        }
        Quagga.start();
    });
    Quagga.offDetected();
    Quagga.onDetected(function(result) {
        let barcode = result.codeResult.code;
        console.log("Barcode detected:", barcode);

        if (typeof Quagga !== "undefined") {
            Quagga.stop();
        }
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('barcodeScannerModal'));
        modalInstance.hide();
        toastr.success(`Barcode detected: ${barcode}`, "Success");

        if (typeof onDetectedCallback === "function") {
            onDetectedCallback(barcode);
        }
    });

    document.getElementById('barcodeScannerModal').addEventListener('hidden.bs.modal', function () {
        if (typeof Quagga !== "undefined") {
            Quagga.stop();
        }
    });
}
</script>
<!-- Add this to your inventory_list.html (or the remote template at https://tot-time.com/inventory_list) -->
<script>
function startWebBarcodeScanner(onDetectedCallback) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'));
    modal.show();

    // Get the video element or create one
    let video = document.createElement('video');
    video.setAttribute('autoplay', '');
    video.setAttribute('playsinline', '');
    video.style.width = "100%";
    video.style.height = "100%";
    const scannerContainer = document.getElementById('scanner-container');
    scannerContainer.innerHTML = '';
    scannerContainer.appendChild(video);

    // Access the camera
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                video.srcObject = stream;

                // Use QuaggaJS for barcode scanning
                if (typeof Quagga !== "undefined") {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: video,
                            constraints: {
                                facingMode: "environment"
                            }
                        },
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "upc_reader",
                                "code_39_reader",
                                "i2of5_reader",
                                "2of5_reader"
                            ],
                            multiple: false
                        }
                    }, function(err) {
                        if (err) {
                            alert("Failed to initialize barcode scanner: " + err);
                            return;
                        }
                        Quagga.start();
                    });

                    Quagga.offDetected();
                    Quagga.onDetected(function(result) {
                        let barcode = result.codeResult.code;
                        Quagga.stop();
                        // Stop the camera stream
                        if (video.srcObject) {
                            video.srcObject.getTracks().forEach(track => track.stop());
                        }
                        modal.hide();
                        toastr.success(`Barcode detected: ${barcode}`, "Success");
                        if (typeof onDetectedCallback === "function") {
                            onDetectedCallback(barcode);
                        }
                    });

                    // Stop Quagga and camera when modal is closed
                    document.getElementById('barcodeScannerModal').addEventListener('hidden.bs.modal', function () {
                        if (typeof Quagga !== "undefined") {
                            Quagga.stop();
                        }
                        if (video.srcObject) {
                            video.srcObject.getTracks().forEach(track => track.stop());
                        }
                    }, { once: true });
                } else {
                    alert("Barcode scanner library not loaded.");
                }
            })
            .catch(function(err) {
                alert('Camera access denied: ' + err.message);
            });
    } else {
        alert('Camera API not supported in this browser.');
    }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // central activation routine (keeps tabs, tab-buttons and all dropdowns in sync)
    function activateCategory(tabId) {
        // show selected pane
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show','active'));
        const pane = document.getElementById(tabId);
        if (pane) pane.classList.add('show','active');

        // update tab buttons (bootstrap .table-link)
        document.querySelectorAll('.table-link').forEach(btn => btn.classList.remove('active'));
        const tabBtn = document.querySelector(`button[data-bs-target="#${tabId}"]`);
        if (tabBtn) tabBtn.classList.add('active');

        // sync all selects (central + any header selects)
        document.querySelectorAll('#categoryDropdown, #categoryDropdownHeader').forEach(sel => {
            if (sel) sel.value = tabId;
        });
    }

    // unified change handler for selects
    function onCategorySelectChange(e) {
        const val = e.target.value;
        if (!val) return;
        activateCategory(val);
    }

    // wire central mobile dropdown
    const central = document.getElementById('categoryDropdown');
    if (central) central.addEventListener('change', onCategorySelectChange);

    // wire any header-selects (there may be one or multiple)
    document.querySelectorAll('#categoryDropdownHeader').forEach(sel => {
        sel.addEventListener('change', onCategorySelectChange);
    });

    // If you initialize page with a selected dropdown value, ensure UI is in sync
    // prefer central dropdown value, fallback to first header select
    const initial = (central && central.value) ? central.value :
                    (document.querySelector('#categoryDropdownHeader') && document.querySelector('#categoryDropdownHeader').value)
                    || null;
    if (initial) activateCategory(initial);
});
</script>
<script>
// Function to fetch and display shopping list items with dropdown status buttons
function fetchShoppingListItemsForTable() {
    $.ajax({
        url: '/api/shopping-list',
        method: 'GET',
        success: function(response) {
            $('#shoppingListTableBody').empty();
            if (response.length === 0) {
                $('#shoppingListTableBody').append(
                    '<tr><td colspan="3" style="text-align: center; color: #666;">No items in shopping list</td></tr>'
                );
            } else {
                response.forEach(function(item, index) {
                    var itemId = item.id || index;
                    var statusBadge = item.ordered ? 
                        '<span class="status-badge status-ordered"><i class="fas fa-check me-1"></i>Ordered</span>' : 
                        '<span class="status-badge status-pending"><i class="fas fa-clock me-1"></i>Pending</span>';
                    
                    $('#shoppingListTableBody').append(
                        '<tr>' +
                        '<td style="width: 150px;">' + item.name + '</td>' +
                        '<td style="width: 100px;">' + (item.quantity || 1) + '</td>' +
                        '<td style="width: 100px; text-align: center;">' +
                        '<div class="table-status-dropdown">' +
                        '<button class="status-dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">' +
                        statusBadge +
                        '</button>' +
                        '<ul class="table-dropdown-menu dropdown-menu">' +
                        '<li><a class="table-dropdown-item dropdown-item" href="#" onclick="updateItemStatus(' + itemId + ', false)"><i class="fas fa-clock text-warning"></i>Pending</a></li>' +
                        '<li><a class="table-dropdown-item dropdown-item" href="#" onclick="updateItemStatus(' + itemId + ', true)"><i class="fas fa-check text-success"></i>Ordered</a></li>' +
                        '<li><hr class="dropdown-divider"></li>' +
                        '<li><a class="table-dropdown-item dropdown-item text-danger" href="#" onclick="deleteShoppingListItem(' + itemId + ')"><i class="fas fa-trash-alt text-danger"></i>Delete</a></li>' +
                        '</ul>' +
                        '</div>' +
                        '</td>' +
                        '</tr>'
                    );
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching shopping list items:', error);
            $('#shoppingListTableBody').append(
                '<tr><td colspan="3" style="text-align: center; color: #ff0000;">Error loading shopping list</td></tr>'
            );
        }
    });
}

// Function to update individual item status
function updateItemStatus(itemId, ordered) {
    $.ajax({
        url: '/api/update-shopping-item-status/',
        method: 'POST',
        headers: {
            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify({
            'item_id': itemId,
            'ordered': ordered
        }),
        success: function(response) {
            var statusText = ordered ? 'ordered' : 'pending';
            toastr.success('Item marked as ' + statusText + '!', 'Success');
            fetchShoppingListItemsForTable(); // Refresh the table
        },
        error: function(xhr, status, error) {
            toastr.error('Error updating item status', 'Error');
        }
    });
}

// Function to delete shopping list item with confirmation
function deleteShoppingListItem(itemId) {
    // Aggressively clear all toastr notifications
    toastr.remove();
    toastr.clear();
    
    // Create a unique toast ID for this confirmation
    var toastId = 'delete-confirm-' + itemId;
    
    // Show confirmation toastr with specific ID
    toastr.warning(
        '<div>Are you sure you want to delete this item?</div>' +
        '<br><button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteItem(' + itemId + ')">Yes, Delete</button> ' +
        '<button type="button" class="btn btn-sm btn-secondary" onclick="cancelDelete()">Cancel</button>',
        'Confirm Delete',
        {
            allowHtml: true,
            timeOut: 0,
            extendedTimeOut: 0,
            closeButton: false,
            tapToDismiss: false,
            preventDuplicates: true,
            toastId: toastId
        }
    );
}

// Function to cancel delete - more aggressive clearing
function cancelDelete() {
    // Remove all toastr notifications immediately
    $('.toast').remove();
    toastr.remove();
    toastr.clear();
    
    // Force clear the toastr container
    $('#toast-container').empty();
}

// Function to actually delete the item after confirmation
function confirmDeleteItem(itemId) {
    // More aggressive clearing approach
    $('.toast').remove();
    toastr.remove();
    toastr.clear();
    $('#toast-container').empty();
    
    // Small delay to ensure DOM cleanup
    setTimeout(function() {
        $.ajax({
            url: '/api/delete-shopping-item/' + itemId + '/',
            method: 'DELETE',
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                fetchShoppingListItemsForTable(); // Refresh the table
                toastr.success('Item deleted successfully!', 'Success');
            },
            error: function(xhr, status, error) {
                toastr.error('Error deleting item', 'Error');
            }
        });
    }, 50);
}


$(document).ready(function() {
    // Hide overlays initially
    $("#orderFormOverlay").hide();
    
    // Load shopping list when the tab is clicked
    $('#tab-shopping-list').on('click', function() {
        setTimeout(function() {
            fetchShoppingListItemsForTable();
        }, 100);
    });
    
    // Also load when dropdown changes (for mobile)
    $('#categoryDropdown').on('change', function() {
        var selectedValue = $(this).val();
        if (selectedValue === 'category-shopping-list') {
            setTimeout(function() {
                fetchShoppingListItemsForTable();
            }, 100);
        }
    });
    
    // Handle form submissions with AJAX to avoid page refresh
    $('#orderFormOverlay form').on('submit', function(e) {
        e.preventDefault();
        
        // Clean the item input
        var itemInput = $("#item");
        var cleanedItem = itemInput.val().trim().toLowerCase().replace(/\b\w/g, function(match) {
            return match.toUpperCase();
        });
        itemInput.val(cleanedItem);
        
        // Submit via AJAX
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                closeOrderForm();
                fetchShoppingListItemsForTable(); // Refresh the shopping list table
                toastr.success('Item added to shopping list!', 'Success');
                $('#orderFormOverlay form')[0].reset(); // Reset form
            },
            error: function(xhr, status, error) {
                toastr.error('Error adding item to shopping list', 'Error');
            }
        });
    });
    
    // Function to show/hide shopping list buttons
    function toggleShoppingListButtons(show) {
        if (show) {
            $('#shoppingListButtons').show();
        } else {
            $('#shoppingListButtons').hide();
        }
    }
    
    // Hide buttons initially
    $('#shoppingListButtons').hide();
    
    // Show buttons when shopping list tab is clicked
    $('#tab-shopping-list').on('click', function() {
        toggleShoppingListButtons(true);
    });
    
    // Hide buttons when other tabs are clicked
    $('button[id^="tab-"]:not(#tab-shopping-list)').on('click', function() {
        toggleShoppingListButtons(false);
    });
    
    // Handle table dropdown show/hide events to manage z-index
    $(document).on('show.bs.dropdown', '.table-status-dropdown', function() {
        $(this).css('z-index', '9998');
        $(this).find('.table-dropdown-menu').css('z-index', '9999');
    });
    
    $(document).on('hide.bs.dropdown', '.table-status-dropdown', function() {
        $(this).css('z-index', '1000');
        $(this).find('.table-dropdown-menu').css('z-index', '1050');
    });
    
    // Close other table dropdowns when one is opened
    $(document).on('show.bs.dropdown', '.table-status-dropdown', function() {
        $('.table-status-dropdown').not(this).removeClass('show');
        $('.table-dropdown-menu').not($(this).find('.table-dropdown-menu')).removeClass('show');
    });
});
$(document).ready(function() {
    let inventoryItems = [];
    let selectedIndex = -1;
    
    // Collect all inventory items on page load
    function collectInventoryItems() {
        inventoryItems = [];
        $('table tbody tr').each(function() {
            const itemCell = $(this).find('td:first-child');
            if (itemCell.length > 0) {
                const itemText = itemCell.text().trim();
                if (itemText && !itemText.includes('No items in shopping list') && !itemText.includes('Error loading')) {
                    // Extract item name (before units if present)
                    const itemName = itemText.split('(')[0].trim();
                    const unitsMatch = itemText.match(/\(([^)]+)\)/);
                    const units = unitsMatch ? unitsMatch[1] : '';
                    
                    // Get category from the tab
                    const tabPane = $(this).closest('.tab-pane');
                    const tabId = tabPane.attr('id');
                    let category = '';
                    if (tabId && tabId.startsWith('category-')) {
                        category = tabId.replace('category-', '').replace(/-/g, ' ');
                        category = category.charAt(0).toUpperCase() + category.slice(1);
                    }
                    
                    inventoryItems.push({
                        name: itemName,
                        units: units,
                        category: category,
                        fullText: itemText
                    });
                }
            }
        });
    }
    
    // Filter items based on input
    function filterItems(query) {
        if (!query || query.length < 1) return [];
        
        query = query.toLowerCase();
        return inventoryItems.filter(item => 
            item.name.toLowerCase().includes(query) ||
            item.category.toLowerCase().includes(query)
        ).slice(0, 10); // Limit to 10 results
    }
    
    // Render autocomplete dropdown
    function renderDropdown(items) {
        const dropdown = $('#autocomplete-dropdown');
        dropdown.empty();
        
        if (items.length === 0) {
            dropdown.hide();
            return;
        }
        
        items.forEach((item, index) => {
            const div = $('<div>')
                .addClass('autocomplete-item')
                .attr('data-index', index)
                .html(
                    '<span class="item-name">' + item.name + '</span>' +
                    '<span class="item-category">(' + item.category + ')</span>' +
                    (item.units ? '<br><span class="item-units">' + item.units + '</span>' : '')
                );
            dropdown.append(div);
        });
        
        dropdown.show();
        selectedIndex = -1;
    }
    
    // Handle item selection
    function selectItem(item) {
        $('#item').val(item.name);
        $('#autocomplete-dropdown').hide();
        selectedIndex = -1;
        $('#quantity').focus(); // Move focus to quantity field
    }
    
    // Update selected item highlight
    function updateSelection() {
        $('.autocomplete-item').removeClass('selected');
        if (selectedIndex >= 0) {
            $('.autocomplete-item[data-index="' + selectedIndex + '"]').addClass('selected');
        }
    }
    
    // Initialize autocomplete when order form is opened
    window.toggleOrderForm = function() {
        const overlay = $("#orderFormOverlay");
        if (overlay.is(':visible')) {
            overlay.hide();
        } else {
            collectInventoryItems(); // Refresh inventory items
            overlay.show();
            $('#item').focus(); // Focus on the input field
        }
    };
    
    // Input event handler
    $('#item').on('input', function() {
        const query = $(this).val();
        const filteredItems = filterItems(query);
        renderDropdown(filteredItems);
    });
    
    // Keyboard navigation
    $('#item').on('keydown', function(e) {
        const dropdown = $('#autocomplete-dropdown');
        const items = $('.autocomplete-item');
        
        if (!dropdown.is(':visible')) return;
        
        switch(e.keyCode) {
            case 40: // Arrow down
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection();
                break;
                
            case 38: // Arrow up
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
                break;
                
            case 13: // Enter
                e.preventDefault();
                if (selectedIndex >= 0) {
                    const selectedItem = inventoryItems.filter(item => 
                        filterItems($(this).val()).includes(item)
                    )[selectedIndex];
                    if (selectedItem) {
                        selectItem(selectedItem);
                    }
                }
                break;
                
            case 27: // Escape
                dropdown.hide();
                selectedIndex = -1;
                break;
        }
    });
    
    // Click handler for dropdown items
    $(document).on('click', '.autocomplete-item', function() {
        const index = parseInt($(this).attr('data-index'));
        const query = $('#item').val();
        const filteredItems = filterItems(query);
        if (filteredItems[index]) {
            selectItem(filteredItems[index]);
        }
    });
    
    // Hide dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.autocomplete-container').length) {
            $('#autocomplete-dropdown').hide();
            selectedIndex = -1;
        }
    });
    
    // Hide dropdown when form is closed
    window.closeOrderForm = function() {
        $("#orderFormOverlay").hide();
        $('#autocomplete-dropdown').hide();
        selectedIndex = -1;
    };
});
</script>
<script>
window.toggleOrderForm = function() {
    $("#orderFormOverlay").toggle();
};

window.closeOrderForm = function() {
    $("#orderFormOverlay").hide();
};
</script>
<script>
// Function to fetch and display order soon items
function fetchOrderSoonItemsForTable() {
    $.ajax({
        url: '/api/order-soon-items/',
        method: 'GET',
        success: function(response) {
            console.log('Order Soon API Response:', response);
            $('#orderSoonTableBody').empty();
            if (response.length === 0) {
                $('#orderSoonTableBody').append(
                    '<tr><td colspan="3" style="text-align: center; color: #666;">No items need ordering soon</td></tr>'
                );
            } else {
                response.forEach(function(item) {
                    console.log('Individual item:', item);
                    $('#orderSoonTableBody').append(
                        '<tr>' +
                        '<td style="width: 150px;">' + 
                        item.name + 
                        (item.units ? '<span style="color: grey; font-size: smaller;"> (' + item.units + ')</span>' : '') +
                        '</td>' +
                        '<td style="width: 100px; text-align: center;">' + (item.current_qty !== undefined && item.current_qty !== null ? item.current_qty : 'N/A') + '</td>' +  // Fixed: properly handle 0
                        '<td style="width: 100px; text-align: center; color: #d9534f; font-weight: bold;">' + (item.shortage !== undefined && item.shortage !== null ? item.shortage : 'N/A') + '</td>' +  // Fixed: properly handle 0
                        '</tr>'
                    );
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching order soon items:', error);
            console.log('Full error response:', xhr.responseText);
            $('#orderSoonTableBody').append(
                '<tr><td colspan="3" style="text-align: center; color: #ff0000;">Error loading order soon items</td></tr>'
            );
        }
    });
}

$(document).ready(function() {
    // ...existing code...
    
    // Load order soon items when the tab is clicked
    $('#tab-order-soon').on('click', function() {
        setTimeout(function() {
            fetchOrderSoonItemsForTable();
        }, 100);
    });
    
    // Also load when dropdown changes (for mobile)
   
    $('#categoryDropdown').on('change', function() {
        var selectedValue = $(this).val();
        if (selectedValue === 'category-order-soon') {
            setTimeout(function() {
                fetchOrderSoonItemsForTable();
            }, 100);
        }
    });
    
    // Hide shopping list buttons when other tabs are clicked (update existing code)
    $('button[id^="tab-"]:not(#tab-shopping-list)').on('click', function() {
        toggleShoppingListButtons(false);
    });
});
</script>
<script>
// Move this outside of $(document).ready() to ensure it's always available
function fetchOutOfStockItemsForTable() {
    $.ajax({
        url: '/api/out-of-stock-items/',
        method: 'GET',
        success: function(response) {
            // Try multiple ways to target the element
            var tableBody = $('#outOfStockTableBody');
            var tableBodyAlt = $('#category-out-of-stock tbody');
            
            // Use the method that works
            var targetElement = tableBody.length > 0 ? tableBody : tableBodyAlt;
            
            if (targetElement.length === 0) {
                console.error('Could not find target table body element!');
                return;
            }
            
            // Clear and populate
            targetElement.empty();
            
            if (response.length === 0) {
                targetElement.append(
                    '<tr><td style="text-align: center; color: #666;">No items are out of stock</td></tr>'
                );
            } else {
                response.forEach(function(item) {
                    targetElement.append(
                        '<tr>' +
                        '<td style="width: 100%; word-wrap: break-word; overflow-wrap: break-word;">' + 
                        item.name + 
                        '</td>' +
                        '</tr>'
                    );
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error fetching out of stock items:', error);
            $('#outOfStockTableBody, #category-out-of-stock tbody').append(
                '<tr><td style="text-align: center; color: #ff0000;">Error loading out of stock items</td></tr>'
            );
        }
    });
}

$(document).ready(function() {
    // Load out of stock items when the tab is clicked
    $('#tab-out-of-stock').on('click', function() {
        setTimeout(function() {
            fetchOutOfStockItemsForTable();
        }, 100);
    });
    
    // Listen for Bootstrap tab shown event
    $('#tab-out-of-stock').on('shown.bs.tab', function() {
        fetchOutOfStockItemsForTable();
    });
    
    // Load when dropdown changes (for mobile)
    $('#categoryDropdown').on('change', function() {
        var selectedValue = $(this).val();
        if (selectedValue === 'category-out-of-stock') {
            setTimeout(function() {
                fetchOutOfStockItemsForTable();
            }, 100);
        }
    });
});
</script>

{% endblock %}

{% extends 'tottimeapp/base_dynamic.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Daily Attendance{% endblock %}

{% block styles %}
<style>


.over-ratio {
        color: red;
    }
.under-ratio {
        color: rgb(255, 255, 255);
    }

.btn-assign {

    background-color: rgb(57, 189, 180); /* Change success button color */
    border-color: rgb(57, 189, 180);
    color: rgb(33, 31, 39);
    font-size: 17px;
    font-weight: 500;
    padding: 4px 6px !important; /* Add padding for more space */
    
}

/* Additional hover styles (optional) */
.btn-assign:hover {
    background-color: #007b8a;
    border-color: #007b8a;
}
.btn-unassign {

    background-color:rgb(224, 106, 106); /* Change success button color */
    border-color: rgb(224, 106, 106);
    color: rgb(33, 31, 39);
    font-size: 17px;
    font-weight: 500;
    padding: 4px 6px !important; /* Add padding for more space */
    
}

/* Additional hover styles (optional) */
.btn-unassign:hover {
    background-color: rgb(169, 68, 68);
    border-color: rgb(169, 68, 68);
}
.btn-rec {
margin-top: 10px;
background-color: rgb(153, 158, 158); /* Change success button color */
border-color: rgb(153, 158, 158);
color: rgb(33, 31, 39);
font-size: 17px;
font-weight: 550;
padding: 4px 6px !important; /* Add padding for more space */

}

/* Additional hover styles (optional) */
.btn-rec:hover {
color: rgb(255, 255, 255);
background-color: rgb(54, 56, 56);
border-color: rgb(54, 56, 56);
}
/* Hide delete column by default; shown when table has .delete-visible */
.attendance-table:not(.delete-visible) th.delete-column,
.attendance-table:not(.delete-visible) td.delete-column {
        display: none !important;
}

/* Unassign teacher buttons: hidden by default; shown in delete mode */
.attendance-table:not(.delete-visible) .unassign-column {
    display: none !important;
}
.attendance-table.delete-visible .unassign-column {
    display: inline-flex !important;
}

    /* Reduce padding and size for delete buttons within the table */
    .table .delete-record {
        padding: 2px 6px; /* Smaller padding */
        font-size: 0.9rem; /* Smaller font size */
        height: 24px; /* Adjust height */
        width: 24px; /* Adjust width */
        line-height: 1; /* Ensure proper alignment */
        align-items: center;
    }

    .table .delete-record i {
        font-size: 0.7rem; /* Adjust icon size */
    }

    /* Center the header and items in the delete column */
    th.delete-column, td.delete-column {
        text-align: center; /* Center text horizontally */
        vertical-align: middle; /* Center text vertically */
    }

 
    .btn-primaryoff {
            background-color: rgb(57, 189, 180); /* Change success button color */
            border-color: rgb(57, 189, 180);
            color: rgb(33, 31, 39);
            font-weight: bold;
            margin-top: 10px!important;
            margin-left: 27px;
            margin-right:15px;
        }
    
.btn-primaryoff:hover {
            background-color: #007b8a;
            border-color: #007b8a;
            color: #fff;
        }
table {

    margin-top: 25px;
    margin-bottom: 20px;
  }
   .classroom-header, .assign-teacher-header, .assigned-teachers-header {
        background: #f8f9fa;
        text-align: left;
        vertical-align: middle;
        padding: 12px 8px;
    }
    .assign-teacher-row {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .assigned-teachers-header .teacher-row span {
        margin-right: 10px;
    }
    .assigned-teachers-header .teacher-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    th {
            background-color: rgba(34, 37, 41, 1) !important;
            color: #ffffff !important;
        }
select.classroom-select {
    width: auto;
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    border-color: rgba(204, 204, 204, 0.03); /* Adjust opacity here (0.5 for 50% opacity) */
    font-size: 14px;
    color: #333;
    background-size: 16px;
    cursor: pointer;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    appearance: none; /* Remove default dropdown arrow */
    background-image: url('path-to-your-icon.svg'); /* Custom arrow or icon */
    background-repeat: no-repeat;
    background-position: right 10px center;
    text-align: center;
}

/* Change opacity of the dropdown arrow */
select.classroom-select::after {
    content: '\f0d7'; /* Unicode for dropdown arrow (FontAwesome example) */
    font-family: 'FontAwesome'; /* FontAwesome or other icon font */
    opacity: 0.5; /* Adjust opacity here */
}

/* Hover and focus states for dropdown */
select.classroom-select:hover,
select.classroom-select:focus {
    border-color: #39bdb4;
    outline: none;
    box-shadow: 0 0 0 2px rgba(57, 189, 180, 0.2);
}

/* Style for the time inputs */
input[type="time"].sign-in-time,
input[type="time"].sign-out-time {
   
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background-color: #fff;
    font-size: 14px;
    color: #333;
    cursor: pointer;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    border-color: rgba(204, 204, 204, 0.03);
}
input[type="time"].sign-in-time::-webkit-calendar-picker-indicator,
input[type="time"].sign-out-time::-webkit-calendar-picker-indicator {
    cursor: pointer;
}


/* Hover and focus states for time inputs */
input[type="time"].sign-in-time:hover,
input[type="time"].sign-in-time:focus,
input[type="time"].sign-out-time:hover,
input[type="time"].sign-out-time:focus {
    border-color: #39bdb4;
    outline: none;
    box-shadow: 0 0 0 2px rgba(57, 189, 180, 0.2);
}

  .classroom-header-bg {
    background-color: var(--classroom-color, #f8f9fa) !important;
  }

@media (max-width: 999px) {
  .desktop-only { display: none !important; }
  .mobile-nav-spacer { height: 72px; }

  /* Fix bottom nav to viewport bottom */
  #mobileBottomNav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1200;
    background: #222529;
    border-top: 1px solid #1f2125;
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 72px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
  }
  .mobile-nav-spacer { height: 72px; }

  /* Make table fit viewport width, no horizontal scroll */
  table {
    width: 100vw !important;
    max-width: 100vw !important;
    min-width: 0 !important;
    table-layout: fixed !important;
    border-radius: 0 !important;
    margin: 8px 0 12px 0 !important;
    margin-left: calc(50% - 50vw) !important;
    margin-right: calc(50% - 50vw) !important;
    overflow-x: hidden !important;
  }
  table th, table td {
    border-left: none !important;
    border-right: none !important;
    border-top: none !important;
    border-bottom: 1px solid #dee2e6 !important;
    padding-left: 12px !important;
    padding-right: 12px !important;
    white-space: normal !important;
    word-break: break-word !important;
  }
  table thead th:first-child,
  table thead th:last-child,
  table tbody tr:last-child td:first-child,
  table tbody tr:last-child td:last-child {
    border-radius: 0 !important;
  }
  .attendance-table:not(.delete-visible) {
    table-layout: auto !important;
  }
  .attendance-table:not(.delete-visible) col.col-delete {
    display: none !important;
  }
  .attendance-table.delete-visible col.col-delete {
    display: table-column !important;
    width: 56px !important;
  }
  .attendance-table:not(.delete-visible) th.delete-column,
  .attendance-table:not(.delete-visible) td.delete-column {
    display: none !important;
  }
  #classroomSwitchContainer {
    position: sticky;
    top: 56px;
    z-index: 1090;
    padding: 6px 12px;
    background: #222529;
    border-bottom: 1px solid #1f2125;
    width: 100vw;
    margin-left: calc(50% - 50vw) !important;
    margin-right: calc(50% - 50vw) !important;
  }
  #classroomSwitchContainer .form-select {
    border: none !important;
    background: rgba(34,37,41,.95) !important;
    color: #fff !important;
    padding: 6px 10px;
    text-align: center;
    text-align-last: center;
    border-radius: 6px;
    font-weight: 700;
    font-size: 1.1rem;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: rgba(34,37,41,.95) !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M3.2 6l4.8 4.8L12.8 6z'/%3E%3C/svg%3E") !important;
    background-repeat: no-repeat !important;
    background-position: right 12px center !important;
    background-size: 14px !important;
    padding-right: 36px;
  }
  #classroomSwitchContainer .form-select::-ms-expand {
    display: none;
  }
  #classroomSwitchContainer .form-select option {
    font-weight: 700;
    font-size: 1.1rem;
  }
  table {
    margin-top: 0 !important;
  }
  table.attendance-table { display: none; }
  table.attendance-table.is-active { display: table; }
  .attendance-table .classroom-title-row { display: none !important; }
}
@media (max-width: 999px) {
  /* Mobile classroom switcher bar (flush to table) */
  #classroomSwitchContainer {
    border-bottom: none !important;     /* remove the line under the dropdown */
    margin-bottom: 0 !important;
    box-shadow: none !important;
  }

  /* Attach table directly under the switcher without any seam */
  table.attendance-table {
    margin-top: 0 !important;
    border-collapse: collapse !important;
    border-spacing: 0 !important;
  }
  /* Ensure the first header row doesn't draw a top border */
  table.attendance-table thead tr:first-child th {
    border-top: 0 !important;
  }
}
@media (max-width: 999px) {
  /* wrapper for positioning the inline arrow */
  #classroomSwitchContainer .select-wrap {
    position: relative;
    width: 100%;
  }

  /* remove bg arrow; keep centered text */
  #classroomSwitchContainer .select-wrap .form-select {
    background-image: none !important;   /* override previous bg SVG */
    text-align: center;
    text-align-last: center;
  }

  /* the visible chevron that sits right after the text */
  #classroomSwitchContainer .select-wrap .select-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: #fff;
    font-weight: 700;
    font-size: 1.1rem;
    pointer-events: none;                /* don’t block select clicks */
  }
}

/* Hide Assign teacher row when delete mode is on (desktop and mobile) */
.attendance-table.delete-visible .assign-controls-row {
  display: table-row !important;
}
.attendance-table:not(.delete-visible) .assign-controls-row {
  display: none !important;
}

/* Delete column: consistent width + perfectly centered button */
.attendance-table.delete-visible th.delete-column,
.attendance-table.delete-visible td.delete-column {
  display: table-cell !important;
}

.attendance-table th.delete-column,
.attendance-table td.delete-column {
    width: 48px !important;
    min-width: 48px !important;
    max-width: 48px !important;
    padding: 0 6px !important;          /* remove extra gap */
    text-align: center !important;
    vertical-align: middle !important;
    border-left: none !important;
    border-right: none !important;
}

/* Body cells transparent to blend with table rows */
.attendance-table td.delete-column { 
    background: transparent !important; 
}

/* Header cell matches dark header background */
.attendance-table th.delete-column { 
    background-color: rgba(34, 37, 41, 1) !important; 
}

/* The button itself */
.attendance-table .delete-record {
  display: inline-flex;                /* center inside cell */
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  padding: 0;
  margin: 0;
  border-radius: 6px;
  box-shadow: none;
}
</style>
{% endblock %}

{% block content %}
<h1 class="desktop-only">Daily Attendance</h1>

<!-- Mobile classroom switcher -->
<div id="classroomSwitchContainer" class="d-md-none" role="region" aria-label="Select classroom">
  <div class="select-wrap">
    <select id="classroomSwitch" class="form-select form-select-sm" aria-label="Classroom">
      {% for classroom, records in attendance_data.items %}
        <option value="{{ classroom.id }}">
          {{ classroom }} - Ratio: {{ relative_counts|get_item:classroom }} / {{ adjusted_ratios|get_item:classroom.id }}
        </option>
      {% endfor %}
    </select>
    <span class="select-arrow" aria-hidden="true">▾</span>
  </div>
</div>

<!-- Top controls (hidden on mobile) -->
<button type="button" class="btn btn-primaryoff desktop-only" data-bs-toggle="modal" data-bs-target="#manualSignInModal">
    Sign In
</button>
<button id="toggleDeleteColumn" onclick="toggleDeleteColumn()" class="btn btn-link btn-sm order-1 order-lg-0 desktop-only" style="text-decoration: none; font-weight: bold; font-size: 1.2em; margin-top:15px;">
    <i class="fas fa-exchange-alt" style="color: red;" ></i>
</button>
<a href="{% url 'attendance_record' %}" class="btn btn-rec desktop-only" style="margin-left: 15px;">
    Attendance Records
</a>

{% for classroom, records in attendance_data.items %}
<table class="attendance-table" id="classroomTable-{{ classroom.id }}" data-classroom-id="{{ classroom.id }}">
    <colgroup>
        <col class="col-student">
        <col class="col-signin">
        <col class="col-signout">
        <col class="col-classroom">
        <col class="col-delete">
    </colgroup>
    <thead>
        <!-- First Row: Classroom and Ratio -->
        <tr class="classroom-title-row">
            <th colspan="5"
                class="classroom-header classroom-header-bg"
                style="{% if classroom and classroom.color %}--classroom-color: {{ classroom.color }};{% endif %}">
                <h3>
                    <strong>{{ classroom }} - Ratio: </strong>
                    <span class="{% if relative_counts|get_item:classroom > adjusted_ratios|get_item:classroom.id %}over-ratio{% else %}under-ratio{% endif %}">
                        <strong>{{ relative_counts|get_item:classroom }} / {{ adjusted_ratios|get_item:classroom.id }}</strong>
                    </span>
                </h3>
            </th>
        </tr>
        <!-- Second Row: Assign Teacher -->
        <tr class="assign-controls-row">
            <th colspan="5" class="assign-teacher-header">
                <div class="assign-teacher-row">
                    <select id="availableTeachers-{{ classroom.id }}" class="form-select" style="width: 170px;">
                        <option value="" disabled selected>Assign teacher</option>
                        {% for teacher in available_teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.first_name }} {{ teacher.last_name }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-assign assign-teacher-btn" data-classroom-id="{{ classroom.id }}">Assign</button>
                </div>
            </th>
        </tr>
        <!-- Third Row: Assigned Teachers -->
        <tr>
            <th colspan="5" class="assigned-teachers-header">
                <div id="assignedTeachers-{{ classroom.id }}" class="teacher-row assigned-teachers">
                    {% for teacher in assigned_teachers|get_item:classroom.id %}
                        <span>{{ teacher.first_name }} {{ teacher.last_name }}</span>
                        <button type="button" class="btn btn-danger btn-sm unassign-teacher-btn unassign-column"
                                data-teacher-id="{{ teacher.id }}"
                                data-classroom-id="{{ classroom.id }}"
                                style="display: none;">
                            <i class="fas fa-exchange-alt" style="color: white;"></i>
                        </button>
                    {% empty %}
                        <span>No teachers assigned to this classroom.</span>
                    {% endfor %}
                </div>
            </th>
        </tr>
        <!-- Fourth Row: Attendance Records Header -->
        <tr>
            <th>Student</th>
            <th>Sign In</th>
            <th>Sign Out</th>
            <th>Classroom</th>
            <th class="delete-column" id="deleteColumnHeader">
                <i class="fas fa-user-minus" style="color: white;"></i>
            </th>
        </tr>
    </thead>

        <!-- Table Body -->
        <tbody>
            {% for record in records %}
                <tr id="record-{{ record.id }}">
                    <td>{{ record.student }}</td>
                    <td>
                        <input type="time" class="sign-in-time" data-id="{{ record.id }}" value="{{ record.sign_in_time|time:"H:i" }}">
                    </td>
                    <td>
                        <input type="time" class="sign-out-time" data-id="{{ record.id }}" value="{{ record.sign_out_time|time:"H:i" }}">
                    </td>
                    <td>
                        <select class="classroom-select" data-id="{{ record.id }}">
                            {% for option in classroom_options %}
                                <option value="{{ option }}" {% if record.classroom_override == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="delete-column">
                        <button type="button" class="btn btn-danger delete-record" data-id="{{ record.id }}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% empty %}
    <div style="margin: 20px 27px;">
        <p>No attendance records available for today.</p>
    </div>
{% endfor %}

<!-- Mobile bottom nav (uses base_minimal styles) -->
<div id="mobileBottomNav" class="d-md-none" role="navigation" aria-label="Attendance actions">
  <!-- LEFT: Records -->
  <a id="mobileRecordsBtn" class="btn" href="{% url 'attendance_record' %}" title="Records">
    <i class="fas fa-list-alt" aria-hidden="true"></i>
  </a>
  <!-- CENTER: Sign In (primary) -->
  <button id="mobileSignInBtn" class="btn update-btn" type="button" title="Sign In">
    <i class="fas fa-user-plus" aria-hidden="true"></i>
  </button>
  <!-- RIGHT: Toggle Delete -->
  <button id="mobileToggleDeleteBtn" class="btn" type="button" title="Toggle Delete">
    <i class="fas fa-exchange-alt" aria-hidden="true"></i>
  </button>
</div>
<div class="mobile-nav-spacer d-md-none"></div>

<!-- Manual Sign In Modal -->
            <div class="modal fade" id="manualSignInModal" tabindex="-1" aria-labelledby="manualSignInModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="manualSignInForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="manualSignInModalLabel">Manual Student Sign In</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3">
                        <label for="studentSelect" class="form-label">Select Student:</label>
                        <select class="form-select" id="studentSelect" name="student">
                          {% for student in students %}
                          <option value="{{ student.id }}">{{ student }}</option>
                          {% endfor %}
                        </select>
                        </div>
                        <div class="mb-3">
                        <label for="signInTime" class="form-label">Sign In Time:</label>
                        <!-- 
                            Option 1: Use a context variable "default_time" passed from your view (formatted as "HH:MM")
                            Option 2: Set a default value via JavaScript on modal open (see script below)
                        -->
                        <input type="time" class="form-control" id="signInTime" name="sign_in_time" value="{{ default_time }}">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Sign In</button>
                    </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script>
  $(document).ready(function() {
    $('#studentSelect').select2({
      dropdownParent: $('#manualSignInModal'),
      width: '100%',
      placeholder: 'Select student',
      allowClear: true
    });
    // Reset select2 on modal open
    $('#manualSignInModal').on('show.bs.modal', function () {
      $('#studentSelect').val(null).trigger('change');
    });
  });
</script>
<script>
    $(document).ready(function () {
        function updateAttendanceRecord(recordId, field, newValue) {
            $.ajax({
                url: '/update_attendance/',
                method: 'POST',
                data: {
                    'id': recordId,
                    'field': field,
                    'new_value': newValue,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    toastr.success('Attendance record updated successfully.');
                    if (field === 'classroom_override' || field === 'sign_in_time' || field === 'sign_out_time') {
                        location.reload(); // Refresh the page when any time field or classroom is changed
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Error updating record: ' + error);
                }
            });
        }

        // Handle clicks on sign-in time field
        $('.sign-in-time').on('click', function () {
            var recordId = $(this).data('id');
            var currentValue = $(this).val();
            $(this).on('change', function () {
                var newValue = $(this).val();
                if (newValue !== currentValue) {
                    updateAttendanceRecord(recordId, 'sign_in_time', newValue);
                }
            });
        });

        // Handle clicks on sign-out time field
        $('.sign-out-time').on('click', function () {
            var recordId = $(this).data('id');
            var currentValue = $(this).val();
            $(this).on('change', function () {
                var newValue = $(this).val();
                if (newValue !== currentValue) {
                    updateAttendanceRecord(recordId, 'sign_out_time', newValue);
                }
            });
        });

        // Handle changes to classroom override dropdown
        $('.classroom-select').on('change', function () {
            var recordId = $(this).data('id');
            var newValue = $(this).val();

            $.ajax({
                url: '/update_attendance/',
                method: 'POST',
                data: {
                    'id': recordId,
                    'field': 'classroom_override',
                    'new_value': newValue,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.status === 'success') {
                        toastr.success('Classroom override updated successfully.');
                        location.reload();
                    } else if (response.status === 'warning') {
                        toastr.warning(response.message);
                    } else {
                        toastr.error('Error: ' + (response.message || 'Unknown error.'));
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('An error occurred while updating the classroom override.');
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".sign-in-time, .sign-out-time").forEach(input => {
            input.addEventListener("click", function () {
                this.showPicker();
            });
        });
    });
</script>

<script>
  $('#manualSignInModal').on('show.bs.modal', function () {
    const now = new Date();
    const hh = now.getHours().toString().padStart(2,'0');
    const mm = now.getMinutes().toString().padStart(2,'0');
    $('#signInTime').val(`${hh}:${mm}`);
  });

  $(function () { // jQuery ready
    $('#manualSignInForm').on('submit', function (e) {
      e.preventDefault();

      $.ajax({
        url: '{% url "manual_sign_in_ajax" %}',
        method: 'POST',
        data: $(this).serialize(),
        dataType: 'json'
      })
      .done(function (response) {
        if (response.success) {
          toastr.success('Student signed in successfully.');
          $('#manualSignInModal').modal('hide');
          location.reload();
        } else {
          toastr.warning(response.error || 'Student already has an open sign-in today.');
        }
      })
      .fail(function (xhr) {
        const msg = (xhr.responseJSON && xhr.responseJSON.error)
          ? xhr.responseJSON.error
          : 'An error occurred while signing in the student.';
        if (xhr.status === 409) {
          toastr.warning(msg);  // duplicate sign-in
        } else {
          toastr.error(msg);
        }
      });
    });
  });
</script>

<script>
    $(document).ready(function () {
        $('.delete-record').on('click', function () {
            var recordId = $(this).data('id');
            if (confirm('Are you sure you want to delete this attendance record?')) {
                $.ajax({
                    url: '{% url "delete_attendance" %}',
                    method: 'POST',
                    data: {
                        'id': recordId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.success) {
                            toastr.success('Record deleted successfully.');
                            location.reload();
                        } else {
                            toastr.error('Error deleting record: ' + (response.error || 'Unknown error.'));
                        }
                    },
                    error: function (xhr, status, error) {
                        toastr.error('An error occurred while deleting the record.');
                    }
                });
            }
        });
    });
</script>

<script>
     // Toggle button handler (just toggles columns)
    $('.toggle-delete-column-btn').on('click', function () {
        toggleDeleteColumn();
    });

    // Row trash button handler (deletes teacher)
    $('.unassign-teacher-btn').on('click', function () {
        var classroomId = $(this).data('classroom-id');
        var teacherId = $(this).data('teacher-id');

        // Remove confirmation if not needed

        $.ajax({
            url: '{% url "unassign_teacher_from_classroom" %}',
            method: 'POST',
            data: {
                'classroom_id': classroomId,
                'teacher_id': teacherId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message);
                    location.reload();
                } else {
                    toastr.error('Error: ' + (response.error || 'Unknown error.'));
                }
            },
            error: function () {
                toastr.error('An error occurred while unassigning the teacher.');
            }
        });
    });


// Toggle function
function toggleDeleteColumn() {
    const $tables = $('table.attendance-table');
    $tables.toggleClass('delete-visible');                 // drives layout + CSS hide/show
    const show = $tables.first().hasClass('delete-visible');
}

// Ensure initial state is driven purely by CSS (.delete-visible)
    $(document).ready(function () {
        $('.assign-teacher-btn').on('click', function () {
            var classroomId = $(this).data('classroom-id');
            var teacherId = $('#availableTeachers-' + classroomId).val();

            if (!teacherId) {
                toastr.warning('Please select a teacher to assign.');
                return;
            }

            $.ajax({
                url: '{% url "assign_teacher_to_classroom" %}',
                method: 'POST',
                data: {
                    'classroom_id': classroomId,
                    'teacher_id': teacherId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        location.reload();
                    } else {
                        toastr.error('Error: ' + (response.error || 'Unknown error.'));
                    }
                },
                error: function () {
                    toastr.error('An error occurred while assigning the teacher.');
                }
            });
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // left: toggle delete/unassign columns
  document.getElementById('mobileToggleDeleteBtn')?.addEventListener('click', function () {
    document.getElementById('toggleDeleteColumn')?.click();
  });

  // center: open Sign In modal
  document.getElementById('mobileSignInBtn')?.addEventListener('click', function () {
    const el = document.getElementById('manualSignInModal');
    if (el) new bootstrap.Modal(el).show();
  });
});
</script>

<script>
// Mobile: show one classroom table at a time
document.addEventListener('DOMContentLoaded', function () {
  const dd = document.getElementById('classroomSwitch');
  if (!dd) return;

  function showClassroom(id) {
    document.querySelectorAll('table.attendance-table').forEach(t => t.classList.remove('is-active'));
    const tbl = document.getElementById('classroomTable-' + id);
    if (tbl) tbl.classList.add('is-active');
  }

  // initial selection (restore last chosen if still present)
  let id = localStorage.getItem('attendance.selectedClassroom');
  if (!id || !document.getElementById('classroomTable-' + id)) {
    id = dd.options[0]?.value || document.querySelector('table.attendance-table')?.dataset.classroomId;
  }
  if (id) {
    dd.value = id;
    showClassroom(id);
  }

  dd.addEventListener('change', function () {
    showClassroom(this.value);
    localStorage.setItem('attendance.selectedClassroom', this.value);
  });
});
</script>

<script>
/* Position the arrow just after the centered option text (mobile) */
document.addEventListener('DOMContentLoaded', function () {
  const wrap = document.querySelector('#classroomSwitchContainer .select-wrap');
  const select = document.getElementById('classroomSwitch');
  const arrow = wrap ? wrap.querySelector('.select-arrow') : null;
  if (!wrap || !select || !arrow) return;

  // hidden measurer for text width
  const measurer = document.createElement('span');
  measurer.style.position = 'absolute';
  measurer.style.visibility = 'hidden';
  measurer.style.whiteSpace = 'pre';
  wrap.appendChild(measurer);

  function placeArrow() {
    const styles = getComputedStyle(select);
    measurer.style.fontFamily = styles.fontFamily;
    measurer.style.fontSize = styles.fontSize;
    measurer.style.fontWeight = styles.fontWeight;
    measurer.style.letterSpacing = styles.letterSpacing;

    const text = select.options[select.selectedIndex]?.textContent || '';
    measurer.textContent = text;

    const textWidth = measurer.getBoundingClientRect().width;
    const containerWidth = select.clientWidth;
    const gap = 6; // space between text and arrow

    // Centered text: left edge = (W - Tw)/2; arrow after text = that + Tw + gap
    const left = (containerWidth + textWidth) / 2 + gap;
    arrow.style.left = left + 'px';
  }

  placeArrow();
  select.addEventListener('change', placeArrow);
  window.addEventListener('resize', placeArrow);
});
</script>
<script>
// Mobile: bottom nav actions (reuse modal instance; prevent double open)
document.addEventListener('DOMContentLoaded', function () {
  const toggleBtn = document.getElementById('mobileToggleDeleteBtn');
  const mobileBtn = document.getElementById('mobileSignInBtn');
  const el = document.getElementById('manualSignInModal');

  toggleBtn?.addEventListener('click', function () {
    document.getElementById('toggleDeleteColumn')?.click();
  });

  if (mobileBtn && el) {
    const modal = bootstrap.Modal.getOrCreateInstance(el); // no duplicate instances
    mobileBtn.addEventListener('click', function () {
      if (el.classList.contains('show')) return; // already open
      mobileBtn.disabled = true;
      modal.show();
    });
    el.addEventListener('shown.bs.modal', () => { mobileBtn.disabled = true; });
    el.addEventListener('hidden.bs.modal', () => { mobileBtn.disabled = false; });
  }
});
</script>

<script>
// Ensure the backdrop/body state is cleared after any modal hides
document.addEventListener('hidden.bs.modal', function () {
  document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
  document.body.classList.remove('modal-open');
  document.body.style.removeProperty('padding-right');
});
</script>
<script>
// Mobile: bind delete toggle directly (no proxy to desktop button)
document.addEventListener('DOMContentLoaded', function () {
  const mobileBtn = document.getElementById('mobileToggleDeleteBtn');
  mobileBtn?.addEventListener('click', function () {
    toggleDeleteColumn();  // directly toggle
  });
});
</script>
<script>
/* Toast-based confirm dialog with OK/Cancel buttons */
function confirmToast(message, title, onYes, onNo) {
  // Clear any prior confirm toasts to avoid stacking
  // (keeps other success/error toasts intact)
  // If you want to keep them, remove this line.
  // toastr.clear();

  const $toast = toastr.warning(
    `<div>${message}</div>
     <div class="mt-2">
       <button type="button" class="btn btn-primary btn-sm me-2" id="toastYesBtn">OK</button>
       <button type="button" class="btn btn-secondary btn-sm" id="toastNoBtn">Cancel</button>
     </div>`,
    title || 'Confirm',
    {
      timeOut: 0,
      extendedTimeOut: 0,
      tapToDismiss: false,
      closeButton: true,
      escapeHtml: false,          // allow HTML buttons
      newestOnTop: true,
      positionClass: 'toast-top-center',
      preventDuplicates: true
    }
  );

  // Wire buttons inside this toast
  if ($toast && $toast.length) {
    $toast.find('#toastYesBtn').on('click', function () {
      toastr.clear($toast);
      if (onYes) onYes();
    });
    $toast.find('#toastNoBtn').on('click', function () {
      toastr.clear($toast);
      if (onNo) onNo();
    });
    // Optional: focus OK for quick keyboard confirm
    setTimeout(() => $toast.find('#toastYesBtn').trigger('focus'), 0);
  }
}
</script>

<script>
// Replace native confirm with toast confirm for record deletes
$(document).ready(function () {
  $('.delete-record').on('click', function () {
    var recordId = $(this).data('id');
    confirmToast('Are you sure you want to delete this attendance record?', 'Confirm Delete', function () {
      $.ajax({
        url: '{% url "delete_attendance" %}',
        method: 'POST',
        data: {
          id: recordId,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.success) {
            toastr.success('Attendance record deleted.');
            location.reload();
          } else {
            toastr.error(response.error || 'Failed to delete record.');
          }
        },
        error: function () {
          toastr.error('An error occurred while deleting the record.');
        }
      });
    }, function () {
      // Cancel clicked — no action
      toastr.info('Delete canceled.');
    });
  });
});
</script>

<script>
// Ensure only the toast-based confirm runs
$(function () {
  // Remove any previous handlers (direct or delegated)
  $(document).off('click', '.delete-record');
  $('.delete-record').off('click');

  // Delegated handler so it works for dynamic rows too
  $(document).on('click', '.delete-record', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const recordId = $(this).data('id');

    confirmToast('Are you sure you want to delete this attendance record?', 'Confirm Delete',
      function onYes() {
        $.ajax({
          url: '{% url "delete_attendance" %}',
          method: 'POST',
          data: { id: recordId, csrfmiddlewaretoken: '{{ csrf_token }}' }
        })
        .done(function (response) {
          if (response.success) {
            toastr.success('Attendance record deleted.');
            location.reload();
          } else {
            toastr.error(response.error || 'Failed to delete record.');
          }
        })
        .fail(function () {
          toastr.error('An error occurred while deleting the record.');
        });
      },
      function onNo() {
        toastr.info('Delete canceled.');
      }
    );

    return false; // double-safety
  });
});
</script>
{% endblock %}
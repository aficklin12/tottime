{% extends 'tottimeapp/base.html' %}
{% load static %} 
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Send Invitation{% endblock %}

{% block styles %}
<style>
.btn-secondary {
    margin-left: 10px; 
    margin-bottom: 25px; /* Remove bottom margin */
}
.form-label {
    margin-top: 30px;
    margin-left: 15px;
}
input {
        margin-left: 15px;
        width: 180px!important; /* Adjust the width as needed */
    }
    select {
        margin-left: 15px;
        width: 180px!important; 
        margin-top: 15px;
        margin-bottom: 25px;    
    }
#studentList .form-check {
    margin-bottom: 8px;
    width: 100%;
    max-width: 350px;
}
#studentList .form-check-input {
    margin-top: 0.3em;
}
</style>
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1>Send Invite Link</h1>
    <form method="post">
        {% csrf_token %}
        <label for="email" class="form-label">Email:</label>
        <input type="email" id="email" name="email" class="form-control" required>
        <select id="role" name="role" class="form-control" required onchange="toggleStudentModalButton()">
            <option value="" disabled selected>Select a role</option>
            {% for role in roles %}
                <option value="{{ role.id }}" data-role-name="{{ role.name|lower }}">{{ role.name }}</option>
            {% endfor %}
        </select>

        <!-- Button to open modal, only for parent/teacher-parent -->
        <div id="student-modal-btn-container" style="display:none; margin-bottom:10px;">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editStudentsModal">
                <i class="fas fa-edit"></i> Link Students
            </button>
            <div id="selected-students-summary" style="margin-top:10px;"></div>
        </div>
        <!-- Hidden input to store selected student IDs -->
        <input type="hidden" name="student_ids" id="student_ids_hidden">

        <button type="submit" class="btn btn-primary">Send Invitation</button>
        <button type="button" class="btn btn-secondary" onclick="window.history.back();">Cancel</button>
    </form>

    {% if success_message %}
        <p style="color: green;">{{ success_message }}</p>
    {% endif %}
</div>

<!-- Edit Linked Students Modal (matching edit_parent.html) -->
<div class="modal fade" id="editStudentsModal" tabindex="-1" aria-labelledby="editStudentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <form onsubmit="event.preventDefault(); saveSelectedStudents();">
        <div class="modal-header">
          <h5 class="modal-title" id="editStudentsModalLabel">Link Students</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="studentSearch" class="form-control mb-2" placeholder="Search students..." onkeyup="filterStudents()">
          <div id="studentList">
            {% for student in students %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="students" id="student{{ student.id }}" value="{{ student.id }}">
              <label class="form-check-label" for="student{{ student.id }}">
                {{ student.first_name }} {{ student.last_name }}
              </label>
            </div>
            {% empty %}
            <p>No students available.</p>
            {% endfor %}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveSelectedStudents()" data-bs-dismiss="modal">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleStudentModalButton() {
    var roleSelect = document.getElementById('role');
    var selectedOption = roleSelect.options[roleSelect.selectedIndex];
    var roleName = selectedOption ? selectedOption.getAttribute('data-role-name') : '';
    var btnContainer = document.getElementById('student-modal-btn-container');
    if (roleName === 'parent' || roleName === 'teacher - parent') {
        btnContainer.style.display = '';
    } else {
        btnContainer.style.display = 'none';
        // Clear selected students if role is changed away
        document.getElementById('student_ids_hidden').value = '';
        document.getElementById('selected-students-summary').innerHTML = '';
        // Uncheck all checkboxes
        var checks = document.querySelectorAll('#studentList input[type=checkbox]');
        checks.forEach(c => c.checked = false);
    }
}

function filterStudents() {
    const searchInput = document.getElementById('studentSearch').value.toLowerCase();
    const studentList = document.getElementById('studentList');
    const students = studentList.getElementsByClassName('form-check');
    for (let student of students) {
        const label = student.getElementsByTagName('label')[0];
        const text = label.textContent.toLowerCase();
        student.style.display = text.includes(searchInput) ? '' : 'none';
    }
}

// Save selected students from modal to hidden input and summary
function saveSelectedStudents() {
    var checked = document.querySelectorAll('#studentList input[type=checkbox]:checked');
    var ids = Array.from(checked).map(cb => cb.value);
    document.getElementById('student_ids_hidden').value = ids.join(',');
    // Show summary
    var names = Array.from(checked).map(cb => cb.nextElementSibling.textContent.trim());
    document.getElementById('selected-students-summary').innerHTML = names.length
        ? '<strong>Linked Students:</strong> ' + names.join(', ')
        : '';
}
</script>
{% endblock %}
{% extends 'tottimeapp/base_dynamic.html' %}
{% load static %}
{% load custom_filters %}
{% load dict_extras %}
{% block title %}Recipes{% endblock %}

{% block styles %}
<style>
    .btn-recipe {
        margin-left: 27px;
        margin-bottom: 5px;
        margin-right: 5px;
        background-color: rgb(57, 189, 180);
        border-color: rgb(57, 189, 180);
        color: rgb(33, 31, 39);
        font-weight: bold;
    }

    .btn-recipe:hover {
        background-color: #007b8a;
        border-color: #007b8a;
        color: #fff;
    }

    .tabs {
        margin-left: 42px;
        margin-top: 20px;
        margin-bottom: -16px;
        display: flex;
        gap: 10px;
    }

    .tab {
        padding: 5px 15px;
        text-decoration: none;
        color: #000;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        cursor: pointer;
    }

    .active-tab {
        background-color: #272630;
        color: #ffffff;
        font-weight: bold;
        cursor: default;
        border-radius: 10px 10px 0 0;
    }

    .tab:hover:not(.active-tab) {
        background-color: #e9ecef;
        color: rgb(57, 189, 180);
    }

    .clickable-name {
        cursor: pointer; /* Change cursor to indicate clickability */
        text-decoration: none; /* Remove underline */
    }

    .clickable-name:hover {
        color: rgb(57, 189, 180);
        text-decoration: underline; /* Add underline on hover */
    }

    table {
        width: 75%;
    }

    .delete-column {
        display: none; /* Hide delete column by default */
        width: 50px; /* Set a smaller width for the delete column */
        text-align: center; /* Center-align the content */
    }
     /* Hide additional ingredient containers by default */
    #mainIngredient2Container,
    #mainIngredient3Container,
    #mainIngredient4Container,
    #mainIngredient5Container,
    #breakfastMainIngredient2Container,
    #breakfastMainIngredient3Container,
    #breakfastMainIngredient4Container,
    #breakfastMainIngredient5Container,
    #amIngredient2Container,
    #amIngredient3Container,
    #amIngredient4Container,
    #amIngredient5Container,
    #pmIngredient2Container,
    #pmIngredient3Container,
    #pmIngredient4Container,
    #pmIngredient5Container {
        display: none;
    }
    @media (max-width: 999px) {
    .tabs {
        display: none !important;
    }
    #recipeDropdownContainer {
        display: block !important;
        margin-bottom: 10px;
        text-align: center;
    }
    #recipeCategoryDropdown {
        width: 220px;
        margin: 10px auto;
        display: inline-block;
    }
}
@media (min-width: 1000px) {
    #recipeDropdownContainer {
        display: none !important;
    }
  #recipeTabs.tabs {
    width: 70% !important;
   
    margin-right: 0 !important;
    overflow-x: auto;              /* keep horizontal scroll within clipped width */
    flex-wrap: nowrap;             /* prevent wrapping so scroll appears */
    scrollbar-width: thin;
  }
  #recipeTabs .tab { flex-shrink: 0; } /* keep tab size consistent while scrolling */
}

    /* Ensure modals sit below a fixed navbar and above it in stacking context */
    .modal {
        padding-top: 64px;        /* push modal below navbar height */
        z-index: 1060;            /* above typical navbar z-index */
    }
    .modal-backdrop {
        z-index: 1050;
    }

    /* Optional: if your navbar has an unusually high z-index, lower it here */
    /* .navbar.fixed-top { z-index: 1030; } */
</style>
{% endblock %}

{% block content %}
<h1>Recipe Lists</h1>
<div class="container mt-4">
    <!-- Buttons for creating recipes -->
    <div class="mt-3 d-flex align-items-center">
        <!-- Recipe Buttons -->
        <div>
            <button type="button" class="btn btn-recipe" id="createBreakfastButton" data-bs-toggle="modal" data-bs-target="#createBreakfastRecipeModal" style="display: block;">
                Create Breakfast Recipe
            </button>
            <button type="button" class="btn btn-recipe" id="createAMButton" data-bs-toggle="modal" data-bs-target="#createAMRecipeModal" style="display: none;">
                Create AM Snack Recipe
            </button>
            <button type="button" class="btn btn-recipe" id="createLunchButton" data-bs-toggle="modal" data-bs-target="#createRecipeModal" style="display: none;">
                Create Lunch Recipe
            </button>
            <button type="button" class="btn btn-recipe" id="createPMButton" data-bs-toggle="modal" data-bs-target="#createPMRecipeModal" style="display: none;">
                Create PM Snack Recipe
            </button>
            <button type="button" class="btn btn-recipe" id="createFruitButton" data-bs-toggle="modal" data-bs-target="#fruitRecipeModal" style="display: none;">
                Add Fruit to Menu Rules
            </button>
            <button type="button" class="btn btn-recipe" id="createVegButton" data-bs-toggle="modal" data-bs-target="#vegRecipeModal" style="display: none;">
                Add Vegetables to Menu Rules
            </button>
            <button type="button" class="btn btn-recipe" id="createWGButton" data-bs-toggle="modal" data-bs-target="#wgRecipeModal" style="display: none;">
                Add Whole Grains to Menu Rules
            </button>
        </div>

        <!-- Trash Toggle Button -->
        <i id="toggleDeleteColumn" class="fas fa-trash-alt" style="color: red; cursor: pointer; margin-left: 15px;" title="Toggle Delete Column"></i>
    </div>

    <!-- Tabs for categories -->
    <div class="tabs" id="recipeTabs" role="tablist">
        <button class="tab active-tab" id="breakfast-tab" data-category="breakfast" role="tab">Breakfast</button>
        <button class="tab" id="am-snack-tab" data-category="am" role="tab">AM Snack</button>
        <button class="tab" id="lunch-tab" data-category="lunch" role="tab">Lunch</button>
        <button class="tab" id="pm-snack-tab" data-category="pm" role="tab">PM Snack</button>
        <button class="tab" id="fruit-tab" data-category="fruit" role="tab">Fruits</button>
        <button class="tab" id="veg-tab" data-category="veg" role="tab">Vegetables</button>
        <button class="tab" id="wg-tab" data-category="wg" role="tab">Whole Grains</button>
    </div>

    <!-- Mobile Dropdown for recipe categories -->
    <div class="d-block d-md-none mb-3" id="recipeDropdownContainer">
        <select class="form-select" id="recipeCategoryDropdown" aria-label="Select recipe category">
            <option value="breakfast">Breakfast</option>
            <option value="am">AM Snack</option>
            <option value="lunch">Lunch</option>
            <option value="pm">PM Snack</option>
            <option value="fruit">Fruits</option>
            <option value="veg">Vegetables</option>
            <option value="wg">Whole Grains</option>
        </select>
    </div>

    <!-- Table for displaying recipes -->
    <div class="tab-content mt-3">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th class="delete-column" id="deleteColumnHeader">
                        <i class="fas fa-trash-alt" style="color: white;"></i>
                    </th>
                </tr>
            </thead>
            <tbody id="recipeTableBody">
                <!-- Recipes will be dynamically populated here -->
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="fruitRecipeModal" tabindex="-1" aria-labelledby="fruitRecipeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="fruitRecipeModalLabel">Create Fruit Recipe</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="createFruitRecipeForm" method="post" action="{% url 'create_fruit_recipe' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="fruitName" class="form-label">Fruit Name</label>
                                    <input type="text" class="form-control" id="fruitName" name="fruitName">
                                </div>
                                <div class="mb-3">
                                    <label for="fruitMainIngredient1" class="form-label">Main Ingredient #1</label>
                                    <select class="form-select" id="fruitMainIngredient1" name="fruitMainIngredient1" aria-describedby="fruitIngredientsHelp1">
                                        <!-- Ingredients will be populated dynamically here -->
                                    </select>
                                    <input type="number" class="form-control mt-2" id="fruitQtyMainIngredient1" name="fruitQtyMainIngredient1" min="1" placeholder="Quantity">
                                </div>
                                <div class="mb-3">
                                    <label for="fruitRule" class="form-label">Rule</label>
                                    <select class="form-select" id="fruitRule" name="fruitRule">
                                        <!-- Rules will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="fruitImage" class="form-label">Image</label>
                                    <input type="file" class="form-control" id="fruitImage" name="image" accept="image/*">
                                    <div class="mt-2" id="fruitImageCurrent" style="display:none;">
                                        <a id="fruitImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                                        <span class="text-muted ms-2" id="fruitImageName"></span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Create Fruit Recipe</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="vegRecipeModal" tabindex="-1" aria-labelledby="vegRecipeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="vegRecipeModalLabel">Create Veg Recipe</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="createVegRecipeForm" method="post" action="{% url 'create_veg_recipe' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="vegName" class="form-label">Veg Name</label>
                                    <input type="text" class="form-control" id="vegName" name="vegName">
                                </div>
                                <div class="mb-3">
                                    <label for="vegMainIngredient1" class="form-label">Main Ingredient #1</label>
                                    <select class="form-select" id="vegMainIngredient1" name="vegMainIngredient1" aria-describedby="vegIngredientsHelp1">
                                        <!-- Ingredients will be populated dynamically here -->
                                    </select>
                                    <input type="number" class="form-control mt-2" id="vegQtyMainIngredient1" name="vegQtyMainIngredient1" min="1" placeholder="Quantity">
                                </div>
                                <div class="mb-3">
                                    <label for="vegRule" class="form-label">Rule</label>
                                    <select class="form-select" id="vegRule" name="vegRule">
                                        <!-- Rules will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="vegImage" class="form-label">Image</label>
                                    <input type="file" class="form-control" id="vegImage" name="image" accept="image/*">
                                    <div class="mt-2" id="vegImageCurrent" style="display:none;">
                                        <a id="vegImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                                        <span class="text-muted ms-2" id="vegImageName"></span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Create Veg Recipe</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="wgRecipeModal" tabindex="-1" aria-labelledby="wgRecipeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="wgRecipeModalLabel">Create Wg Recipe</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="createWgRecipeForm" method="post" action="{% url 'create_wg_recipe' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="wgName" class="form-label">Wg Name</label>
                                    <input type="text" class="form-control" id="wgName" name="wgName">
                                </div>
                                <div class="mb-3">
                                    <label for="wgMainIngredient1" class="form-label">Main Ingredient #1</label>
                                    <select class="form-select" id="wgMainIngredient1" name="wgMainIngredient1" aria-describedby="wgIngredientsHelp1">
                                        <!-- Ingredients will be populated dynamically here -->
                                    </select>
                                    <input type="number" class="form-control mt-2" id="wgQtyMainIngredient1" name="wgQtyMainIngredient1" min="1" placeholder="Quantity">
                                </div>
                                <div class="mb-3">
                                    <label for="wgRule" class="form-label">Rule</label>
                                    <select class="form-select" id="wgRule" name="wgRule">
                                        <!-- Rules will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="wgImage" class="form-label">Image</label>
                                    <input type="file" class="form-control" id="wgImage" name="image" accept="image/*">
                                    <div class="mt-2" id="wgImageCurrent" style="display:none;">
                                        <a id="wgImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                                        <span class="text-muted ms-2" id="wgImageName"></span>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Create Wg Recipe</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Modal for creating recipe -->
<div class="modal fade" id="createRecipeModal" tabindex="-1" aria-labelledby="createRecipeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRecipeModalLabel">Create Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createRecipeForm" method="post" action="{% url 'create_recipe' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="mealName" class="form-label">Meal Name</label>
                        <input type="text" class="form-control" id="mealName" name="mealName">
                    </div>

                    <!-- Input fields for main ingredients and their quantities -->
                    <div class="mb-3">
                        <label for="mainIngredient1" class="form-label">Main Ingredient #1</label>
                        <select class="form-select" id="mainIngredient1" name="mainIngredient1" aria-describedby="ingredientsHelp1">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="qtyMainIngredient1" name="qtyMainIngredient1" min="1" placeholder="Quantity">
                    </div>
                    <!-- Repeat this block for mainIngredient2, mainIngredient3, mainIngredient4, and mainIngredient5 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeIngredient2">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="mainIngredient2Container">
                        <!-- Main Ingredient #2 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for Main Ingredient #2 -->
                        <label for="mainIngredient2" class="form-label">Main Ingredient #2</label>
                        <select class="form-select" id="mainIngredient2" name="mainIngredient2" aria-describedby="ingredientsHelp2">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="qtyMainIngredient2" name="qtyMainIngredient2" min="1" placeholder="Quantity">
                    </div>
                
                    <!-- Minimize buttons for additional main ingredients -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeIngredient3">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="mainIngredient3Container">
                        <!-- Main Ingredient #3 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for Main Ingredient #3 -->
                        <label for="mainIngredient3" class="form-label">Main Ingredient #3</label>
                        <select class="form-select" id="mainIngredient3" name="mainIngredient3" aria-describedby="ingredientsHelp3">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="qtyMainIngredient3" name="qtyMainIngredient3" min="1" placeholder="Quantity">
                    </div>
                
                    <!-- Minimize buttons for additional main ingredients -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeIngredient4">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="mainIngredient4Container">
                        <!-- Main Ingredient #4 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for Main Ingredient #4 -->
                        <label for="mainIngredient4" class="form-label">Main Ingredient #4</label>
                        <select class="form-select" id="mainIngredient4" name="mainIngredient4" aria-describedby="ingredientsHelp4">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="qtyMainIngredient4" name="qtyMainIngredient4" min="1" placeholder="Quantity">
                    </div>
                
                    <!-- Minimize buttons for additional main ingredients -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeIngredient5">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="mainIngredient5Container">
                        <!-- Main Ingredient #5 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for Main Ingredient #5 -->
                        <label for="mainIngredient5" class="form-label">Main Ingredient #5</label>
                        <select class="form-select" id="mainIngredient5" name="mainIngredient5" aria-describedby="ingredientsHelp5">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="qtyMainIngredient5" name="qtyMainIngredient5" min="1" placeholder="Quantity">
                    </div>
                    <div class="mb-3">
                        <label for="grain" class="form-label">Grain</label>
                        <input type="text" class="form-control" id="grain" name="grain" placeholder="Grain">
                    </div>
                    
                    <!-- Input field for Meat/Meat Alternate -->
                    <div class="mb-3">
                        <label for="meatAlternate" class="form-label">Meat/Meat Alternate</label>
                        <input type="text" class="form-control" id="meatAlternate" name="meatAlternate" placeholder="Meat/Meat Alternate">
                    </div>
                    <!-- Dropdown for Rule -->
                    <div class="mb-3">
                        <label for="rule" class="form-label">Rule</label>
                        <select class="form-select" id="rule" name="rule">
                            <!-- Rules will be populated dynamically -->
                        </select>
                    </div>
                    <!-- Instructions text area -->
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="instructions" name="instructions" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="recipeImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="recipeImage" name="image" accept="image/*">
                        <div class="mt-2" id="recipeImageCurrent" style="display:none;">
                            <a id="recipeImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                            <span class="text-muted ms-2" id="recipeImageName"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Recipe</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="createBreakfastRecipeModal" tabindex="-1" aria-labelledby="createBreakfastRecipeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBreakfastRecipeModalLabel">Create Breakfast Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createBreakfastRecipeForm" method="post" action="{% url 'create_breakfast_recipe' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="breakfastMealName" class="form-label">Meal Name</label>
                        <input type="text" class="form-control" id="breakfastMealName" name="breakfastMealName">
                    </div>

                    <!-- Input fields for main ingredients and their quantities -->
                    <div class="mb-3">
                        <label for="breakfastMainIngredient1" class="form-label">Main Ingredient #1</label>
                        <select class="form-select" id="breakfastMainIngredient1" name="breakfastMainIngredient1" aria-describedby="breakfastIngredientsHelp1">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="breakfastQtyMainIngredient1" name="breakfastQtyMainIngredient1" min="1" placeholder="Quantity">
                    </div>
                    <!-- Repeat this block for breakfastMainIngredient2, breakfastMainIngredient3, breakfastMainIngredient4, and breakfastMainIngredient5 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeBreakfastIngredient2">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="breakfastMainIngredient2Container">
                        <!-- breakfastMainIngredient2 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for breakfastMainIngredient2 -->
                        <label for="breakfastMainIngredient2" class="form-label">Main Ingredient #2</label>
                        <select class="form-select" id="breakfastMainIngredient2" name="breakfastMainIngredient2" aria-describedby="breakfastIngredientsHelp2">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="breakfastQtyMainIngredient2" name="breakfastQtyMainIngredient2" min="1" placeholder="Quantity">
                    </div>
                
                    <!-- Minimize buttons for additional main ingredients -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeBreakfastIngredient3">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="breakfastMainIngredient3Container">
                        <!-- breakfastMainIngredient3 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for breakfastMainIngredient3 -->
                        <label for="breakfastMainIngredient3" class="form-label">Main Ingredient #3</label>
                        <select class="form-select" id="breakfastMainIngredient3" name="breakfastMainIngredient3" aria-describedby="breakfastIngredientsHelp3">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="breakfastQtyMainIngredient3" name="breakfastQtyMainIngredient3" min="1" placeholder="Quantity">
                    </div>
                
                    <!-- Minimize buttons for additional main ingredients -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeBreakfastIngredient4">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="breakfastMainIngredient4Container">
                        <!-- breakfastMainIngredient4 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for breakfastMainIngredient4 -->
                        <label for="breakfastMainIngredient4" class="form-label">Main Ingredient #4</label>
                        <select class="form-select" id="breakfastMainIngredient4" name="breakfastMainIngredient4" aria-describedby="breakfastIngredientsHelp4">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="breakfastQtyMainIngredient4" name="breakfastQtyMainIngredient4" min="1" placeholder="Quantity">
                    </div>
                
                    <!-- Minimize buttons for additional main ingredients -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="minimizeBreakfastIngredient5">Add Ingredient</button>
                    </div>
                
                    <div class="mb-3" id="breakfastMainIngredient5Container">
                        <!-- breakfastMainIngredient5 input fields -->
                        <!-- This block is hidden by default but will be shown if the user clicks on the minimize button -->
                        <!-- Input fields for breakfastMainIngredient5 -->
                        <label for="breakfastMainIngredient5" class="form-label">Main Ingredient #5</label>
                        <select class="form-select" id="breakfastMainIngredient5" name="breakfastMainIngredient5" aria-describedby="breakfastIngredientsHelp5">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="breakfastQtyMainIngredient5" name="breakfastQtyMainIngredient5" min="1" placeholder="Quantity">
                    </div>
                    <div class="mb-3">
                        <label for="additionalFood" class="form-label">Additional Food</label>
                        <input type="text" class="form-control" id="additionalFood" name="additionalFood">
                    </div>
                    
                    <!-- Rule dropdown -->
                    <div class="mb-3">
                        <label for="breakfastRule" class="form-label">Rule</label>
                        <select class="form-select" id="breakfastRule" name="breakfastRule">
                            <!-- Rules will be populated dynamically -->
                        </select>
                    </div>
                    <!-- Instructions text area -->
                    <div class="mb-3">
                        <label for="breakfastInstructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="breakfastInstructions" name="breakfastInstructions" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="breakfastImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="breakfastImage" name="image" accept="image/*">
                        <div class="mt-2" id="breakfastImageCurrent" style="display:none;">
                            <a id="breakfastImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                            <span class="text-muted ms-2" id="breakfastImageName"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Breakfast Recipe</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createAMRecipeModal" tabindex="-1" aria-labelledby="createAMRecipeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createAMRecipeModalLabel">Create AM Snack Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createAMRecipeForm" method="post" action="{% url 'create_am_recipe' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="amRecipeName" class="form-label">Recipe Name</label>
                        <input type="text" class="form-control" id="amRecipeName" name="amRecipeName">
                    </div>

                    <!-- Ingredient #1 -->
                    <div class="mb-3">
                        <label for="amIngredient1" class="form-label">Ingredient #1</label>
                        <select class="form-select" id="amIngredient1" name="amIngredient1">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="amQty1" name="amQty1" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #2 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="toggleAmIngredient2">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="amIngredient2Container" style="display: none;">
                        <label for="amIngredient2" class="form-label">Ingredient #2</label>
                        <select class="form-select" id="amIngredient2" name="amIngredient2">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="amQty2" name="amQty2" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #3 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="toggleAmIngredient3">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="amIngredient3Container" style="display: none;">
                        <label for="amIngredient3" class="form-label">Ingredient #3</label>
                        <select class="form-select" id="amIngredient3" name="amIngredient3">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="amQty3" name="amQty3" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #4 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="toggleAmIngredient4">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="amIngredient4Container" style="display: none;">
                        <label for="amIngredient4" class="form-label">Ingredient #4</label>
                        <select class="form-select" id="amIngredient4" name="amIngredient4">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="amQty4" name="amQty4" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #5 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="toggleAmIngredient5">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="amIngredient5Container" style="display: none;">
                        <label for="amIngredient5" class="form-label">Ingredient #5</label>
                        <select class="form-select" id="amIngredient5" name="amIngredient5">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="amQty5" name="amQty5" min="1" placeholder="Quantity">
                    </div>

                    <!-- Additional Fields -->
                    <div class="mb-3">
                        <label for="amFluid" class="form-label">Fluid</label>
                        <input type="text" class="form-control" id="amFluid" name="amFluid">
                    </div>
                    <div class="mb-3">
                        <label for="amFruitVeg" class="form-label">Fruit/Vegetable</label>
                        <input type="text" class="form-control" id="amFruitVeg" name="amFruitVeg">
                    </div>
                    <div class="mb-3">
                        <label for="amMeat" class="form-label">Meat</label>
                        <input type="text" class="form-control" id="amMeat" name="amMeat">
                    </div>
                    <div class="mb-3">
                        <label for="amRule" class="form-label">Rule</label>
                        <select class="form-select" id="amRule" name="amRule">
                            <!-- Rules will be populated dynamically here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="amInstructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="amInstructions" name="amInstructions" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="amImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="amImage" name="image" accept="image/*">
                        <div class="mt-2" id="amImageCurrent" style="display:none;">
                            <a id="amImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                            <span class="text-muted ms-2" id="amImageName"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create AM Snack Recipe</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="createPMRecipeModal" tabindex="-1" aria-labelledby="createPMRecipeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPMRecipeModalLabel">Create PM Snack Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPMRecipeForm" method="post" action="{% url 'create_pm_recipe' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="pmRecipeName" class="form-label">Recipe Name</label>
                        <input type="text" class="form-control" id="pmRecipeName" name="pmRecipeName">
                    </div>

                    <!-- Ingredient #1 -->
                    <div class="mb-3">
                        <label for="pmIngredient1" class="form-label">Ingredient #1</label>
                        <select class="form-select" id="pmIngredient1" name="pmIngredient1">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="pmQty1" name="pmQty1" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #2 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="togglePmIngredient2">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="pmIngredient2Container" style="display: none;">
                        <label for="pmIngredient2" class="form-label">Ingredient #2</label>
                        <select class="form-select" id="pmIngredient2" name="pmIngredient2">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="pmQty2" name="pmQty2" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #3 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="togglePmIngredient3">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="pmIngredient3Container" style="display: none;">
                        <label for="pmIngredient3" class="form-label">Ingredient #3</label>
                        <select class="form-select" id="pmIngredient3" name="pmIngredient3">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="pmQty3" name="pmQty3" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #4 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="togglePmIngredient4">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="pmIngredient4Container" style="display: none;">
                        <label for="pmIngredient4" class="form-label">Ingredient #4</label>
                        <select class="form-select" id="pmIngredient4" name="pmIngredient4">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="pmQty4" name="pmQty4" min="1" placeholder="Quantity">
                    </div>

                    <!-- Ingredient #5 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-secondary" id="togglePmIngredient5">Add Ingredient</button>
                    </div>
                    <div class="mb-3" id="pmIngredient5Container" style="display: none;">
                        <label for="pmIngredient5" class="form-label">Ingredient #5</label>
                        <select class="form-select" id="pmIngredient5" name="pmIngredient5">
                            <!-- Ingredients will be populated dynamically here -->
                        </select>
                        <input type="number" class="form-control mt-2" id="pmQty5" name="pmQty5" min="1" placeholder="Quantity">
                    </div>

                    <!-- Additional Fields -->
                    <div class="mb-3">
                        <label for="pmFluid" class="form-label">Fluid</label>
                        <input type="text" class="form-control" id="pmFluid" name="pmFluid">
                    </div>
                    <div class="mb-3">
                        <label for="pmFruitVeg" class="form-label">Fruit/Vegetable</label>
                        <input type="text" class="form-control" id="pmFruitVeg" name="pmFruitVeg">
                    </div>
                    <div class="mb-3">
                        <label for="pmMeat" class="form-label">Meat</label>
                        <input type="text" class="form-control" id="pmMeat" name="pmMeat">
                    </div>
                    <div class="mb-3">
                        <label for="pmRule" class="form-label">Rule</label>
                        <select class="form-select" id="pmRule" name="pmRule">
                            <!-- Rules will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="pmInstructions" class="form-label">Instructions</label>
                        <textarea class="form-control" id="pmInstructions" name="pmInstructions" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="pmImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="pmImage" name="image" accept="image/*">
                        <div class="mt-2" id="pmImageCurrent" style="display:none;">
                            <a id="pmImageLink" href="#" target="_blank" class="btn btn-sm btn-outline-primary">View current image</a>
                            <span class="text-muted ms-2" id="pmImageName"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create PM Snack Recipe</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const recipeTableBody = document.getElementById('recipeTableBody');
        const deleteColumnHeader = document.getElementById('deleteColumnHeader');
        const toggleDeleteButton = document.getElementById('toggleDeleteColumn');
        const tabs = document.querySelectorAll('#recipeTabs .tab');
        const buttons = {
            breakfast: document.getElementById('createBreakfastButton'),
            am: document.getElementById('createAMButton'),
            lunch: document.getElementById('createLunchButton'),
            pm: document.getElementById('createPMButton'),
            fruit: document.getElementById('createFruitButton'),
            veg: document.getElementById('createVegButton'),
            wg: document.getElementById('createWGButton')
        };
        const dropdown = document.getElementById('recipeCategoryDropdown');

        // Initially hide the delete column
        deleteColumnHeader.style.display = 'none';

        toggleDeleteButton.addEventListener('click', function () {
            const isHidden = deleteColumnHeader.style.display === 'none' || deleteColumnHeader.style.display === '';
            deleteColumnHeader.style.display = isHidden ? 'table-cell' : 'none';

            // Toggle visibility for all delete-column cells
            const deleteColumns = document.querySelectorAll('.delete-column');
            deleteColumns.forEach(column => {
                column.style.display = isHidden ? 'table-cell' : 'none';
            });
        });

        function fetchRecipes(category) {
            let endpoint = '';
            switch (category) {
                case 'breakfast': endpoint = '/fetch-breakfast-recipes/'; break;
                case 'am':        endpoint = '/fetch-am-recipes/';        break;
                case 'lunch':     endpoint = '/fetch-recipes/';           break;
                case 'pm':        endpoint = '/fetch-pm-recipes/';        break;
                case 'fruit':     endpoint = '/fetch-fruit-recipes/';     break;
                case 'veg':       endpoint = '/fetch-veg-recipes/';       break;
                case 'wg':        endpoint = '/fetch-wg-recipes/';        break;
                default: return;
            }

            fetch(endpoint)
              .then(r => r.json())
              .then(data => {
                  recipeTableBody.innerHTML = '';
                  const recipes = data.recipes || [];
                  recipes.forEach(recipe => {
                      const row = document.createElement('tr');
                      row.innerHTML = `
                          <td class="clickable-name" onclick="viewRecipe(${recipe.id}, '${category}')">${recipe.name}</td>
                          <td class="delete-column" style="display: none;">
                              <i class="fas fa-trash-alt delete-record" data-id="${recipe.id}" data-category="${category}" style="color: red; cursor: pointer;"></i>
                          </td>
                      `;
                      recipeTableBody.appendChild(row);
                  });

                  // Add event listeners for delete icons
                  const deleteIcons = document.querySelectorAll('.delete-record');
                  deleteIcons.forEach(icon => {
                      icon.addEventListener('click', function () {
                          const recipeId = this.getAttribute('data-id');
                          const category = this.getAttribute('data-category');
                          if (confirm('Are you sure you want to delete this recipe?')) {
                              deleteRecipe(recipeId, category);
                            }
                        });
                    });

                    // Synchronize delete column visibility
                    const isDeleteColumnVisible = deleteColumnHeader.style.display === 'table-cell';
                    const deleteColumns = document.querySelectorAll('.delete-column');
                    deleteColumns.forEach(column => {
                        column.style.display = isDeleteColumnVisible ? 'table-cell' : 'none';
                    });
                })
                .catch(err => console.error('Error fetching recipes:', err));
        }

        function deleteRecipe(recipeId, category) {
            fetch(`/delete-recipe/${category}/${recipeId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    toastr.success(`${category.charAt(0).toUpperCase() + category.slice(1)} recipe deleted successfully.`);
                    fetchRecipes(document.querySelector('.active-tab').getAttribute('data-category'));
                } else {
                    toastr.error('Failed to delete recipe.');
                }
            })
            .catch(error => {
                console.error('Error deleting recipe:', error);
                toastr.error('An error occurred while deleting the recipe.');
            });
        }

        // Function to toggle buttons based on the active tab
        function toggleButtons(category) {
            Object.keys(buttons).forEach(key => {
                buttons[key].style.display = key === category ? 'block' : 'none';
            });
        }

        // Function to update active tab styling
        function updateActiveTab(clickedTab) {
            tabs.forEach(tab => {
                tab.classList.remove('active-tab'); // Remove active class from all tabs
            });
            clickedTab.classList.add('active-tab'); // Add active class to the clicked tab
        }

        // Event listener for tab clicks
        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                const category = this.getAttribute('data-category');
                fetchRecipes(category);
                toggleButtons(category);
                updateActiveTab(this); // Update the active tab styling
                // Sync dropdown value
                if (dropdown) {
                    dropdown.value = category;
                }
            });
        });

        // Event listener for dropdown changes (MOBILE)
        if (dropdown) {
            // Set dropdown to match the active tab on load
            const activeTab = document.querySelector('#recipeTabs .active-tab');
            if (activeTab) {
                dropdown.value = activeTab.getAttribute('data-category');
            }
            dropdown.addEventListener('change', function () {
                const category = this.value;
                fetchRecipes(category);
                toggleButtons(category);
                // Update tab styling for consistency if user resizes window
                tabs.forEach(tab => {
                    tab.classList.remove('active-tab');
                    if (tab.getAttribute('data-category') === category) {
                        tab.classList.add('active-tab');
                    }
                });
            });
        }

        // Load the first tab (Breakfast) by default
        fetchRecipes('breakfast');
        toggleButtons('breakfast');
        updateActiveTab(document.querySelector('#breakfast-tab')); // Set the initial active tab
    });

    // Helpers to populate dropdowns with a selected value
    function populateIngredientsDropdown(selectId, selectedValue) {
        return $.get('/fetch-ingredients/').then(response => {
            const dropdown = $('#' + selectId);
            dropdown.empty();
            dropdown.append('<option value="">Select Ingredient</option>');
            (response.ingredients || []).forEach(i => {
                dropdown.append(`<option value="${i.id}">${i.item}</option>`);
            });
            if (selectedValue) dropdown.val(String(selectedValue));
        });
    }
    function populateRulesDropdown(selectId, selectedValue) {
        return $.get('/fetch-rules/').then(response => {
            const dropdown = $('#' + selectId);
            dropdown.empty();
            dropdown.append('<option value="">Select Rule</option>');
            (response.rules || []).forEach(r => {
                dropdown.append(`<option value="${r.id}">${r.rule}</option>`);
            });
            if (selectedValue) dropdown.val(String(selectedValue));
        });
    }

    // Main handler: open modal in edit mode and prefill fields
    async function viewRecipe(id, category) {
        try {
            const detailUrl = `/recipe/${category}/${id}/`; // implement these detail endpoints
            const res = await fetch(detailUrl);
            const data = await res.json();

            if (category === 'breakfast') {
                // Open modal
                $('#createBreakfastRecipeModal').modal('show');

                // Prefill inputs
                $('#breakfastMealName').val(data.name || '');
                await populateIngredientsDropdown('breakfastMainIngredient1', data.ingredient1_id);
                await populateIngredientsDropdown('breakfastMainIngredient2', data.ingredient2_id);
                await populateIngredientsDropdown('breakfastMainIngredient3', data.ingredient3_id);
                await populateIngredientsDropdown('breakfastMainIngredient4', data.ingredient4_id);
                await populateIngredientsDropdown('breakfastMainIngredient5', data.ingredient5_id);

                $('#breakfastQtyMainIngredient1').val(data.qty1 || '');
                $('#breakfastQtyMainIngredient2').val(data.qty2 || '');
                $('#breakfastQtyMainIngredient3').val(data.qty3 || '');
                $('#breakfastQtyMainIngredient4').val(data.qty4 || '');
                $('#breakfastQtyMainIngredient5').val(data.qty5 || '');

                $('#additionalFood').val(data.addfood || '');
                await populateRulesDropdown('breakfastRule', data.rule_id);
                $('#breakfastInstructions').val(data.instructions || '');

                // Switch form to update endpoint
                $('#createBreakfastRecipeForm').attr('action', `/update-breakfast-recipe/${id}/`);

                // Update image link
                updateImageLink('breakfast', data.image_url);
            }

            if (category === 'am') {
                $('#createAMRecipeModal').modal('show');
                $('#amRecipeName').val(data.name || '');
                await populateIngredientsDropdown('amIngredient1', data.ingredient1_id);
                await populateIngredientsDropdown('amIngredient2', data.ingredient2_id);
                await populateIngredientsDropdown('amIngredient3', data.ingredient3_id);
                await populateIngredientsDropdown('amIngredient4', data.ingredient4_id);
                await populateIngredientsDropdown('amIngredient5', data.ingredient5_id);

                $('#amQty1').val(data.qty1 || '');
                $('#amQty2').val(data.qty2 || '');
                $('#amQty3').val(data.qty3 || '');
                $('#amQty4').val(data.qty4 || '');
                $('#amQty5').val(data.qty5 || '');

                $('#amFluid').val(data.fluid || '');
                $('#amFruitVeg').val(data.fruit_veg || '');
                $('#amMeat').val(data.meat || '');
                await populateRulesDropdown('amRule', data.rule_id);
                $('#amInstructions').val(data.instructions || '');
                $('#createAMRecipeForm').attr('action', `/update-am-recipe/${id}/`);

                // Update image link
                updateImageLink('am', data.image_url);
            }

            if (category === 'pm') {
                $('#createPMRecipeModal').modal('show');
                $('#pmRecipeName').val(data.name || '');
                await populateIngredientsDropdown('pmIngredient1', data.ingredient1_id);
                await populateIngredientsDropdown('pmIngredient2', data.ingredient2_id);
                await populateIngredientsDropdown('pmIngredient3', data.ingredient3_id);
                await populateIngredientsDropdown('pmIngredient4', data.ingredient4_id);
                await populateIngredientsDropdown('pmIngredient5', data.ingredient5_id);

                $('#pmQty1').val(data.qty1 || '');
                $('#pmQty2').val(data.qty2 || '');
                $('#pmQty3').val(data.qty3 || '');
                $('#pmQty4').val(data.qty4 || '');
                $('#pmQty5').val(data.qty5 || '');

                $('#pmFluid').val(data.fluid || '');
                $('#pmFruitVeg').val(data.fruit_veg || '');
                $('#pmMeat').val(data.meat || '');
                await populateRulesDropdown('pmRule', data.rule_id);
                $('#pmInstructions').val(data.instructions || '');
                $('#createPMRecipeForm').attr('action', `/update-pm-recipe/${id}/`);

                // Update image link
                updateImageLink('pm', data.image_url);
            }

            if (category === 'lunch') {
                $('#createRecipeModal').modal('show');
                $('#mealName').val(data.name || '');
                await populateIngredientsDropdown('mainIngredient1', data.ingredient1_id);
                await populateIngredientsDropdown('mainIngredient2', data.ingredient2_id);
                await populateIngredientsDropdown('mainIngredient3', data.ingredient3_id);
                await populateIngredientsDropdown('mainIngredient4', data.ingredient4_id);
                await populateIngredientsDropdown('mainIngredient5', data.ingredient5_id);

                $('#qtyMainIngredient1').val(data.qty1 || '');
                $('#qtyMainIngredient2').val(data.qty2 || '');
                $('#qtyMainIngredient3').val(data.qty3 || '');
                $('#qtyMainIngredient4').val(data.qty4 || '');
                $('#qtyMainIngredient5').val(data.qty5 || '');

                $('#grain').val(data.grain || '');
                $('#meatAlternate').val(data.meat_alternate || '');
                await populateRulesDropdown('rule', data.rule_id);
                $('#instructions').val(data.instructions || '');
                $('#createRecipeForm').attr('action', `/update-recipe/${id}/`);

                // Update image link
                updateImageLink('recipe', data.image_url);
            }

            if (category === 'fruit') {
                $('#fruitRecipeModal').modal('show');
                $('#fruitName').val(data.name || '');
                await populateIngredientsDropdown('fruitMainIngredient1', data.ingredient1_id);
                $('#fruitQtyMainIngredient1').val(data.qty1 || '');
                await populateRulesDropdown('fruitRule', data.rule_id);
                $('#createFruitRecipeForm').attr('action', `/update-fruit-recipe/${id}/`);

                // Update image link
                updateImageLink('fruit', data.image_url);
            }

            if (category === 'veg') {
                $('#vegRecipeModal').modal('show');
                $('#vegName').val(data.name || '');
                await populateIngredientsDropdown('vegMainIngredient1', data.ingredient1_id);
                $('#vegQtyMainIngredient1').val(data.qty1 || '');
                await populateRulesDropdown('vegRule', data.rule_id);
                $('#createVegRecipeForm').attr('action', `/update-veg-recipe/${id}/`);

                // Update image link
                updateImageLink('veg', data.image_url);
            }

            if (category === 'wg') {
                $('#wgRecipeModal').modal('show');
                $('#wgName').val(data.name || '');
                await populateIngredientsDropdown('wgMainIngredient1', data.ingredient1_id);
                $('#wgQtyMainIngredient1').val(data.qty1 || '');
                await populateRulesDropdown('wgRule', data.rule_id);
                $('#createWgRecipeForm').attr('action', `/update-wg-recipe/${id}/`);

                // Update image link
                updateImageLink('wg', data.image_url);
            }
        } catch (e) {
            console.error('Failed to open recipe for edit:', e);
            toastr.error('Unable to load recipe.');
        }
    }
</script>
<script>
    $(document).ready(function () {
        // Create Recipe Modal
        $("#minimizeIngredient2").click(function () {
            $("#mainIngredient2Container").toggle();
            if ($("#mainIngredient2Container").is(":visible")) {
                $("#minimizeIngredient3").show();
            } else {
                $("#minimizeIngredient3").hide();
                $("#mainIngredient3Container").hide();
                $("#minimizeIngredient4").hide();
                $("#mainIngredient4Container").hide();
                $("#minimizeIngredient5").hide();
                $("#mainIngredient5Container").hide();
            }
        });

        $("#minimizeIngredient3").click(function () {
            $("#mainIngredient3Container").toggle();
            if ($("#mainIngredient3Container").is(":visible")) {
                $("#minimizeIngredient4").show();
            } else {
                $("#minimizeIngredient4").hide();
                $("#mainIngredient4Container").hide();
                $("#minimizeIngredient5").hide();
                $("#mainIngredient5Container").hide();
            }
        });

        $("#minimizeIngredient4").click(function () {
            $("#mainIngredient4Container").toggle();
            if ($("#mainIngredient4Container").is(":visible")) {
                $("#minimizeIngredient5").show();
            } else {
                $("#minimizeIngredient5").hide();
                $("#mainIngredient5Container").hide();
            }
        });

        $("#minimizeIngredient5").click(function () {
            $("#mainIngredient5Container").toggle();
        });

        // Breakfast Recipe Modal
        $("#minimizeBreakfastIngredient2").click(function () {
            $("#breakfastMainIngredient2Container").toggle();
            if ($("#breakfastMainIngredient2Container").is(":visible")) {
                $("#minimizeBreakfastIngredient3").show();
            } else {
                $("#minimizeBreakfastIngredient3").hide();
                $("#breakfastMainIngredient3Container").hide();
                $("#minimizeBreakfastIngredient4").hide();
                $("#breakfastMainIngredient4Container").hide();
                $("#minimizeBreakfastIngredient5").hide();
                $("#breakfastMainIngredient5Container").hide();
            }
        });

        $("#minimizeBreakfastIngredient3").click(function () {
            $("#breakfastMainIngredient3Container").toggle();
            if ($("#breakfastMainIngredient3Container").is(":visible")) {
                $("#minimizeBreakfastIngredient4").show();
            } else {
                $("#minimizeBreakfastIngredient4").hide();
                $("#breakfastMainIngredient4Container").hide();
                $("#minimizeBreakfastIngredient5").hide();
                $("#breakfastMainIngredient5Container").hide();
            }
        });

        $("#minimizeBreakfastIngredient4").click(function () {
            $("#breakfastMainIngredient4Container").toggle();
            if ($("#breakfastMainIngredient4Container").is(":visible")) {
                $("#minimizeBreakfastIngredient5").show();
            } else {
                $("#minimizeBreakfastIngredient5").hide();
                $("#breakfastMainIngredient5Container").hide();
            }
        });

        $("#minimizeBreakfastIngredient5").click(function () {
            $("#breakfastMainIngredient5Container").toggle();
        });

        // AM Snack Recipe Modal
        $("#toggleAmIngredient2").click(function () {
            $("#amIngredient2Container").toggle();
            if ($("#amIngredient2Container").is(":visible")) {
                $("#toggleAmIngredient3").show();
            } else {
                $("#toggleAmIngredient3").hide();
                $("#amIngredient3Container").hide();
                $("#toggleAmIngredient4").hide();
                $("#amIngredient4Container").hide();
                $("#toggleAmIngredient5").hide();
                $("#amIngredient5Container").hide();
            }
        });

        $("#toggleAmIngredient3").click(function () {
            $("#amIngredient3Container").toggle();
            if ($("#amIngredient3Container").is(":visible")) {
                $("#toggleAmIngredient4").show();
            } else {
                $("#toggleAmIngredient4").hide();
                $("#amIngredient4Container").hide();
                $("#toggleAmIngredient5").hide();
                $("#amIngredient5Container").hide();
            }
        });

        $("#toggleAmIngredient4").click(function () {
            $("#amIngredient4Container").toggle();
            if ($("#amIngredient4Container").is(":visible")) {
                $("#toggleAmIngredient5").show();
            } else {
                $("#toggleAmIngredient5").hide();
                $("#amIngredient5Container").hide();
            }
        });

        $("#toggleAmIngredient5").click(function () {
            $("#amIngredient5Container").toggle();
        });

        // PM Snack Recipe Modal
        $("#togglePmIngredient2").click(function () {
            $("#pmIngredient2Container").toggle();
            if ($("#pmIngredient2Container").is(":visible")) {
                $("#togglePmIngredient3").show();
            } else {
                $("#togglePmIngredient3").hide();
                $("#pmIngredient3Container").hide();
                $("#togglePmIngredient4").hide();
                $("#pmIngredient4Container").hide();
                $("#togglePmIngredient5").hide();
                $("#pmIngredient5Container").hide();
            }
        });

        $("#togglePmIngredient3").click(function () {
            $("#pmIngredient3Container").toggle();
            if ($("#pmIngredient3Container").is(":visible")) {
                $("#togglePmIngredient4").show();
            } else {
                $("#togglePmIngredient4").hide();
                $("#pmIngredient4Container").hide();
                $("#togglePmIngredient5").hide();
                $("#pmIngredient5Container").hide();
            }
        });

        $("#togglePmIngredient4").click(function () {
            $("#pmIngredient4Container").toggle();
            if ($("#pmIngredient4Container").is(":visible")) {
                $("#togglePmIngredient5").show();
            } else {
                $("#togglePmIngredient5").hide();
                $("#pmIngredient5Container").hide();
            }
        });

        $("#togglePmIngredient5").click(function () {
            $("#pmIngredient5Container").toggle();
        });

        // Initially hide all "Add Ingredient" buttons except the first one
        $("#minimizeIngredient3, #minimizeIngredient4, #minimizeIngredient5").hide();
        $("#minimizeBreakfastIngredient3, #minimizeBreakfastIngredient4, #minimizeBreakfastIngredient5").hide();
        $("#toggleAmIngredient3, #toggleAmIngredient4, #toggleAmIngredient5").hide();
        $("#togglePmIngredient3, #togglePmIngredient4, #togglePmIngredient5").hide();

        // Function to populate dropdowns with ingredients
        function populateIngredientsDropdown(selectId) {
            $.ajax({
                url: '/fetch-ingredients/', // Backend endpoint to fetch ingredients
                method: 'GET',
                success: function (response) {
                    const ingredients = response.ingredients;
                    const dropdown = $('#' + selectId);
                    dropdown.empty(); // Clear existing options
                    dropdown.append('<option value="">Select Ingredient</option>'); // Default option

                    // Populate dropdown with ingredients
                    ingredients.forEach(ingredient => {
                        dropdown.append(`<option value="${ingredient.id}">${ingredient.item}</option>`);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching ingredients:', error);
                }
            });
        }

        // Populate dropdowns when modals are shown
        $('#createRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('mainIngredient1');
            populateIngredientsDropdown('mainIngredient2');
            populateIngredientsDropdown('mainIngredient3');
            populateIngredientsDropdown('mainIngredient4');
            populateIngredientsDropdown('mainIngredient5');
        });

        $('#createBreakfastRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('breakfastMainIngredient1');
            populateIngredientsDropdown('breakfastMainIngredient2');
            populateIngredientsDropdown('breakfastMainIngredient3');
            populateIngredientsDropdown('breakfastMainIngredient4');
            populateIngredientsDropdown('breakfastMainIngredient5');
        });

        $('#createAMRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('amIngredient1');
            populateIngredientsDropdown('amIngredient2');
            populateIngredientsDropdown('amIngredient3');
            populateIngredientsDropdown('amIngredient4');
            populateIngredientsDropdown('amIngredient5');
        });

        $('#createPMRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('pmIngredient1');
            populateIngredientsDropdown('pmIngredient2');
            populateIngredientsDropdown('pmIngredient3');
            populateIngredientsDropdown('pmIngredient4');
            populateIngredientsDropdown('pmIngredient5');
        });

        $('#fruitRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('fruitMainIngredient1');
        });

        $('#vegRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('vegMainIngredient1');
        });

        $('#wgRecipeModal').on('show.bs.modal', function () {
            populateIngredientsDropdown('wgMainIngredient1');
        });
    });
</script>
<script>
    $(document).ready(function () {
        // Function to populate dropdowns with rules
        function populateRulesDropdown(selectId) {
            $.ajax({
                url: '/fetch-rules/', // Backend endpoint to fetch rules
                method: 'GET',
                success: function (response) {
                    const rules = response.rules;
                    const dropdown = $('#' + selectId);
                    dropdown.empty(); // Clear existing options
                    dropdown.append('<option value="">Select Rule</option>'); // Default option

                    // Populate dropdown with rules
                    rules.forEach(rule => {
                        dropdown.append(`<option value="${rule.id}">${rule.rule}</option>`);
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching rules:', error);
                }
            });
        }

        // Populate rule dropdowns when modals are shown
        $('#createRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('rule');
        });

        $('#createBreakfastRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('breakfastRule');
        });

        $('#createAMRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('amRule');
        });

        $('#createPMRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('pmRule');
        });

        $('#fruitRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('fruitRule');
        });

        $('#vegRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('vegRule');
        });

        $('#wgRecipeModal').on('show.bs.modal', function () {
            populateRulesDropdown('wgRule');
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createBreakfastRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#createBreakfastRecipeModal').modal('hide');
                        toastr.success('Breakfast recipe created successfully!');
                        location.reload();
                    } else {
                        toastr.error('Error creating breakfast recipe.');
                    }
                },
                error: function () {
                    toastr.error('An error occurred while creating the breakfast recipe.');
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createAMRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#createAMRecipeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error creating AM recipe.');
                    }
                },
                error: function () { alert('An error occurred while creating the AM recipe.'); }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#createRecipeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error creating recipe.');
                    }
                },
                error: function () { alert('An error occurred while creating the recipe.'); }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createPMRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#createPMRecipeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error creating PM recipe.');
                    }
                },
                error: function () { alert('An error occurred while creating the PM recipe.'); }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createFruitRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#fruitRecipeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error creating fruit recipe.');
                    }
                },
                error: function () { alert('An error occurred while creating the fruit recipe.'); }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createVegRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#vegRecipeModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error creating vegetable recipe.');
                    }
                },
                error: function () { alert('An error occurred while creating the vegetable recipe.'); }
            });
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#createWgRecipeForm').submit(function (e) {
            e.preventDefault();
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: formData,
                headers: { 'X-CSRFToken': csrfToken },
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        $('#wgRecipeModal').modal('hide');
                        toastr.success('WG recipe created successfully!');
                        location.reload();
                    } else {
                        toastr.error('Error creating WG recipe.');
                    }
                },
                error: function () { toastr.error('An error occurred while creating the WG recipe.'); }
            });
        });
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dropdown = document.getElementById('recipeCategoryDropdown');
    const tabs = document.querySelectorAll('#recipeTabs .tab');

    // Set dropdown to match the active tab on load
    const activeTab = document.querySelector('#recipeTabs .active-tab');
    if (activeTab && dropdown) {
        dropdown.value = activeTab.getAttribute('data-category');
    }

    if (dropdown) {
        dropdown.addEventListener('change', function () {
            const category = this.value;

            // Fetch and update recipes for the selected category
            if (typeof fetchRecipes === "function") {
                fetchRecipes(category);
            }

            // Toggle the correct button for the selected category
            if (typeof toggleButtons === "function") {
                toggleButtons(category);
            }

            // Update tab styling for consistency if user resizes window
            tabs.forEach(tab => {
                tab.classList.remove('active-tab');
                if (tab.getAttribute('data-category') === category) {
                    tab.classList.add('active-tab');
                }
            });
        });
    }
});
</script>
{% endblock %}